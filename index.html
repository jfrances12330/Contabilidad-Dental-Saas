<!DOCTYPE html>
<html class="light" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Dental SaaS - Gestión Clínica</title>
    <!-- PWA / Mobile Native Feel -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#C69C6D">
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/48/tooth.png">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&family=Noto+Sans:wght@100..900&display=swap"
        rel="stylesheet" />
    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <!-- Fonts: Manrope (Sans) & Playfair Display (Serif for Premium Feel) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap"
        rel="stylesheet">

    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <!-- Tailwind CSS (Configured via JS for Custom Colors) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Manrope', 'sans-serif'],
                        serif: ['"Playfair Display"', 'serif'],
                    },
                    colors: {
                        primary: '#C69C6D',
                        'primary-dark': '#A87F55',
                        'dark-bg': '#0B0C10',
                        'dark-surface': '#15171E',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Manrope', sans-serif;
        }

        h1,
        h2,
        h3,
        .brand-font {
            font-family: 'Playfair Display', serif;
        }

        /* Apply Serif to headers */

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .dark .glass-panel {
            background: rgba(21, 23, 30, 0.85);
            /* Matches dark-surface */
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* CustomScrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #334155;
        }

        .lobato-gradient-text {
            background: linear-gradient(135deg, #F3E7D7 0%, #C69C6D 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .material-symbols-outlined.filled {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        /* Utility to hide/show views */
        .view-content {
            display: none;
            min-height: 100dvh;
            flex-direction: column;
        }

        .view-content.active {
            display: flex;
        }

        /* Mobile specific padding for chat to avoid keyboard overlay issues */
        @media (max-width: 768px) {
            #view-chat {
                padding-bottom: 6rem;
                /* pb-24 equivalent */
            }
        }
    </style>
</head>

<body
    class="bg-gray-50 text-slate-900 transition-colors duration-300 dark:bg-dark-bg dark:text-slate-100 font-sans antialiased min-h-dvh">

    <!-- MAIN APP CONTAINER -->
    <div class="flex min-h-dvh bg-gray-50 dark:bg-dark-bg">

        <!-- SIDEBAR (Desktop) - PREMIUM DARK (Fixed Alignment) -->
        <aside
            class="hidden md:flex w-72 flex-col border-r border-slate-200 bg-white dark:border-white/5 dark:bg-dark-surface z-20 h-dvh sticky top-0">
            <!-- Brand -->
            <div class="flex h-20 items-center gap-3 px-6 border-b border-slate-100 dark:border-white/5">
                <div
                    class="flex h-10 w-10 items-center justify-center rounded-xl bg-primary text-white shadow-lg shadow-primary/30">
                    <span class="material-symbols-outlined text-2xl">dentistry</span>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-slate-900 dark:text-white font-serif">Lobato<span
                            class="text-primary">Dental</span></h1>
                    <p class="text-[10px] font-medium uppercase tracking-widest text-slate-400">Alta Precisión</p>
                </div>
            </div>

            <!-- Nav Links -->
            <nav class="flex-1 overflow-y-auto px-4 py-6 space-y-1">
                <!-- Dashboard -->
                <button onclick="switchTab('dashboard')" id="nav-dashboard"
                    class="nav-item group flex w-full items-center gap-3 rounded-xl px-4 py-3.5 text-sm font-medium transition-all duration-200 bg-primary/10 text-primary dark:bg-primary/20 dark:text-primary-dark ring-1 ring-primary/20">
                    <span class="material-symbols-outlined">dashboard</span>
                    Dashboard
                </button>

                <!-- Analytics (NEW) -->
                <button onclick="switchTab('analytics')" id="nav-analytics"
                    class="nav-item group flex w-full items-center gap-3 rounded-xl px-4 py-3.5 text-sm font-medium text-slate-500 hover:bg-slate-50 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-white/5 dark:hover:text-white transition-all">
                    <span class="material-symbols-outlined">monitoring</span>
                    Analítica
                </button>

                <!-- Finance -->
                <button onclick="switchTab('finance')" id="nav-finance"
                    class="nav-item group flex w-full items-center gap-3 rounded-xl px-4 py-3.5 text-sm font-medium text-slate-500 hover:bg-slate-50 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-white/5 dark:hover:text-white transition-all">
                    <span class="material-symbols-outlined">payments</span>
                    Finanzas
                </button>

                <!-- Team -->
                <button onclick="switchTab('team')" id="nav-team"
                    class="nav-item group flex w-full items-center gap-3 rounded-xl px-4 py-3.5 text-sm font-medium text-slate-500 hover:bg-slate-50 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-white/5 dark:hover:text-white transition-all">
                    <span class="material-symbols-outlined">groups</span>
                    Equipo
                </button>

                <!-- Chat AI -->
                <button onclick="switchTab('chat')" id="nav-chat"
                    class="nav-item group flex w-full items-center gap-3 rounded-xl px-4 py-3.5 text-sm font-medium text-slate-500 hover:bg-slate-50 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-white/5 dark:hover:text-white transition-all">
                    <div class="relative">
                        <span class="material-symbols-outlined">smart_toy</span>
                        <span class="absolute -right-1 -top-1 h-2 w-2 rounded-full bg-primary animate-pulse"></span>
                    </div>
                    Asistente IA
                </button>
            </nav>

            <!-- User Footer (Pinned to bottom) -->
            <div class="mt-auto flex flex-col gap-4 border-t border-slate-100 dark:border-slate-800 p-6">
                <button onclick="switchTab('view-settings')"
                    class="flex items-center gap-3 px-2 text-slate-600 dark:text-slate-400 hover:text-primary transition-colors text-left group">
                    <span class="material-symbols-outlined group-hover:rotate-90 transition-transform">settings</span>
                    <span class="text-sm font-medium">Configuración</span>
                </button>
                <div class="flex items-center gap-3 px-2">
                    <div class="h-9 w-9 rounded-full bg-slate-200 bg-cover bg-center shrink-0 ring-2 ring-white dark:ring-white/10"
                        style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuB-E9taHyLsWFW6WpLd22sYFn0f7uwSNaanMTwKISPUir_BPMS9PjeOi10EN_WC_W983TqpLXF2YoGRRvVXfm1aFk3dTqPzaVaa4vFWB42uxb5TllkGeGFUnYy0gmQQjL3PYOxTzhvfn8Kix34LQH_EXSX4gmDFF5ZnGizFdhv6SOmaLFU8rZyxrQkP1MsTlDYuU_dPyfMi1vETLpaBPC8imIKk9NuCjqyxC4FT76oSP5UhU2PhUsTk5NWv4-u_603sHOapzYY_N9U");'>
                    </div>
                    <div class="flex flex-col">
                        <p class="text-sm font-bold text-slate-900 dark:text-white">Dr. Lobato</p>
                        <p class="text-[11px] text-slate-500 font-medium">Administrador</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 relative bg-slate-50 dark:bg-dark-bg w-full">

            <!-- DASHBOARD VIEW -->
            <!-- DASHBOARD VIEW -->
            <div id="view-dashboard" class="view-content active w-full">
                <!-- Increased padding-bottom to pb-48 to clear floating menu -->
                <div class="container mx-auto max-w-7xl p-4 md:p-10 flex flex-col gap-6 md:gap-8 pb-48 md:pb-10">
                    <!-- Header -->
                    <!-- Header with Global Time Selector -->
                    <header class="flex flex-col md:flex-row items-center justify-between gap-4 mt-2 md:mt-0">
                        <div class="text-center md:text-left">
                            <h2
                                class="text-2xl md:text-3xl font-bold text-slate-900 dark:text-white tracking-tight font-serif">
                                Hola, Clínica Lobato</h2>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mt-0.5">Visión general del negocio.</p>
                        </div>

                        <!-- Segmented Control (The Brain) -->
                        <div class="flex bg-slate-100 dark:bg-white/5 rounded-xl p-1 gap-1 shadow-inner">
                            <button onclick="switchTimeFilter('hoy')" id="btn-hoy"
                                class="time-filter active px-4 py-2 rounded-lg text-xs md:text-sm font-bold transition-all duration-300 shadow-sm bg-white text-slate-900 dark:bg-dark-surface dark:text-white">HOY</button>
                            <button onclick="switchTimeFilter('ayer')" id="btn-ayer"
                                class="time-filter px-4 py-2 rounded-lg text-xs md:text-sm font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-all duration-300">AYER</button>
                            <button onclick="switchTimeFilter('semana')" id="btn-semana"
                                class="time-filter px-4 py-2 rounded-lg text-xs md:text-sm font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-all duration-300">SEMANA</button>
                            <button onclick="switchTimeFilter('mes')" id="btn-mes"
                                class="time-filter px-4 py-2 rounded-lg text-xs md:text-sm font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-all duration-300">MES</button>
                        </div>
                    </header>

                    <!-- COMPACT CARDS 2x2 on Mobile -->
                    <section class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-6">
                        <!-- Revenue -->
                        <div onclick="switchTab('finance')"
                            class="cursor-pointer group flex flex-col justify-between gap-3 rounded-2xl bg-white dark:bg-dark-surface p-4 md:p-6 shadow-sm border border-slate-100 dark:border-white/5 hover:scale-[1.02] transition-all hover:shadow-md">
                            <div class="flex items-start justify-between">
                                <div
                                    class="rounded-full bg-green-50 dark:bg-green-900/20 p-2 md:p-3 text-green-600 dark:text-green-400 group-hover:bg-primary/20 transition-colors">
                                    <span
                                        class="material-symbols-outlined filled text-[20px] md:text-[24px]">account_balance_wallet</span>
                                </div>
                                <span
                                    class="rounded-full bg-green-100 dark:bg-green-900/30 px-2 py-0.5 text-[10px] md:text-xs font-bold text-green-700 dark:text-green-400">+12%</span>
                            </div>
                            <div>
                                <p class="text-slate-500 dark:text-slate-400 text-xs md:text-sm font-medium mb-0.5">
                                    Ingresos
                                    Totales
                                </p>
                                <p class="text-xl md:text-3xl font-bold text-slate-900 dark:text-white tracking-tight font-serif"
                                    id="kpi-income">
                                    ---</p>
                            </div>
                        </div>

                        <!-- Expenses -->
                        <div onclick="switchTab('finance')"
                            class="cursor-pointer group flex flex-col justify-between gap-3 rounded-2xl bg-white dark:bg-dark-surface p-4 md:p-6 shadow-sm border border-slate-100 dark:border-white/5 hover:scale-[1.02] transition-all hover:shadow-md">
                            <div class="flex items-start justify-between">
                                <div
                                    class="rounded-full bg-red-50 dark:bg-red-900/20 p-2 md:p-3 text-red-600 dark:text-red-400 group-hover:bg-primary/20 transition-colors">
                                    <span
                                        class="material-symbols-outlined filled text-[20px] md:text-[24px]">credit_card</span>
                                </div>
                                <span
                                    class="rounded-full bg-green-100 dark:bg-green-900/30 px-2 py-0.5 text-[10px] md:text-xs font-bold text-green-700 dark:text-green-400">-5%</span>
                            </div>
                            <div>
                                <p class="text-slate-500 dark:text-slate-400 text-xs md:text-sm font-medium mb-0.5">
                                    Gastos
                                    Operativos
                                </p>
                                <p class="text-xl md:text-3xl font-bold text-slate-900 dark:text-white tracking-tight font-serif"
                                    id="kpi-expenses">---</p>
                            </div>
                        </div>

                        <!-- Net Profit (Spans 2 cols on mobile to emphasize importance) -->
                        <div onclick="switchTab('finance')"
                            class="cursor-pointer col-span-2 md:col-span-1 flex flex-col justify-between gap-3 rounded-2xl bg-white dark:bg-dark-surface p-4 md:p-6 shadow-sm border border-slate-100 dark:border-white/5 relative overflow-hidden group hover:scale-[1.02] transition-all hover:shadow-md">
                            <div
                                class="absolute right-0 top-0 h-24 w-24 translate-x-8 -translate-y-8 rounded-full bg-primary/10 transition-transform group-hover:scale-125">
                            </div>
                            <div class="flex items-start justify-between relative z-10">
                                <div class="rounded-full bg-primary/10 dark:bg-primary/20 p-2 md:p-3 text-primary">
                                    <span
                                        class="material-symbols-outlined filled text-[20px] md:text-[24px]">trending_up</span>
                                </div>
                                <span
                                    class="rounded-full bg-green-100 dark:bg-green-900/30 px-2 py-0.5 text-[10px] md:text-xs font-bold text-green-700 dark:text-green-400">+8%</span>
                            </div>
                            <div class="relative z-10">
                                <p class="text-slate-500 dark:text-slate-400 text-xs md:text-sm font-medium mb-0.5">
                                    Beneficio Neto
                                </p>
                                <p class="text-2xl md:text-3xl font-bold text-primary tracking-tight font-serif"
                                    id="kpi-profit">---
                                </p>
                            </div>
                        </div>
                    </section>

                    <!-- AI Alert (Updated to Gold Gradient) -->
                    <section class="w-full">
                        <div
                            class="relative overflow-hidden rounded-xl bg-gradient-to-r from-[#A87F55] to-[#C69C6D] shadow-lg shadow-primary/20 dark:shadow-none">
                            <div class="absolute -right-10 -top-10 h-64 w-64 rounded-full bg-white opacity-10 blur-3xl">
                            </div>
                            <div
                                class="absolute -left-10 -bottom-10 h-40 w-40 rounded-full bg-white opacity-10 blur-2xl">
                            </div>
                            <div
                                class="relative z-10 flex flex-col md:flex-row items-center md:items-center justify-between gap-4 p-5 md:p-6 text-center md:text-left">
                                <div class="flex flex-col md:flex-row items-center md:items-start gap-4">
                                    <div
                                        class="flex h-12 w-12 shrink-0 items-center justify-center rounded-full bg-white/20 backdrop-blur-sm shadow-inner text-white">
                                        <span class="material-symbols-outlined filled text-2xl">auto_awesome</span>
                                    </div>
                                    <div class="flex flex-col gap-1 text-center md:text-left">
                                        <h3 class="text-lg font-bold text-white font-serif">Alertas IA</h3>
                                        <p
                                            class="text-white/90 text-sm md:text-base font-medium max-w-2xl leading-relaxed">
                                            He detectado un sobrecoste inusual en la partida de <span
                                                class="font-bold text-white underline decoration-white/30 underline-offset-4">Laboratorio
                                                (+20%)</span>.
                                        </p>
                                    </div>
                                </div>
                                <button
                                    class="shrink-0 whitespace-nowrap rounded-lg bg-white/10 backdrop-blur-md border border-white/20 px-5 py-2 text-sm font-bold text-white shadow-sm hover:bg-white/20 transition-colors cursor-pointer w-full md:w-auto">
                                    Ver análisis
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- Charts -->
                    <section
                        class="flex flex-col gap-4 rounded-xl bg-white dark:bg-dark-surface p-6 shadow-sm border border-slate-100 dark:border-white/5 flex-1 min-h-[400px]">
                        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                            <div>
                                <h3 class="text-lg font-bold text-slate-900 dark:text-white font-serif">Balance
                                    Semestral
                                </h3>
                                <p class="text-sm text-slate-500 dark:text-slate-400">Ingresos vs Gastos (Últimos 6
                                    meses)
                                </p>
                            </div>
                            <div class="flex items-center gap-4 text-sm">
                                <div class="flex items-center gap-2">
                                    <span class="h-3 w-3 rounded-full bg-primary"></span>
                                    <span class="font-medium text-slate-600 dark:text-slate-300">Ingresos</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="h-3 w-3 rounded-full bg-slate-300 dark:bg-slate-600"></span>
                                    <span class="font-medium text-slate-600 dark:text-slate-300">Gastos</span>
                                </div>
                            </div>
                        </div>
                        <!-- Chart Grid Simulation -->
                        <div class="flex-1 w-full flex flex-col justify-end">
                            <div
                                class="relative grid grid-cols-6 gap-2 md:gap-8 h-[180px] md:h-[300px] items-end px-1 md:px-6 border-b border-slate-200 dark:border-slate-700 pb-2">
                                <!-- Background Lines -->
                                <div
                                    class="absolute inset-0 flex flex-col justify-between pointer-events-none pb-2 z-0">
                                    <div
                                        class="w-full border-t border-dashed border-slate-200 dark:border-slate-700 h-0">
                                    </div>
                                    <div
                                        class="w-full border-t border-dashed border-slate-200 dark:border-slate-700 h-0">
                                    </div>
                                    <div
                                        class="w-full border-t border-dashed border-slate-200 dark:border-slate-700 h-0">
                                    </div>
                                    <div
                                        class="w-full border-t border-dashed border-slate-200 dark:border-slate-700 h-0">
                                    </div>
                                    <div class="w-full h-0"></div>
                                </div>
                                <!-- Bars (Simplified) -->
                                <div class="group relative flex h-full flex-col justify-end gap-1 z-10">
                                    <div class="flex items-end justify-center gap-1 h-full">
                                        <div class="w-2 md:w-6 bg-primary rounded-t-sm" style="height: 65%;"></div>
                                        <div class="w-2 md:w-6 bg-slate-300 dark:bg-slate-700 rounded-t-sm"
                                            style="height: 45%;"></div>
                                    </div>
                                </div>
                                <div class="group relative flex h-full flex-col justify-end gap-1 z-10">
                                    <div class="flex items-end justify-center gap-1 h-full">
                                        <div class="w-2 md:w-6 bg-primary rounded-t-sm" style="height: 72%;"></div>
                                        <div class="w-2 md:w-6 bg-slate-300 dark:bg-slate-700 rounded-t-sm"
                                            style="height: 48%;"></div>
                                    </div>
                                </div>
                                <div class="group relative flex h-full flex-col justify-end gap-1 z-10">
                                    <div class="flex items-end justify-center gap-1 h-full">
                                        <div class="w-2 md:w-6 bg-primary rounded-t-sm" style="height: 55%;"></div>
                                        <div class="w-2 md:w-6 bg-slate-300 dark:bg-slate-700 rounded-t-sm"
                                            style="height: 40%;"></div>
                                    </div>
                                </div>
                                <div class="group relative flex h-full flex-col justify-end gap-1 z-10">
                                    <div class="flex items-end justify-center gap-1 h-full">
                                        <div class="w-2 md:w-6 bg-primary rounded-t-sm" style="height: 45%;"></div>
                                        <div class="w-2 md:w-6 bg-slate-300 dark:bg-slate-700 rounded-t-sm"
                                            style="height: 35%;"></div>
                                    </div>
                                </div>
                                <div class="group relative flex h-full flex-col justify-end gap-1 z-10">
                                    <div class="flex items-end justify-center gap-1 h-full">
                                        <div class="w-2 md:w-6 bg-primary rounded-t-sm" style="height: 85%;"></div>
                                        <div class="w-2 md:w-6 bg-slate-300 dark:bg-slate-700 rounded-t-sm"
                                            style="height: 50%;"></div>
                                    </div>
                                </div>
                                <div class="group relative flex h-full flex-col justify-end gap-1 z-10">
                                    <div class="flex items-end justify-center gap-1 h-full">
                                        <div class="w-2 md:w-6 bg-primary rounded-t-sm" style="height: 92%;"></div>
                                        <div class="w-2 md:w-6 bg-slate-300 dark:bg-slate-700 rounded-t-sm"
                                            style="height: 38%;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-6 gap-2 md:gap-8 px-1 md:px-6 pt-3">
                                <div class="text-center text-[10px] md:text-xs font-semibold text-slate-500">May</div>
                                <div class="text-center text-[10px] md:text-xs font-semibold text-slate-500">Jun</div>
                                <div class="text-center text-[10px] md:text-xs font-semibold text-slate-500">Jul</div>
                                <div class="text-center text-[10px] md:text-xs font-semibold text-slate-500">Ago</div>
                                <div class="text-center text-[10px] md:text-xs font-semibold text-slate-500">Sep</div>
                                <div class="text-center text-[10px] md:text-xs font-bold text-primary">Oct</div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <!-- TEAM VIEW -->
            <div id="view-team" class="view-content w-full">
                <!-- Header Team -->
                <header
                    class="sticky top-0 z-10 flex flex-col md:flex-row md:items-center justify-between border-b border-slate-200 bg-white/90 px-6 py-5 backdrop-blur-md dark:border-white/5 dark:bg-dark-surface/90 gap-4">
                    <div class="flex flex-col gap-1">
                        <h2 class="text-2xl font-black tracking-tight text-slate-900 dark:text-white font-serif">Equipo
                            Médico</h2>
                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Rendimiento por periodos</p>
                    </div>

                    <!-- Team Period Selector -->
                    <div class="flex bg-slate-100 dark:bg-white/5 rounded-xl p-1 gap-1 shadow-inner order-3 md:order-2">
                        <button onclick="switchTeamTimeFilter('hoy')" id="btn-team-hoy"
                            class="team-time-filter px-3 py-1.5 rounded-lg text-[10px] md:text-xs font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 transition-all duration-300">HOY</button>
                        <button onclick="switchTeamTimeFilter('ayer')" id="btn-team-ayer"
                            class="team-time-filter px-3 py-1.5 rounded-lg text-[10px] md:text-xs font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 transition-all duration-300">AYER</button>
                        <button onclick="switchTeamTimeFilter('semana')" id="btn-team-semana"
                            class="team-time-filter px-3 py-1.5 rounded-lg text-[10px] md:text-xs font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 transition-all duration-300">SEMANA</button>
                        <button onclick="switchTeamTimeFilter('mes')" id="btn-team-mes"
                            class="team-time-filter active px-3 py-1.5 rounded-lg text-[10px] md:text-xs font-bold transition-all duration-300 shadow-sm bg-white text-slate-900 dark:bg-dark-surface dark:text-white">MES</button>
                    </div>

                    <button onclick="openDoctorModal()"
                        class="flex items-center gap-2 rounded-lg bg-primary px-3 py-2 text-sm font-bold text-white shadow-md shadow-primary/20 hover:bg-primary-dark transition-all active:scale-95 order-2 md:order-3 self-end md:self-auto">
                        <span class="material-symbols-outlined text-[20px]">add</span>
                        <span class="hidden md:inline">Añadir</span>
                    </button>
                </header>

                <div class="flex flex-col gap-6 p-6 md:p-8 w-full pb-24 md:pb-10">
                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                        <!-- Left: Cards -->
                        <div id="doctors-container" class="xl:col-span-2 flex flex-col gap-4">
                            <!-- JS RENDERED DOCTORS HERE -->
                        </div>

                        <!-- ADD DOCTOR MODAL -->
                        <div id="doctor-modal" class="fixed inset-0 z-50 hidden">
                            <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity"
                                onclick="closeDoctorModal()"></div>
                            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white dark:bg-dark-surface rounded-2xl shadow-xl p-6 border border-slate-100 dark:border-white/10 md:scale-100 scale-95 opacity-0 transition-all duration-200"
                                id="doctor-modal-content">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-xl font-bold text-slate-900 dark:text-white font-serif">Nuevo Doctor
                                    </h3>
                                    <button onclick="closeDoctorModal()"
                                        class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                                        <span class="material-symbols-outlined">close</span>
                                    </button>
                                </div>
                                <form onsubmit="handleAddDoctor(event)" class="flex flex-col gap-4">
                                    <div>
                                        <label
                                            class="block text-xs font-bold text-slate-500 uppercase mb-1">Nombre</label>
                                        <input name="name" required type="text" placeholder="Ej: Dr. Smith"
                                            class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white dark:placeholder-slate-600">
                                    </div>
                                    <div>
                                        <label
                                            class="block text-xs font-bold text-slate-500 uppercase mb-1">Especialidad</label>
                                        <select name="role"
                                            class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                                            <option value="General">Odontología General</option>
                                            <option value="Ortodoncia">Ortodoncia</option>
                                            <option value="Implantes">Implantes</option>
                                            <option value="Estética">Estética</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Objetivo
                                            Mensual (€)</label>
                                        <input name="goal" required type="number" placeholder="10000"
                                            class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white dark:placeholder-slate-600">
                                    </div>
                                    <button type="submit"
                                        class="mt-2 w-full bg-primary text-white font-bold py-3 rounded-xl shadow-lg shadow-primary/20 hover:bg-primary-dark transition-colors">Guardar
                                        Doctor</button>
                                </form>
                            </div>
                        </div>

                        <!-- Right: Logic Donut -->
                        <div class="flex flex-col gap-6">
                            <div
                                class="rounded-2xl bg-white p-6 shadow-sm ring-1 ring-slate-100 dark:bg-dark-surface dark:ring-white/5">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-bold text-slate-900 dark:text-white font-serif">
                                        Distribución
                                    </h3>
                                    <span
                                        class="text-[10px] font-bold text-primary uppercase tracking-wider bg-primary/10 px-2 py-0.5 rounded-md"
                                        id="team-donut-period-label">MES</span>
                                </div>
                                <div class="relative flex items-center justify-center py-4">
                                    <div class="relative h-48 w-48 rounded-full transition-all duration-500"
                                        id="team-donut-chart" style="background: conic-gradient(#C69C6D 0% 100%);">
                                        <div
                                            class="absolute inset-4 rounded-full bg-white dark:bg-dark-surface flex flex-col items-center justify-center z-10 shadow-inner">
                                            <p
                                                class="text-[10px] font-medium text-slate-500 dark:text-slate-400 uppercase tracking-tighter">
                                                Total Periodo</p>
                                            <p class="text-2xl font-black text-slate-900 dark:text-white font-serif"
                                                id="team-donut-total">
                                                0€
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4 flex flex-col gap-2" id="team-donut-legend">
                                    <!-- Dynamic Legend -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FINANCE VIEW -->
            <div id="view-finance" class="view-content w-full">
                <!-- Increased padding-bottom -->
                <div class="p-4 md:p-8 flex flex-col gap-6 pb-48 md:pb-10 max-w-6xl mx-auto w-full">
                    <header class="flex flex-col gap-4 w-full">
                        <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 w-full">
                            <div class="w-full">
                                <h2
                                    class="text-2xl md:text-3xl font-bold text-slate-900 dark:text-white tracking-tight font-serif">
                                    Finanzas</h2>
                                <div class="flex items-center gap-2 mt-2">
                                    <div class="relative flex-1 md:flex-initial">
                                        <input id="search-input" onkeyup="renderTable()" type="text"
                                            placeholder="Buscar concepto o doctor..."
                                            class="w-full md:w-80 rounded-lg border-slate-200 bg-white px-3 py-2 pl-9 text-sm dark:bg-dark-surface dark:border-white/10 dark:text-white dark:placeholder-slate-500 focus:ring-2 focus:ring-primary/20 transition-all">
                                        <span
                                            class="material-symbols-outlined absolute left-3 top-2 text-slate-400 text-[18px]">search</span>
                                    </div>
                                    <button onclick="toggleFinanceFilters()" id="btn-toggle-filters"
                                        class="flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 rounded-lg text-slate-600 text-sm font-medium hover:bg-slate-50 transition-colors dark:bg-dark-surface dark:border-white/10 dark:text-slate-400">
                                        <span class="material-symbols-outlined text-[18px]">tune</span>
                                        <span class="hidden md:inline">Filtros</span>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="openExportModal()"
                                    class="hidden md:flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-lg text-slate-700 text-sm font-medium hover:bg-slate-50 transition-colors dark:bg-dark-surface dark:border-white/10 dark:text-slate-300 dark:hover:bg-white/5">
                                    <span class="material-symbols-outlined text-[18px]">download</span>
                                    Exportar
                                </button>
                            </div>
                        </div>

                        <!-- Sub-view Toggles (Income, Expenses, All) -->
                        <div class="flex flex-wrap items-center justify-between gap-4">
                            <div class="flex bg-slate-100 dark:bg-white/5 rounded-xl p-1 gap-1 shadow-inner h-fit">
                                <button onclick="switchFinanceType('all')" id="btn-fin-all"
                                    class="fin-type-filter active px-4 py-1.5 rounded-lg text-xs font-bold transition-all duration-300 shadow-sm bg-white text-slate-900 dark:bg-dark-surface dark:text-white">TODOS</button>
                                <button onclick="switchFinanceType('ingreso')" id="btn-fin-ingreso"
                                    class="fin-type-filter px-4 py-1.5 rounded-lg text-xs font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-all duration-300">INGRESOS</button>
                                <button onclick="switchFinanceType('gasto')" id="btn-fin-gasto"
                                    class="fin-type-filter px-4 py-1.5 rounded-lg text-xs font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-all duration-300">GASTOS</button>
                            </div>
                        </div>

                        <!-- Collapsible Filter Panel -->
                        <div id="finance-filters-panel" class="hidden overflow-hidden transition-all duration-300">
                            <div
                                class="bg-slate-50 dark:bg-white/5 rounded-xl p-4 border border-slate-200 dark:border-white/10 flex flex-col md:flex-row gap-4">
                                <div class="flex-1">
                                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Fecha
                                        Inicio</label>
                                    <input type="date" id="filter-date-start" onchange="renderTable()"
                                        class="w-full rounded-lg border-slate-200 bg-white px-3 py-2 text-sm dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                                </div>
                                <div class="flex-1">
                                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Fecha
                                        Fin</label>
                                    <input type="date" id="filter-date-end" onchange="renderTable()"
                                        class="w-full rounded-lg border-slate-200 bg-white px-3 py-2 text-sm dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                                </div>
                                <div class="flex items-end">
                                    <button onclick="clearFinanceFilters()"
                                        class="text-xs text-primary hover:underline font-bold py-2">Limpiar
                                        filtros</button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <!-- Compact Finance Summary Mobile Gap -->
                    <div class="grid grid-cols-3 gap-2 md:gap-4 overflow-hidden w-full">
                        <div
                            class="bg-white dark:bg-dark-surface rounded-xl p-3 md:p-5 border border-slate-100 dark:border-white/5 shadow-sm text-center md:text-left min-w-0">
                            <p
                                class="text-[10px] md:text-sm text-slate-500 dark:text-slate-400 font-medium uppercase truncate">
                                Entradas</p>
                            <p
                                class="text-sm md:text-2xl font-bold text-slate-900 dark:text-white mt-0.5 md:mt-1 font-serif truncate">
                                €25,000</p>
                        </div>
                        <div
                            class="bg-white dark:bg-dark-surface rounded-xl p-3 md:p-5 border border-slate-100 dark:border-white/5 shadow-sm text-center md:text-left min-w-0">
                            <p
                                class="text-[10px] md:text-sm text-slate-500 dark:text-slate-400 font-medium uppercase truncate">
                                Salidas</p>
                            <p
                                class="text-sm md:text-2xl font-bold text-slate-900 dark:text-white mt-0.5 md:mt-1 font-serif truncate">
                                €12,500</p>
                        </div>
                        <div
                            class="bg-white dark:bg-dark-surface rounded-xl p-3 md:p-5 border border-slate-100 dark:border-white/5 shadow-sm text-center md:text-left min-w-0">
                            <p
                                class="text-[10px] md:text-sm text-slate-500 dark:text-slate-400 font-medium uppercase truncate">
                                Neto</p>
                            <p class="text-sm md:text-2xl font-bold text-primary mt-0.5 md:mt-1 font-serif truncate">
                                €12,500</p>
                        </div>
                    </div>

                    <div
                        class="hidden md:block bg-white dark:bg-dark-surface rounded-xl border border-slate-100 dark:border-white/5 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 dark:bg-white/5">
                                    <tr>
                                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Fecha</th>
                                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Concepto</th>
                                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase text-right">
                                            Importe
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="finance-table-body" class="divide-y divide-slate-100 dark:divide-white/5">
                                    <!-- JS WILL RENDER ROWS HERE -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Mobile List (Dynamic) -->
                    <div id="finance-mobile-list" class="md:hidden flex flex-col gap-4">
                        <!-- JS WILL RENDER CARDS HERE -->
                    </div>
                </div>
                <!-- FAB Mobile only -->
                <!-- FAB Mobile -->
                <button onclick="openModal()"
                    class="fixed bottom-28 right-6 md:hidden size-14 bg-primary text-white rounded-full shadow-lg flex items-center justify-center z-30">
                    <span class="material-symbols-outlined text-[32px]">add</span>
                </button>
                <!-- FAB Desktop (Absolute in View) -->
                <button onclick="openModal()"
                    class="hidden md:flex absolute bottom-10 right-10 size-16 bg-primary text-white rounded-full shadow-xl items-center justify-center z-30 hover:scale-105 transition-transform">
                    <span class="material-symbols-outlined text-[36px]">add</span>
                </button>
            </div>

            <!-- ADD TRANSACTION MODAL -->
            <div id="transaction-modal" class="fixed inset-0 z-50 hidden">
                <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity"
                    onclick="closeModal()">
                </div>
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white dark:bg-dark-surface rounded-2xl shadow-xl p-6 border border-slate-100 dark:border-white/10 scale-95 opacity-0 transition-all duration-200"
                    id="modal-content">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white font-serif">Nuevo Movimiento</h3>
                        <button onclick="closeModal()"
                            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <form onsubmit="handleAddTransaction(event)" class="flex flex-col gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tipo</label>
                            <div class="flex gap-2">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="type" value="ingreso" class="peer hidden" checked
                                        onchange="toggleCostField(false)">
                                    <div
                                        class="text-center py-2 rounded-lg border border-slate-200 dark:border-white/10 text-slate-600 dark:text-slate-300 peer-checked:bg-green-50 peer-checked:text-green-700 peer-checked:border-green-200 dark:peer-checked:bg-green-900/20 dark:peer-checked:text-green-400 transition-all font-medium">
                                        Ingreso</div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="type" value="gasto" class="peer hidden"
                                        onchange="toggleCostField(true)">
                                    <div
                                        class="text-center py-2 rounded-lg border border-slate-200 dark:border-white/10 text-slate-600 dark:text-slate-300 peer-checked:bg-red-50 peer-checked:text-red-700 peer-checked:border-red-200 dark:peer-checked:bg-red-900/20 dark:peer-checked:text-red-400 transition-all font-medium">
                                        Gasto</div>
                                </label>
                            </div>
                        </div>

                        <!-- Doctor Selection -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Doctor Asignado</label>
                            <select id="tx-doctor" name="doctorId"
                                class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                                <option value="">-- Sin asignar / Clínica --</option>
                                <!-- JS WILL POPULATE DOCTORS -->
                            </select>
                        </div>

                        <!-- Category/Treatment -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Categoría /
                                Tratamiento</label>
                            <select name="category"
                                class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                                <option value="General">Odontología General</option>
                                <option value="Ortodoncia">Ortodoncia</option>
                                <option value="Implantes">Implantes</option>
                                <option value="Estética">Estética</option>
                                <option value="Cirugía">Cirugía</option>
                                <option value="Periodoncia">Periodoncia</option>
                                <option value="Otros">Otros (Alquiler, Luz, etc.)</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Concepto</label>
                            <input name="concept" required type="text" placeholder="Ej: Implante Unitario"
                                class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white dark:placeholder-slate-600">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Importe (€)</label>
                                <input name="amount" required type="number" step="0.01" placeholder="0.00"
                                    class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white dark:placeholder-slate-600">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Fecha</label>
                                <input name="date" required type="date"
                                    class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                            </div>
                        </div>

                        <!-- Cost Field (Hidden for Expenses, Optional for Income) -->
                        <div id="cost-field-container">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Coste Asociado (€)
                                <span class="text-[10px] lowercase font-normal text-slate-400">(Lab,
                                    Materiales...)</span></label>
                            <input name="cost" type="number" step="0.01" placeholder="0.00"
                                class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white dark:placeholder-slate-600">
                        </div>

                        <button type="submit"
                            class="mt-2 w-full bg-primary text-white font-bold py-3 rounded-xl shadow-lg shadow-primary/20 hover:bg-primary-dark transition-colors">Guardar</button>
                    </form>
                </div>
            </div>

            <!-- ANALYTICS VIEW (Managers Only) -->
            <div id="view-analytics" class="view-content w-full">
                <div class="p-6 md:p-8 flex flex-col gap-6 pb-24 md:pb-10 max-w-7xl mx-auto">
                    <header>
                        <h2
                            class="text-2xl md:text-3xl font-bold text-slate-900 dark:text-white tracking-tight font-serif">
                            Analítica
                            Avanzada</h2>
                        <p class="text-slate-500 dark:text-slate-400 mt-1">Visión estratégica de rentabilidad y
                            márgenes.
                        </p>
                    </header>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Profit per Doctor Chart -->
                        <div
                            class="bg-white dark:bg-dark-surface rounded-xl p-6 border border-slate-100 dark:border-white/5 shadow-sm">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4 font-serif">Rentabilidad
                                por
                                Doctor (Neto)
                            </h3>
                            <canvas id="chart-profit-doctor"></canvas>
                        </div>

                        <!-- Margin per Treatment Chart -->
                        <div
                            class="bg-white dark:bg-dark-surface rounded-xl p-6 border border-slate-100 dark:border-white/5 shadow-sm">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4 font-serif">Margen por
                                Tratamiento (%)
                            </h3>
                            <canvas id="chart-margin-treatment"></canvas>
                        </div>
                    </div>

                    <!-- Integration Status -->
                    <div
                        class="bg-blue-50 dark:bg-blue-900/10 rounded-xl p-6 border border-blue-100 dark:border-blue-900/20 flex items-center justify-between">
                        <div>
                            <h3 class="text-base font-bold text-blue-900 dark:text-blue-100">Google Sheets Sync</h3>
                            <p class="text-xs text-blue-600 dark:text-blue-300" id="sync-status-text">Estado: No
                                configurado</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="relative flex h-3 w-3" id="sync-indicator">
                                <span
                                    class="absolute inline-flex h-full w-full rounded-full bg-slate-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-slate-500"></span>
                            </span>
                            <span class="text-xs font-bold text-slate-600 dark:text-slate-400"
                                id="sync-status-label">Desconectado</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SETTINGS VIEW -->
            <div id="view-settings" class="view-content w-full">
                <div class="p-6 md:p-10 max-w-4xl mx-auto flex flex-col gap-8">
                    <header>
                        <h2 class="text-2xl font-bold text-slate-900 dark:text-white font-serif">Configuración</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Personaliza tu experiencia dental.</p>
                    </header>

                    <section class="flex flex-col gap-4">
                        <div
                            class="bg-white dark:bg-dark-surface rounded-xl p-6 border border-slate-100 dark:border-white/5 shadow-sm flex flex-col gap-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-base font-bold text-slate-900 dark:text-white">Conexión Google
                                        Sheets</h3>
                                    <p class="text-xs text-slate-500">Pega aquí el enlace CSV de tu hoja de cálculo.</p>
                                </div>
                                <button onclick="syncFromSheets()" id="btn-sync-now"
                                    class="shrink-0 px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2 min-w-[120px]">
                                    <span class="material-symbols-outlined text-sm" id="sync-icon">sync</span>
                                    <span id="sync-text">Sincronizar</span>
                                </button>
                            </div>
                            <input type="text" id="sheets-url-input"
                                placeholder="https://docs.google.com/spreadsheets/.../pub?output=csv"
                                class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                        </div>

                        <div
                            class="bg-white dark:bg-dark-surface rounded-xl p-6 border border-slate-100 dark:border-white/5 shadow-sm flex items-center justify-between">
                            <div>
                                <h3 class="text-base font-bold text-slate-900 dark:text-white">Modo Oscuro</h3>
                                <p class="text-xs text-slate-500">Alternar entre tema claro y oscuro.</p>
                            </div>
                            <button onclick="document.documentElement.classList.toggle('dark')"
                                class="relative inline-flex h-6 w-11 items-center rounded-full bg-slate-200 dark:bg-primary transition-colors">
                                <span
                                    class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1 dark:translate-x-6"></span>
                            </button>
                        </div>

                        <div
                            class="bg-white dark:bg-dark-surface rounded-xl p-6 border border-slate-100 dark:border-white/5 shadow-sm flex items-center justify-between">
                            <div>
                                <h3 class="text-base font-bold text-red-600">Restablecer Datos</h3>
                                <p class="text-xs text-slate-500">Borrar todos los movimientos y empezar de cero.</p>
                            </div>
                            <button onclick="resetApp()"
                                class="px-4 py-2 bg-red-50 text-red-600 hover:bg-red-100 rounded-lg text-sm font-bold transition-colors">
                                Borrar Todo
                            </button>
                        </div>
                    </section>

                    <div class="text-center text-xs text-slate-400 mt-10">
                        Versión 1.0.0 • Clínica Lobato
                    </div>
                </div>
            </div>

            <!-- EXPORT MODAL -->
            <div id="export-modal" class="fixed inset-0 z-50 hidden">
                <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity"
                    onclick="closeExportModal()"></div>
                <div
                    class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm bg-white dark:bg-dark-surface rounded-2xl shadow-xl p-6 border border-slate-100 dark:border-white/10">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4 font-serif">Exportar a CSV</h3>
                    <form onsubmit="handleExportCSV(event)" class="flex flex-col gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Desde</label>
                            <input name="startDate" required type="date"
                                class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Hasta</label>
                            <input name="endDate" required type="date"
                                class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button type="button" onclick="closeExportModal()"
                                class="flex-1 py-2 text-slate-500 hover:bg-slate-50 dark:hover:bg-white/5 rounded-lg text-sm font-medium transition-colors">Cancelar</button>
                            <button type="submit"
                                class="flex-1 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-primary-dark transition-colors shadow-lg shadow-primary/20">Descargar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- CHAT VIEW -->
            <div id="view-chat" class="view-content w-full">
                <!-- Header Chat -->
                <header
                    class="h-16 bg-white dark:bg-[#1a2c35] border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-6 shrink-0">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary text-2xl">smart_toy</span>
                        <h2 class="text-lg font-bold text-slate-900 dark:text-white">Asistente IA</h2>
                        <span
                            class="hidden md:inline-flex items-center px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 text-[10px] font-bold">Online</span>
                    </div>
                </header>

                <!-- Chat Area -->
                <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 bg-slate-50 dark:bg-[#15232b]">
                    <!-- AI Message -->
                    <div class="flex justify-start items-end gap-3 max-w-2xl">
                        <div
                            class="size-8 rounded-full bg-primary flex items-center justify-center shrink-0 text-white">
                            <span class="material-symbols-outlined text-[18px]">smart_toy</span>
                        </div>
                        <div
                            class="bg-white dark:bg-[#233540] p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 dark:border-slate-700">
                            <p class="text-sm leading-relaxed text-slate-800 dark:text-white">Hola Dr. Lobato. He
                                agrupado
                                los tratamientos realizados del 1 al 24 de Octubre. Tienes un <strong
                                    class="text-emerald-600">margen del 73%</strong> en Implantes.</p>
                        </div>
                    </div>

                    <!-- User Message -->
                    <div class="flex justify-end items-end gap-3">
                        <div class="bg-primary text-white p-4 rounded-2xl rounded-tr-none shadow-md max-w-xl">
                            <p class="text-sm leading-relaxed">¿Cuál es el gasto de electricidad?</p>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="bg-white dark:bg-[#1a2c35] p-4 border-t border-slate-200 dark:border-slate-800">
                    <div class="flex gap-2 max-w-4xl mx-auto relative">
                        <input id="chat-input" type="text" placeholder="Escribe o decídselo a la IA..."
                            class="w-full rounded-full border-slate-200 bg-slate-50 pl-5 pr-24 py-3 text-sm focus:border-primary focus:ring-primary dark:bg-[#233540] dark:border-slate-700 dark:text-white transition-all shadow-sm">

                        <!-- Voice & Send Buttons Container -->
                        <div class="absolute right-1 top-1/2 -translate-y-1/2 flex items-center gap-1 pr-1">
                            <!-- Microphone Button -->
                            <button id="mic-btn" onclick="toggleVoiceInput()"
                                class="p-2 rounded-full text-slate-400 hover:text-primary hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors relative group">
                                <span class="material-symbols-outlined" id="mic-icon">mic</span>
                                <!-- Tooltip -->
                                <span
                                    class="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[10px] py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">Dictar
                                    nota</span>
                            </button>

                            <!-- Send Button -->
                            <button onclick="handleSend()"
                                class="bg-primary text-white p-2 rounded-full hover:bg-primary-dark transition-colors shadow-sm flex items-center justify-center h-9 w-9">
                                <span class="material-symbols-outlined text-[18px]">send</span>
                            </button>
                        </div>
                    </div>
                    <p id="voice-status"
                        class="text-center text-[10px] text-emerald-600 font-bold mt-2 opacity-0 transition-opacity">
                        Escuchando... 🎤</p>
                </div>
            </div>

        </main>

        <!-- FLOATING PILL NAVIGATION (Mobile Only - New Design) -->
        <nav
            class="md:hidden fixed bottom-6 inset-x-4 border border-white/40 dark:border-white/10 bg-white/80 dark:bg-[#15171E]/90 backdrop-blur-xl shadow-2xl shadow-slate-300/40 dark:shadow-black/50 rounded-2xl flex justify-around p-1.5 z-50">

            <button onclick="switchTab('view-dashboard')" id="nav-mobile-dashboard"
                class="relative flex flex-1 flex-col items-center justify-center gap-1 rounded-xl py-3 transition-all duration-300 text-primary">
                <!-- Active Indicator Background -->
                <span
                    class="absolute inset-0 bg-primary/10 rounded-xl scale-100 opacity-100 transition-all duration-300 active-indicator z-0"></span>
                <span class="material-symbols-outlined text-[24px] relative z-10 filled">grid_view</span>
            </button>

            <button onclick="switchTab('view-team')" id="nav-mobile-team"
                class="relative flex flex-1 flex-col items-center justify-center gap-1 rounded-xl py-3 transition-all duration-300 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                <span
                    class="absolute inset-0 bg-transparent rounded-xl scale-90 opacity-0 transition-all duration-300 active-indicator z-0"></span>
                <span class="material-symbols-outlined text-[24px] relative z-10">groups</span>
            </button>

            <button onclick="switchTab('view-finance')" id="nav-mobile-finance"
                class="relative flex flex-1 flex-col items-center justify-center gap-1 rounded-xl py-3 transition-all duration-300 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                <span
                    class="absolute inset-0 bg-transparent rounded-xl scale-90 opacity-0 transition-all duration-300 active-indicator z-0"></span>
                <span class="material-symbols-outlined text-[24px] relative z-10">payments</span>
            </button>

            <button onclick="switchTab('view-chat')" id="nav-mobile-chat"
                class="relative flex flex-1 flex-col items-center justify-center gap-1 rounded-xl py-3 transition-all duration-300 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                <span
                    class="absolute inset-0 bg-transparent rounded-xl scale-90 opacity-0 transition-all duration-300 active-indicator z-0"></span>
                <span class="material-symbols-outlined text-[24px] relative z-10">smart_toy</span>
            </button>

            <button onclick="switchTab('view-settings')" id="nav-mobile-settings"
                class="relative flex flex-1 flex-col items-center justify-center gap-1 rounded-xl py-3 transition-all duration-300 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                <span
                    class="absolute inset-0 bg-transparent rounded-xl scale-90 opacity-0 transition-all duration-300 active-indicator z-0"></span>
                <span class="material-symbols-outlined text-[24px] relative z-10">settings</span>
            </button>
        </nav>

        <!-- Safe Area Padding for iPhone Home Indicator -->
        <style>
            .pb-safe {
                padding-bottom: env(safe-area-inset-bottom, 20px);
            }
        </style>

        <script>
            // --- GEMINI API CONFIGURATION ---
            // ⚠️ IMPORTANTE: Reemplaza esto con tu API Key real de Google AI Studio
            const GEMINI_API_KEY = "TU_API_KEY_AQUI";

            const CHAT_HISTORY = [
                { role: "user", parts: [{ text: "Hola soy el Dr. Lobato." }] },
                { role: "model", parts: [{ text: "Hola Dr. Lobato. Soy tu asistente financiero dental. ¿En qué puedo ayudarte hoy?" }] }
            ];

            // --- UI LOGIC ---
            function switchTab(viewId) {
                // Handle both 'dashboard' and 'view-dashboard' inputs
                const targetId = viewId.startsWith('view-') ? viewId : `view-${viewId}`;
                const target = document.getElementById(targetId);

                if (!target) {
                    console.error(`View not found: ${targetId}`);
                    return;
                }

                // 1. Hide all views
                document.querySelectorAll('.view-content').forEach(el => {
                    el.classList.remove('active');
                });

                // 2. Show target view
                target.classList.add('active');

                // 2.5 Scroll to top (Native behavior)
                window.scrollTo(0, 0);

                // 3. Update Desktop Navigation State
                const type = targetId.replace('view-', '');
                document.querySelectorAll('.nav-item').forEach(btn => {
                    btn.className = "nav-item group flex items-center gap-3 rounded-lg px-4 py-3 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors text-left";
                    const icon = btn.querySelector('.material-symbols-outlined');
                    if (icon) icon.classList.remove('filled');
                });

                const activeDesktopBtn = document.getElementById(`nav-${type}`); // Changed from nav-desktop- to nav- for consistency if needed, but keeping nav-ID logic from HTML
                // Actually the HTML IDs are nav-dashboard, nav-analytics etc. 
                // Let's check lines 157, 164 etc. IDs are "nav-dashboard", "nav-analytics".

                const navBtn = document.getElementById(`nav-${type}`);
                if (navBtn) {
                    navBtn.className = "nav-item group flex items-center gap-3 rounded-lg bg-primary px-4 py-3 text-white shadow-md shadow-primary/20 transition-all text-left";
                    const icon = navBtn.querySelector('.material-symbols-outlined');
                    if (icon) icon.classList.add('filled');
                }

                // 4. Update Mobile Navigation State (Floating Pill Logic)
                ['dashboard', 'team', 'finance', 'chat', 'settings'].forEach(t => {
                    const btn = document.getElementById(`nav-mobile-${t}`);
                    if (btn) {
                        btn.classList.remove('text-primary');
                        btn.classList.add('text-slate-400');
                        btn.querySelector('span.active-indicator').classList.remove('bg-primary/10', 'scale-100', 'opacity-100');
                        btn.querySelector('span.active-indicator').classList.add('bg-transparent', 'scale-90', 'opacity-0');

                        const icon = btn.querySelector('.material-symbols-outlined');
                        if (icon) icon.classList.remove('filled');
                    }
                });

                const activeMobileBtn = document.getElementById(`nav-mobile-${type}`);
                if (activeMobileBtn) {
                    activeMobileBtn.classList.remove('text-slate-400');
                    activeMobileBtn.classList.add('text-primary');
                    // Add Active Pill Background
                    activeMobileBtn.querySelector('span.active-indicator').classList.remove('bg-transparent', 'scale-90', 'opacity-0');
                    activeMobileBtn.querySelector('span.active-indicator').classList.add('bg-primary/10', 'scale-100', 'opacity-100');

                    const icon = activeMobileBtn.querySelector('.material-symbols-outlined');
                    if (icon) icon.classList.add('filled');
                }

                // 5. Refresh data for target view
                if (type === 'dashboard') window.switchTimeFilter(window.CURRENT_PERIOD || 'mes');
                if (type === 'finance') renderTable();
                if (type === 'team') renderTeam();
                if (type === 'analytics') if (typeof renderAnalytics === 'function') renderAnalytics();
            }

            // --- VOICE INPUT LOGIC (Web Speech API) ---
            let recognition;
            let isRecording = false;

            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'es-ES'; // Detect Spanish

                recognition.onstart = function () {
                    isRecording = true;
                    document.getElementById('voice-status').style.opacity = '1';
                    document.getElementById('mic-icon').classList.add('text-red-500', 'animate-pulse');
                    document.getElementById('mic-icon').innerText = 'mic_off';
                };

                recognition.onend = function () {
                    isRecording = false;
                    document.getElementById('voice-status').style.opacity = '0';
                    document.getElementById('mic-icon').classList.remove('text-red-500', 'animate-pulse');
                    document.getElementById('mic-icon').innerText = 'mic';
                };

                recognition.onresult = function (event) {
                    const transcript = event.results[0][0].transcript;
                    const input = document.getElementById('chat-input');
                    // Append or set text
                    input.value = input.value ? input.value + " " + transcript : transcript;
                    input.focus();
                };
            } else {
                console.log("Web Speech API not supported in this browser.");
                document.getElementById('mic-btn').style.display = 'none'; // Hide if not supported
            }

            function toggleVoiceInput() {
                if (!recognition) return alert("Tu navegador no soporta dictado por voz 😢. Usa Chrome.");
                if (isRecording) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            }

            // --- CHAT LOGIC ---
            async function handleSend() {
                const input = document.getElementById('chat-input');
                const text = input.value.trim();
                if (!text) return;

                // 1. Add User Message to UI
                addMessageToUI(text, 'user');
                input.value = '';

                // 2. Mock or Call API
                addLoadingIndicator();

                try {
                    // If API Key is placeholder, show simulated response
                    if (GEMINI_API_KEY === "TU_API_KEY_AQUI") {
                        await new Promise(r => setTimeout(r, 1500)); // Simulate delay
                        removeLoadingIndicator();
                        addMessageToUI("⚠️ <b>Modo Demo:</b> Para que te responda de verdad, abre el archivo `03_index.html` con un editor de texto y pega tu API Key de Google (Gemini) en la línea 480 donde dice `const GEMINI_API_KEY = ...`", 'model');
                        addMessageToUI("🤖 <b>Respuesta Simulada:</b> Basado en tus datos, el Dr. Fernando ha facturado 12.500€ este mes.", 'model');
                    } else {
                        // REAL CALL TO GEMINI API
                        const response = await callGeminiAPI(text);
                        removeLoadingIndicator();
                        addMessageToUI(response, 'model');
                    }
                } catch (error) {
                    removeLoadingIndicator();
                    addMessageToUI("Error al conectar con la IA. Revisa tu conexión.", 'model');
                    console.error(error);
                }
            }

            function addMessageToUI(text, role) {
                const chatContainer = document.querySelector("#view-chat .flex-1");
                const isUser = role === 'user';

                const div = document.createElement('div');
                div.className = isUser ? "flex justify-end items-end gap-3" : "flex justify-start items-end gap-3 max-w-2xl";

                const avatar = isUser ? '' : `
                <div class="size-8 rounded-full bg-primary flex items-center justify-center shrink-0 text-white">
                    <span class="material-symbols-outlined text-[18px]">smart_toy</span>
                </div>`;

                const bubbleStyle = isUser
                    ? "bg-primary text-white p-4 rounded-2xl rounded-tr-none shadow-md max-w-xl"
                    : "bg-white dark:bg-[#233540] p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 dark:border-slate-700";

                const textColor = isUser ? "" : "text-slate-800 dark:text-white";

                div.innerHTML = `
                ${isUser ? '' : avatar}
                <div class="${bubbleStyle}">
                    <p class="text-sm leading-relaxed ${textColor}">${text}</p>
                </div>
            `;

                chatContainer.appendChild(div);
                // Auto scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            function addLoadingIndicator() {
                const chatContainer = document.querySelector("#view-chat .flex-1");
                const div = document.createElement('div');
                div.id = "loading-indicator";
                div.className = "flex justify-start items-end gap-3 mt-4 opacity-70";
                div.innerHTML = `
                <div class="size-8 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center shrink-0 animate-pulse">
                    <span class="material-symbols-outlined text-[18px] text-slate-400">more_horiz</span>
                </div>
                <span class="text-xs text-slate-400">Pensando...</span>
            `;
                chatContainer.appendChild(div);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            function removeLoadingIndicator() {
                const loader = document.getElementById('loading-indicator');
                if (loader) loader.remove();
            }

            async function callGeminiAPI(prompt) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;

                const payload = {
                    contents: [
                        ...CHAT_HISTORY, // Send history (simplified)
                        { role: "user", parts: [{ text: prompt }] }
                    ]
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;

                // Add to local history
                CHAT_HISTORY.push({ role: "user", parts: [{ text: prompt }] });
                CHAT_HISTORY.push({ role: "model", parts: [{ text: text }] });

                return text; // Markdown parsed roughly
            }

            // Allow Enter key to send
            document.getElementById('chat-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    handleSend();
                }
            });

            // --- APP LOGIC (FULL - v2 ANALYTICS) ---
            let APP_DATA = {
                transactions: [],
                doctors: [
                    { id: 1, name: "JOSE LUIS", role: "General", goal: 10000, color: "blue" }
                ],
                sheetsUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTc7OqZQYtGXYgqiBW3QR8FuTeG70vuUtzzVZGCNvQp5O_upc1kCZRRlVKIbnEso0sY053eWwC-0Efv/pub?gid=0&single=true&output=csv" // Tu enlace real
            };

            let profitChart = null;
            let marginChart = null;

            // 1. STATE MANAGEMENT
            async function loadData() {
                const DEFAULT_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTc7OqZQYtGXYgqiBW3QR8FuTeG70vuUtzzVZGCNvQp5O_upc1kCZRRlVKIbnEso0sY053eWwC-0Efv/pub?gid=0&single=true&output=csv";

                const saved = localStorage.getItem('DENTAL_APP_DATA_V2');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Mezclamos para asegurar que si la URL guardada está vacía, use la default
                    APP_DATA = { ...APP_DATA, ...parsed };
                    if (!APP_DATA.sheetsUrl || APP_DATA.sheetsUrl === "") {
                        APP_DATA.sheetsUrl = DEFAULT_URL;
                    }

                    // Si detectamos que los datos guardados son los mock iniciales (ID 101),
                    // y tenemos una URL real, intentamos sincronizar automáticamente una vez.
                    const isMock = APP_DATA.transactions.some(t => t.id === 101);
                    if (isMock) {
                        console.log("Mock data detected with real URL. Syncing...");
                        await syncFromSheets(true);
                    }
                } else {
                    // Si es la primera vez y ya definimos la URL arriba
                    if (APP_DATA.sheetsUrl) {
                        console.log("Detectada URL de Sheets, iniciando sync inicial...");
                        await syncFromSheets(true); // true = silent mode (no alerts)
                    } else {
                        initializeMockData();
                    }
                }

                populateDoctorDropdown();

                // Asegurar que el input tenga el valor real, no solo el placeholder
                const urlInput = document.getElementById('sheets-url-input');
                if (urlInput) {
                    urlInput.value = APP_DATA.sheetsUrl || DEFAULT_URL;
                }
            }

            function initializeMockData() {
                APP_DATA.doctors = [
                    { id: 1, name: "Dr. Fernando", role: "Implantes", goal: 15000, color: "blue" },
                    { id: 2, name: "Dra. Carla", role: "Ortodoncia", goal: 14000, color: "purple" }
                ];

                // Hybrid Data: Manual + "Sheet"
                APP_DATA.transactions = [
                    // Manual Entries
                    { id: 101, date: "2023-10-24", concept: "Implante Unitario", amount: 1200.00, cost: 300.00, type: "ingreso", doctorId: 1, category: "Implantes", source: "manual" },
                    { id: 102, date: "2023-10-23", concept: "Ortodoncia Invisible (Pago 1)", amount: 4500.00, cost: 1200.00, type: "ingreso", doctorId: 2, category: "Ortodoncia", source: "manual" },

                    // Mock "Google Sheet" Imports
                    { id: 201, date: "2023-10-22", concept: "[SHEET] Compra Material Quirúrgico", amount: 1500.00, cost: 0, type: "gasto", doctorId: null, category: "Otros", source: "sheet" },
                    { id: 202, date: "2023-10-20", concept: "[SHEET] Factura Luz Endesa", amount: 250.00, cost: 0, type: "gasto", doctorId: null, category: "Otros", source: "sheet" },
                    { id: 203, date: "2023-10-18", concept: "[SHEET] Limpieza Bucal", amount: 60.00, cost: 10.00, type: "ingreso", doctorId: 1, category: "General", source: "sheet" }
                ];
                saveData();
            }

            function saveData() {
                localStorage.setItem('DENTAL_APP_DATA_V2', JSON.stringify(APP_DATA));
                updateDashboard();
                renderTeam();
                renderAnalytics();
            }

            // --- GOOGLE SHEETS SYNC LOGIC ---
            window.syncFromSheets = async function (silent = false) {
                console.log("Iniciando sincronización...");
                const urlInput = document.getElementById('sheets-url-input');
                // Intentar sacar la URL del input, si no, del estado global
                let url = urlInput ? urlInput.value.trim() : APP_DATA.sheetsUrl;

                if (!url || url === "") {
                    url = APP_DATA.sheetsUrl; // Último recurso
                }

                if (!url) {
                    if (!silent) alert("Por favor, introduce o pega la URL en el cuadro inferior.");
                    return;
                }

                if (!url.includes('output=csv')) {
                    if (!silent) alert("La URL parece incorrecta. Asegúrate de que termina en 'output=csv'");
                    return;
                }

                APP_DATA.sheetsUrl = url;
                updateSyncUI('loading');

                return new Promise((resolve) => {
                    Papa.parse(url, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: function (results) {
                            console.log("Datos recibidos de PapaParse:", results.data ? results.data.length : 0);
                            if (results.data && results.data.length > 0) {
                                processSheetsData(results.data);
                                updateSyncUI('success');
                                saveData();
                                if (!silent) alert("Sincronización completada con éxito ✅");
                                resolve(true);
                            } else {
                                if (!silent) alert("No se encontraron datos en el CSV. Revisa el documento.");
                                updateSyncUI('error');
                                resolve(false);
                            }
                        },
                        error: function (err) {
                            console.error("PapaParse Error:", err);
                            updateSyncUI('error');
                            if (!silent) alert("Error al leer el archivo. Asegúrate de que esté 'Publicado en la web' como CSV.");
                            resolve(false);
                        }
                    });
                });
            }

            function processSheetsData(data) {
                // Mapeo específico para tus columnas:
                // Fecha, Dentista, Paciente, Concepto, Efectivo, Tarjeta, Financiación, Laboratorio, Observación, Total
                const importedTxs = data
                    .filter(row => row.Total && parseFloat(row.Total) > 0) // Ignorar filas vacías
                    .map((row, index) => {
                        const amount = parseFloat(row.Total) || 0;
                        const cost = parseFloat(row.Laboratorio) || 0;

                        // Si el concepto está vacío, usamos el nombre del paciente
                        const concept = row.Concepto ? row.Concepto : (row.Paciente ? `Paciente: ${row.Paciente}` : "Tratamiento");

                        return {
                            id: Date.now() + index,
                            date: convertToISODate(row.Fecha),
                            concept: concept,
                            amount: amount,
                            cost: cost,
                            type: "ingreso", // Por ahora todo lo que entra de esta hoja son ingresos
                            doctorId: findDoctorIdByName(row.Dentista),
                            category: "General",
                            source: "sheet"
                        };
                    });

                APP_DATA.transactions = importedTxs;
            }

            function convertToISODate(dateStr) {
                if (!dateStr) return new Date().toISOString().split('T')[0];
                // Intentar convertir DD/MM/YYYY a YYYY-MM-DD
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                }
                return dateStr;
            }

            function findDoctorIdByName(name) {
                if (!name || name.toLowerCase() === 'clínica') return null;
                // Normalizar nombres para la búsqueda
                const normalizedSearch = name.trim().toLowerCase();
                const doc = APP_DATA.doctors.find(d => d.name.toLowerCase().includes(normalizedSearch));
                return doc ? doc.id : null;
            }

            function updateSyncUI(status) {
                const text = document.getElementById('sync-status-text');
                const label = document.getElementById('sync-status-label');
                const indicator = document.getElementById('sync-indicator');
                const btn = document.getElementById('btn-sync-now');
                const btnIcon = document.getElementById('sync-icon');
                const btnText = document.getElementById('sync-text');

                if (!label || !indicator) return;

                switch (status) {
                    case 'loading':
                        if (text) text.innerText = "Sincronizando con Google Sheets...";
                        label.innerText = "Cargando";
                        indicator.innerHTML = '<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span>';
                        if (btn) {
                            btn.disabled = true;
                            btn.classList.add('opacity-50', 'cursor-not-allowed');
                        }
                        if (btnIcon) btnIcon.classList.add('animate-spin');
                        if (btnText) btnText.innerText = "Cargando...";
                        break;
                    case 'success':
                        if (text) text.innerText = "Última sincronización: " + new Date().toLocaleTimeString();
                        label.innerText = "Sincronizado";
                        indicator.innerHTML = '<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>';
                        if (btn) {
                            btn.disabled = false;
                            btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                        if (btnIcon) btnIcon.classList.remove('animate-spin');
                        if (btnText) btnText.innerText = "Sincronizar";
                        break;
                    case 'error':
                        if (text) text.innerText = "Error en la última sincronización";
                        label.innerText = "Error";
                        indicator.innerHTML = '<span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>';
                        if (btn) {
                            btn.disabled = false;
                            btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                        if (btnIcon) btnIcon.classList.remove('animate-spin');
                        if (btnText) btnText.innerText = "Reintentar";
                        break;
                }
            }

            // 2. FINANCE LOGIC
            let CURRENT_FINANCE_TYPE = 'all';

            window.switchFinanceType = function (type) {
                CURRENT_FINANCE_TYPE = type;
                document.querySelectorAll('.fin-type-filter').forEach(btn => {
                    btn.classList.remove('active', 'bg-white', 'text-slate-900', 'shadow-sm', 'dark:bg-dark-surface', 'dark:text-white', 'font-bold');
                    btn.classList.add('text-slate-500', 'hover:text-slate-700', 'dark:text-slate-400');
                    btn.classList.add('font-medium');
                });
                const activeBtn = document.getElementById(`btn-fin-${type}`);
                if (activeBtn) {
                    activeBtn.classList.add('active', 'bg-white', 'text-slate-900', 'shadow-sm', 'dark:bg-dark-surface', 'dark:text-white', 'font-bold');
                    activeBtn.classList.remove('text-slate-500', 'hover:text-slate-700', 'dark:text-slate-400', 'font-medium');
                }
                renderTable();
            }

            window.toggleFinanceFilters = function () {
                const panel = document.getElementById('finance-filters-panel');
                const btn = document.getElementById('btn-toggle-filters');
                if (panel.classList.contains('hidden')) {
                    panel.classList.remove('hidden');
                    btn.classList.add('bg-primary/10', 'border-primary/30', 'text-primary');
                } else {
                    panel.classList.add('hidden');
                    btn.classList.remove('bg-primary/10', 'border-primary/30', 'text-primary');
                }
            }

            window.clearFinanceFilters = function () {
                document.getElementById('filter-date-start').value = '';
                document.getElementById('filter-date-end').value = '';
                document.getElementById('search-input').value = '';
                renderTable();
            }

            function renderTable() {
                const tbody = document.getElementById('finance-table-body');
                const mobileList = document.getElementById('finance-mobile-list');
                const searchVal = document.getElementById('search-input')?.value.toLowerCase() || "";
                const dateStart = document.getElementById('filter-date-start')?.value;
                const dateEnd = document.getElementById('filter-date-end')?.value;

                if (tbody) tbody.innerHTML = '';
                if (mobileList) mobileList.innerHTML = '';

                let filtered = APP_DATA.transactions;

                // 1. Filter by Type
                if (CURRENT_FINANCE_TYPE !== 'all') {
                    filtered = filtered.filter(t => t.type === CURRENT_FINANCE_TYPE);
                }

                // 2. Filter by Dates
                if (dateStart || dateEnd) {
                    filtered = filtered.filter(t => {
                        const tDate = t.date; // "YYYY-MM-DD"
                        let match = true;
                        if (dateStart && tDate < dateStart) match = false;
                        if (dateEnd && tDate > dateEnd) match = false;
                        return match;
                    });
                }

                // 3. Filter by Search
                if (searchVal) {
                    filtered = filtered.filter(t =>
                        t.concept.toLowerCase().includes(searchVal) ||
                        (t.category && t.category.toLowerCase().includes(searchVal)) ||
                        getDoctorName(t.doctorId).toLowerCase().includes(searchVal)
                    );
                }

                // 4. Sort and Render
                filtered = filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

                filtered.forEach(t => {
                    const isIngreso = t.type === 'ingreso';
                    const color = isIngreso ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-500 dark:text-red-400';
                    const sign = isIngreso ? '+' : '-';
                    const sourceIcon = t.source === 'sheet' ? '<span class="material-symbols-outlined text-[14px] text-blue-500 dark:text-blue-400" title="Importado de Sheets">table_view</span>' : '';

                    // Desktop Row
                    if (tbody) {
                        tbody.innerHTML += `
                        <tr class="hover:bg-slate-50 dark:hover:bg-white/5 transition-colors border-b border-slate-100 dark:border-white/5 last:border-0">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-white font-serif">${new Date(t.date).toLocaleDateString()}</td>
                            <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-300 flex items-center gap-2">
                                 ${sourceIcon}
                                 <div>
                                     <p class="font-medium text-slate-900 dark:text-white">${t.concept}</p>
                                     <p class="text-[10px] text-slate-400">${t.category || 'General'} • ${getDoctorName(t.doctorId)}</p>
                                 </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold ${color}">${sign} ${parseFloat(t.amount).toFixed(2)}€</td>
                            <td class="px-6 py-4 text-center">
                                <button onclick="deleteTransaction(${t.id})" class="text-slate-400 hover:text-red-500 transition-colors"><span class="material-symbols-outlined text-[20px]">delete</span></button>
                            </td>
                        </tr>`;
                    }

                    // Mobile Card (Stacked Layout)
                    if (mobileList) {
                        mobileList.innerHTML += `
                        <div class="p-4 flex flex-col gap-3 bg-white dark:bg-dark-surface">
                            <!-- Row 1: Date & Concept -->
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex flex-col gap-0.5 overflow-hidden">
                                     <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">${new Date(t.date).toLocaleDateString()}</span>
                                     <p class="font-bold text-slate-900 dark:text-white text-sm leading-tight truncate">${t.concept}</p>
                                </div>
                                ${sourceIcon}
                            </div>
                            
                            <!-- Row 2: Category, Doctor, Amount, Delete -->
                            <div class="flex items-center justify-between">
                                <div class="flex flex-col">
                                    <span class="text-[10px] text-slate-500 dark:text-slate-400 truncate max-w-[120px]">${t.category || 'General'}</span>
                                    <span class="text-[10px] text-slate-400 truncate max-w-[120px]">${getDoctorName(t.doctorId)}</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-base font-black font-serif ${color}">${sign}${parseFloat(t.amount).toFixed(0)}€</span>
                                    <button onclick="deleteTransaction(${t.id})" class="text-slate-300 hover:text-red-500 p-1 rounded-full hover:bg-slate-50 dark:hover:bg-white/5 transition-colors"><span class="material-symbols-outlined text-[20px]">delete</span></button>
                                </div>
                            </div>
                        </div>`;
                    }
                });
            }

            function handleAddTransaction(e) {
                e.preventDefault();
                const form = e.target;
                APP_DATA.transactions.unshift({
                    id: Date.now(),
                    type: form.type.value,
                    concept: form.concept.value,
                    amount: parseFloat(form.amount.value),
                    date: form.date.value,
                    doctorId: form.doctorId.value ? parseInt(form.doctorId.value) : null,
                    category: form.category.value,
                    cost: form.cost.value ? parseFloat(form.cost.value) : 0,
                    source: "manual"
                });
                saveData();
                renderTable();
                closeModal();
                form.reset();
                form.date.value = new Date().toISOString().split('T')[0];
                toggleCostField(false); // Reset UI
            }

            function toggleCostField(isExpense) {
                const container = document.getElementById('cost-field-container');
                if (isExpense) {
                    container.style.display = 'none'; // Expenses don't have "costs" in this simple model, they ARE the cost.
                } else {
                    container.style.display = 'block';
                }
            }

            function deleteTransaction(id) {
                if (confirm("¿Eliminar este movimiento?")) {
                    APP_DATA.transactions = APP_DATA.transactions.filter(t => t.id !== id);
                    saveData();
                    renderTable();
                }
            }

            // Helper
            function getDoctorName(id) {
                if (!id) return 'Clínica';
                const doc = APP_DATA.doctors.find(d => d.id === id);
                return doc ? doc.name : 'Desconocido';
            }

            function populateDoctorDropdown() {
                const select = document.getElementById('tx-doctor');
                if (!select) return;
                select.innerHTML = '<option value="">-- Sin asignar / Clínica --</option>';
                APP_DATA.doctors.forEach(d => {
                    select.innerHTML += `<option value="${d.id}">${d.name}</option>`;
                });
            }

            // 3. TEAM LOGIC (UPDATED V2)
            let CURRENT_TEAM_PERIOD = 'mes';

            window.switchTeamTimeFilter = function (period) {
                CURRENT_TEAM_PERIOD = period;
                document.querySelectorAll('.team-time-filter').forEach(btn => {
                    btn.classList.remove('active', 'bg-white', 'text-slate-900', 'shadow-sm', 'dark:bg-dark-surface', 'dark:text-white');
                    btn.classList.add('text-slate-500', 'hover:text-slate-700', 'dark:text-slate-400');
                    btn.classList.remove('font-bold');
                    btn.classList.add('font-medium');
                });
                const activeBtn = document.getElementById(`btn-team-${period}`);
                if (activeBtn) {
                    activeBtn.classList.add('active', 'bg-white', 'text-slate-900', 'shadow-sm', 'dark:bg-dark-surface', 'dark:text-white');
                    activeBtn.classList.remove('text-slate-500', 'hover:text-slate-700', 'dark:text-slate-400');
                    activeBtn.classList.add('font-bold');
                    activeBtn.classList.remove('font-medium');
                }
                renderTeam();
            }

            function renderTeam() {
                const container = document.getElementById('doctors-container');
                if (!container) return;

                const periodData = calculatePeriodData(CURRENT_TEAM_PERIOD);

                container.innerHTML = `
                <div class="flex items-center justify-between mb-1">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white font-serif">Doctores Activos</h3>
                    <p class="text-xs text-slate-400">Datos: <span class="capitalize font-bold text-primary">${CURRENT_TEAM_PERIOD}</span></p>
                </div>
            `;

                periodData.team.forEach(doc => {
                    const progress = Math.min((doc.generated / doc.goal) * 100, 100).toFixed(0);
                    // Use Lobato Gold/Dark theme logic for badges
                    const colorClass = doc.color === 'purple'
                        ? 'text-slate-600 bg-slate-100 dark:text-slate-300 dark:bg-white/5'
                        : 'text-primary bg-primary/10 dark:text-primary dark:bg-primary/20';

                    const barColor = doc.color === 'purple' ? 'bg-slate-400' : 'bg-primary';

                    container.innerHTML += `
                    <div class="flex flex-col gap-3 md:gap-4 rounded-xl bg-white p-3 md:p-5 shadow-sm border border-slate-100 dark:bg-dark-surface dark:border-white/5">
                        <div class="flex items-start justify-between">
                            <div class="flex items-center gap-3">
                                <div class="h-10 w-10 md:h-12 md:w-12 rounded-full bg-slate-100 dark:bg-white/5 flex items-center justify-center text-slate-500 dark:text-slate-400 font-bold text-lg md:text-xl font-serif">${doc.name[0]}</div>
                                <div>
                                    <h4 class="text-sm md:text-base font-bold text-slate-900 dark:text-white font-serif">${doc.name}</h4>
                                    <span class="inline-flex items-center rounded-md px-2 py-0.5 md:py-1 text-[10px] font-medium ${colorClass} ring-1 ring-inset ring-slate-500/10">${doc.role}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-lg md:text-xl font-black tracking-tight text-slate-900 dark:text-white font-serif">${(doc.generated / 1000).toFixed(1)}k€</p>
                            </div>
                        </div>
                        <div class="flex flex-col gap-1">
                            <div class="flex justify-between text-xs font-medium">
                                <span class="text-slate-500">Objetivo ${(doc.goal / 1000).toFixed(1)}k€</span>
                                <span class="text-slate-900 dark:text-white">${progress}%</span>
                            </div>
                            <div class="relative h-1.5 md:h-2 w-full overflow-hidden rounded-full bg-slate-100 dark:bg-white/10">
                                <div class="absolute left-0 top-0 h-full rounded-full ${barColor}" style="width: ${progress}%"></div>
                            </div>
                        </div>
                         <button onclick="deleteDoctor(${doc.id})" class="self-end text-xs text-red-400 hover:text-red-500 mt-1 transition-colors">Eliminar</button>
                    </div>
                `;
                });

                // Update Donut Chart
                updateTeamDonut(periodData.team);
            }

            function updateTeamDonut(teamData) {
                const donutEl = document.getElementById('team-donut-chart');
                const totalEl = document.getElementById('team-donut-total');
                const legendEl = document.getElementById('team-donut-legend');
                const labelEl = document.getElementById('team-donut-period-label');
                if (!donutEl || !totalEl || !legendEl || !labelEl) return;

                labelEl.textContent = CURRENT_TEAM_PERIOD;

                const totalCalculated = teamData.reduce((sum, d) => sum + d.generated, 0);
                totalEl.textContent = totalCalculated.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });

                if (totalCalculated === 0) {
                    donutEl.style.background = 'rgba(0,0,0,0.05)';
                    legendEl.innerHTML = '<p class="text-center text-xs text-slate-400 py-4">Sin producción en este periodo</p>';
                    return;
                }

                let currentPercent = 0;
                const gradients = [];
                const colors = ['#C69C6D', '#A87F55', '#E5C4A0', '#8B6B4D', '#D4AF37', '#7044bf', '#31165d'];

                legendEl.innerHTML = '';

                teamData.forEach((doc, i) => {
                    const p = (doc.generated / totalCalculated) * 100;
                    if (p > 0) {
                        const color = colors[i % colors.length];
                        gradients.push(`${color} ${currentPercent}% ${currentPercent + p}%`);
                        currentPercent += p;

                        legendEl.innerHTML += `
                        <div class="flex items-center justify-between text-sm py-1 border-b border-slate-50 dark:border-white/5 last:border-0">
                            <span class="flex items-center gap-2">
                                <div class="h-2 w-2 rounded-full" style="background-color: ${color}"></div> 
                                <span class="font-medium text-slate-600 dark:text-slate-400 text-xs">${doc.name}</span>
                            </span>
                            <span class="font-bold text-slate-900 dark:text-white text-xs">${p.toFixed(0)}%</span>
                        </div>
                    `;
                    }
                });

                if (gradients.length > 0) {
                    donutEl.style.background = `conic-gradient(${gradients.join(', ')})`;
                }
            }

            function handleAddDoctor(e) {
                e.preventDefault();
                const form = e.target;
                const colors = ['blue', 'purple']; // Simplified logic
                const randomColor = colors[Math.floor(Math.random() * colors.length)];

                APP_DATA.doctors.push({
                    id: Date.now(),
                    name: form.name.value,
                    role: form.role.value,
                    goal: parseFloat(form.goal.value),
                    color: randomColor
                });
                saveData();
                closeDoctorModal();
                form.reset();
            }

            function deleteDoctor(id) {
                if (confirm("¿Eliminar doctor?")) {
                    APP_DATA.doctors = APP_DATA.doctors.filter(d => d.id !== id);
                    saveData();
                }
            }

            function openDoctorModal() {
                const m = document.getElementById('doctor-modal');
                m.classList.remove('hidden');
                setTimeout(() => document.getElementById('doctor-modal-content').classList.remove('scale-95', 'opacity-0'), 10);
            }
            function closeDoctorModal() {
                const m = document.getElementById('doctor-modal');
                const c = document.getElementById('doctor-modal-content');
                c.classList.add('scale-95', 'opacity-0');
                setTimeout(() => m.classList.add('hidden'), 200);
            }

            // 3.5 Render Analytics (New)
            function renderAnalytics() {
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js not loaded');
                    return;
                }
                const ctxProfit = document.getElementById('chart-profit-doctor');
                const ctxMargin = document.getElementById('chart-margin-treatment');

                if (!ctxProfit || !ctxMargin) return;

                // Destroy existing instances to prevent overlays
                if (profitChart) profitChart.destroy();
                if (marginChart) marginChart.destroy();

                // Prepare Data from APP_DATA (respecting current DASHBOARD period for consistency)
                const period = window.CURRENT_PERIOD || 'mes';
                const periodData = calculatePeriodData(period);

                const labels = periodData.team.map(d => d.name);
                const dataProfit = periodData.team.map(d => d.generated);

                // check theme for colors
                const isDark = document.documentElement.classList.contains('dark');
                const colorText = isDark ? '#ffffff' : '#0f172a';
                const colorGrid = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

                // 1. Profit Chart (Bar)
                profitChart = new Chart(ctxProfit, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Ingresos (€)',
                            data: dataProfit,
                            backgroundColor: '#C69C6D',
                            borderRadius: 6,
                            barThickness: 40
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: isDark ? '#15171E' : '#ffffff',
                                titleColor: isDark ? '#C69C6D' : '#0f172a',
                                bodyColor: isDark ? '#ffffff' : '#64748b',
                                borderColor: '#C69C6D',
                                borderWidth: 1,
                                padding: 10,
                                titleFont: { family: 'Playfair Display', size: 14 },
                                bodyFont: { family: 'Manrope', size: 13 }
                            }
                        },
                        scales: {
                            y: {
                                grid: { color: colorGrid, borderDash: [5, 5] },
                                ticks: { color: colorText, font: { family: 'Manrope' } }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: colorText, font: { family: 'Manrope', weight: 'bold' } }
                            }
                        }
                    }
                });

                // 2. Margin Chart (Doughnut) - Mock Distribution
                marginChart = new Chart(ctxMargin, {
                    type: 'doughnut',
                    data: {
                        labels: ['Ortodoncia', 'Implantes', 'General', 'Estética'],
                        datasets: [{
                            data: [35, 45, 15, 5],
                            backgroundColor: ['#C69C6D', '#A87F55', '#F3E7D7', '#334155'], // Gold Gradient & Dark Slate
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        cutout: '75%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: colorText,
                                    font: { family: 'Manrope', size: 12 },
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });
            }

            // 4. DASHBOARD LOGIC
            function updateDashboard() {
                let income = 0; let expenses = 0;
                APP_DATA.transactions.forEach(t => {
                    if (t.type === 'ingreso') income += parseFloat(t.amount);
                    if (t.type === 'gasto') expenses += parseFloat(t.amount);
                });

                const kpiIncome = document.getElementById('kpi-income');
                const kpiExpenses = document.getElementById('kpi-expenses');
                const kpiProfit = document.getElementById('kpi-profit');

                if (kpiIncome) kpiIncome.innerText = income.toLocaleString('de-DE') + "€";
                if (kpiExpenses) kpiExpenses.innerText = expenses.toLocaleString('de-DE') + "€";
                if (kpiProfit) {
                    const p = income - expenses;
                    kpiProfit.innerText = p.toLocaleString('de-DE') + "€";
                    kpiProfit.className = p >= 0 ? "text-3xl font-bold text-primary tracking-tight font-serif" : "text-3xl font-bold text-red-500 tracking-tight font-serif";
                }
            }

            // 5. EXPORT & SETTINGS LOGIC
            function openExportModal() {
                const modal = document.getElementById('export-modal');
                modal.classList.remove('hidden');
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                document.querySelector('#export-modal input[name="startDate"]').value = firstDay.toISOString().split('T')[0];
                document.querySelector('#export-modal input[name="endDate"]').value = today.toISOString().split('T')[0];
            }

            function closeExportModal() {
                document.getElementById('export-modal').classList.add('hidden');
            }

            function handleExportCSV(e) {
                e.preventDefault();
                const start = new Date(e.target.startDate.value);
                const end = new Date(e.target.endDate.value);

                const dataToExport = APP_DATA.transactions.filter(t => {
                    const d = new Date(t.date);
                    return d >= start && d <= end;
                });

                if (dataToExport.length === 0) return alert("No hay movimientos en esas fechas.");

                let csvContent = "data:text/csv;charset=utf-8,ID,Fecha,Concepto,Tipo,Importe\n";
                dataToExport.forEach(row => {
                    csvContent += `${row.id},${row.date}, "${row.concept}", ${row.type},${row.amount} \n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `contabilidad_dental_${e.target.endDate.value}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                closeExportModal();
            }

            function resetApp() {
                if (confirm("⚠️ ¿BORRAR TODO? Esta acción no se puede deshacer.")) {
                    localStorage.removeItem('DENTAL_APP_DATA');
                    location.reload();
                }
            }

            function openModal() {
                const modal = document.getElementById('transaction-modal');
                modal.classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('modal-content').classList.remove('scale-95', 'opacity-0');
                    document.getElementById('modal-content').classList.add('scale-100', 'opacity-100');
                }, 10);
                const dateInput = document.querySelector('input[name="date"]');
                if (dateInput && !dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];
            }

            function closeModal() {
                const modal = document.getElementById('transaction-modal');
                document.getElementById('modal-content').classList.remove('scale-100', 'opacity-100');
                document.getElementById('modal-content').classList.add('scale-95', 'opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 200);
            }

            // 6. INITIALIZATION
            document.addEventListener('DOMContentLoaded', () => {
                try {
                    loadData();
                    renderTable();
                    renderTeam();
                    updateDashboard();
                    renderAnalytics();

                    // Initialize Manager View if Dashboard is active
                    if (document.getElementById('view-dashboard')) {
                        switchTimeFilter('mes');
                    }
                } catch (e) {
                    console.error("Initialization error:", e);
                }
            });

            // --- REAL SMART DATE LOGIC ---
            function getPeriodDates(period) {
                const now = new Date();
                const start = new Date(now);
                const end = new Date(now);

                // Reset time to start/end of day
                start.setHours(0, 0, 0, 0);
                end.setHours(23, 59, 59, 999);

                switch (period) {
                    case 'ayer':
                        start.setDate(now.getDate() - 1);
                        end.setDate(now.getDate() - 1);
                        break;
                    case 'semana':
                        // Start of current week (Monday)
                        const day = now.getDay() || 7; // Get current day number, converting Sun(0) to 7
                        if (day !== 1) start.setHours(-24 * (day - 1));
                        break;
                    case 'mes':
                        start.setDate(1); // 1st of current month
                        break;
                    case 'hoy':
                    default:
                        // Already set to today
                        break;
                }
                return { start, end };
            }

            function calculatePeriodData(period) {
                const { start, end } = getPeriodDates(period);

                // Filter Transactions
                const relevantTxs = APP_DATA.transactions.filter(t => {
                    const tDate = new Date(t.date);
                    // Use simple string comparison for day precision to avoid timezone headaches
                    const tStr = tDate.toISOString().split('T')[0];
                    const sStr = start.toISOString().split('T')[0];
                    const eStr = end.toISOString().split('T')[0];
                    return tStr >= sStr && tStr <= eStr;
                });

                // Calculate Totals
                let income = 0;
                let expenses = 0;
                const docStats = {};

                // Init Doctors
                APP_DATA.doctors.forEach(d => {
                    docStats[d.id] = { ...d, generated: 0 };
                });

                relevantTxs.forEach(t => {
                    if (t.type === 'ingreso') {
                        income += parseFloat(t.amount);
                        if (t.doctorId && docStats[t.doctorId]) {
                            docStats[t.doctorId].generated += parseFloat(t.amount);
                        }
                    } else {
                        expenses += parseFloat(t.amount);
                    }
                });

                // Sort Team
                const team = Object.values(docStats)
                    .sort((a, b) => b.generated - a.generated)
                    .map(d => ({
                        ...d,
                        amount: d.generated.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }),
                        percent: (d.generated / (income || 1)) * 100 // Avoid divide by zero
                    }));

                return {
                    income: income.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }),
                    expenses: expenses.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }),
                    team: team
                };
            }

            window.switchTimeFilter = function (period) {
                // 1. Update Buttons Visual State
                document.querySelectorAll('.time-filter').forEach(btn => {
                    btn.classList.remove('active', 'bg-white', 'text-slate-900', 'shadow-sm', 'dark:bg-dark-surface', 'dark:text-white');
                    btn.classList.add('text-slate-500', 'hover:text-slate-700', 'dark:text-slate-400');
                });
                const activeBtn = document.getElementById(`btn-${period}`);
                if (activeBtn) {
                    activeBtn.classList.add('active', 'bg-white', 'text-slate-900', 'shadow-sm', 'dark:bg-dark-surface', 'dark:text-white');
                    activeBtn.classList.remove('text-slate-500', 'hover:text-slate-700', 'dark:text-slate-400');
                }

                // 2. GET REAL CALCULATED DATA
                const data = calculatePeriodData(period);

                // 3. Update Hero Card
                const incomeEl = document.getElementById('hero-income');
                const expensesEl = document.getElementById('hero-expenses');

                if (incomeEl && expensesEl) {
                    incomeEl.style.opacity = '0.5';
                    expensesEl.style.opacity = '0.5';
                    setTimeout(() => {
                        incomeEl.textContent = data.income;
                        expensesEl.textContent = data.expenses;
                        incomeEl.style.opacity = '1';
                        expensesEl.style.opacity = '1';
                    }, 150);
                }

                // 4. Update Team Ranking
                const listEl = document.getElementById('team-ranking-list');
                if (listEl) {
                    listEl.innerHTML = '';

                    data.team.forEach((doc, index) => {
                        const isLeader = index === 0 && doc.generated > 0;
                        const leaderIcon = isLeader ? '<span class="material-symbols-outlined text-yellow-500 text-sm">emoji_events</span>' : '';
                        const barColor = isLeader ? 'bg-primary' : 'bg-slate-300 dark:bg-slate-600';
                        const avatarLetter = doc.name ? doc.name[0] : '?';

                        listEl.innerHTML += `
                        <div class="flex items-center gap-4 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-white/5 transition-colors group">
                            <div class="h-10 w-10 shrink-0 rounded-full bg-slate-100 dark:bg-white/10 flex items-center justify-center font-serif font-bold text-slate-600 dark:text-slate-300 relative">
                                ${avatarLetter}
                                ${isLeader ? '<div class="absolute -top-1 -right-1 bg-white dark:bg-dark-surface rounded-full p-0.5 shadow-sm">' + leaderIcon + '</div>' : ''}
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-bold text-slate-900 dark:text-white text-sm">${doc.name}</span>
                                    <span class="font-black text-slate-900 dark:text-white text-sm font-serif">${doc.amount}</span>
                                </div>
                                <div class="h-1.5 w-full bg-slate-100 dark:bg-white/10 rounded-full overflow-hidden">
                                    <div class="h-full ${barColor} rounded-full" style="width: ${doc.percent}%"></div>
                                </div>
                            </div>
                        </div>
                        `;
                    });
                }
            };
        </script>

</body>

</html>