<!DOCTYPE html>
<html class="light" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>Dental SaaS - Gesti√≥n Cl√≠nica</title>
    <!-- PWA / Mobile Native Feel -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#C69C6D">
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/48/tooth.png">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&family=Noto+Sans:wght@100..900&display=swap"
        rel="stylesheet" />
    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <!-- Fonts: Manrope (Sans) & Playfair Display (Serif for Premium Feel) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" />
    <!-- Chart.js for Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js&#64;4.4.0"></script>

    <!-- Gemini AI SDK -->
    <script type="importmap">
    {
        "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
    }
    </script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <!-- Tailwind CSS (Configured via JS for Custom Colors) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Manrope', 'sans-serif'],
                        serif: ['"Playfair Display"', 'serif'],
                        mono: ['"SF Mono"', '"Roboto Mono"', 'monospace'], // Para n√∫meros financieros
                    },
                    colors: {
                        primary: '#BFA181', /* Dorado arena, m√°s elegante que el anterior */
                        'primary-dark': '#8C7355',
                        'dark-bg': '#0F1115', /* Negro casi puro, m√°s profundo */
                        'dark-surface': '#181A20',
                        'accent-green': '#2D5B48', /* Verde ingl√©s para dinero */
                        'accent-red': '#8B3A3A', /* Rojo ladrillo para gastos */
                    },
                    boxShadow: {
                        'elite': '0 2px 10px rgba(0, 0, 0, 0.03)',
                        'elite-hd': '0 10px 30px -10px rgba(0, 0, 0, 0.06)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Manrope', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        h1,
        h2,
        h3,
        .brand-font {
            font-family: 'Playfair Display', serif;
        }

        /* Glassmorphism Real */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
        }

        .dark .glass-panel {
            background: rgba(24, 26, 32, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* Card Elite Style */
        .card-elite {
            background: #FFFFFF;
            border-radius: 24px;
            border: 1px solid rgba(0, 0, 0, 0.03);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark .card-elite {
            background: #181A20;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Financial Numbers */
        .num-font {
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.02em;
        }

        /* Nav Floating Bar */
        .nav-float {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .dark .nav-float {
            background: rgba(15, 17, 21, 0.85);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Hide Scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .view-content {
            display: none;
            min-height: 100dvh;
            flex-direction: column;
        }

        .view-content.active {
            display: flex;
        }

        @media (max-width: 768px) {
            #view-chat {
                padding-bottom: 6rem;
            }
        }
    </style>
</head>

<body
    class="bg-gray-50 text-slate-900 transition-colors duration-300 dark:bg-dark-bg dark:text-slate-100 font-sans antialiased min-h-dvh">

    <!-- MAIN APP CONTAINER -->
    <div class="flex min-h-dvh bg-gray-50 dark:bg-dark-bg">

        <!-- SIDEBAR (Desktop) - PREMIUM DARK (Fixed Alignment) -->
        <aside
            class="hidden md:flex w-72 flex-col border-r border-slate-200 bg-white dark:border-white/5 dark:bg-dark-surface z-20 h-dvh sticky top-0">
            <!-- Brand -->
            <div class="flex h-20 items-center gap-3 px-6 border-b border-slate-100 dark:border-white/5">
                <div
                    class="flex h-10 w-10 items-center justify-center rounded-xl bg-primary text-white shadow-lg shadow-primary/30">
                    <span class="material-symbols-outlined text-2xl">dentistry</span>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-slate-900 dark:text-white font-serif">Lobato<span
                            class="text-primary">Dental</span></h1>
                    <p class="text-[10px] font-medium uppercase tracking-widest text-slate-400">Alta Precisi√≥n</p>
                </div>
            </div>

            <!-- Nav Links -->
            <nav class="flex-1 overflow-y-auto px-4 py-6 space-y-1">
                <!-- Dashboard -->
                <button onclick="switchTab('dashboard')" id="nav-dashboard"
                    class="nav-item group flex w-full items-center gap-3 rounded-xl px-4 py-3.5 text-sm font-medium transition-all duration-200 bg-primary/10 text-primary dark:bg-primary/20 dark:text-primary-dark ring-1 ring-primary/20">
                    <span class="material-symbols-outlined">dashboard</span>
                    Dashboard
                </button>

                <!-- Analytics (NEW) -->
                <button onclick="switchTab('analytics')" id="nav-analytics"
                    class="nav-item group flex w-full items-center gap-3 rounded-xl px-4 py-3.5 text-sm font-medium text-slate-500 hover:bg-slate-50 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-white/5 dark:hover:text-white transition-all">
                    <span class="material-symbols-outlined">monitoring</span>
                    Anal√≠tica
                </button>

                <!-- Finance -->
                <button onclick="switchTab('finance')" id="nav-finance"
                    class="nav-item group flex w-full items-center gap-3 rounded-xl px-4 py-3.5 text-sm font-medium text-slate-500 hover:bg-slate-50 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-white/5 dark:hover:text-white transition-all">
                    <span class="material-symbols-outlined">payments</span>
                    Finanzas
                </button>

                <!-- Team -->
                <button onclick="switchTab('team')" id="nav-team"
                    class="nav-item group flex w-full items-center gap-3 rounded-xl px-4 py-3.5 text-sm font-medium text-slate-500 hover:bg-slate-50 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-white/5 dark:hover:text-white transition-all">
                    <span class="material-symbols-outlined">groups</span>
                    Equipo
                </button>

                <!-- Chat AI - GOLD PREMIUM STYLE -->
                <button onclick="switchTab('chat')" id="nav-chat"
                    class="nav-item group flex w-full items-center gap-3 rounded-xl px-4 py-3.5 text-sm font-medium text-slate-500 hover:bg-amber-50 dark:hover:bg-amber-500/10 hover:text-amber-700 dark:hover:text-amber-400 transition-all border border-transparent hover:border-amber-200/50 dark:hover:border-amber-500/20">
                    <div class="relative">
                        <span
                            class="material-symbols-outlined text-amber-500 group-hover:scale-110 transition-transform">auto_awesome</span>
                        <span class="absolute -right-1.5 -top-1.5 flex h-3 w-3">
                            <span
                                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-amber-500"></span>
                        </span>
                    </div>
                    <span class="font-bold">Lobato AI</span>
                </button>
            </nav>

            <!-- User Footer (Pinned to bottom) -->
            <div class="mt-auto flex flex-col gap-4 border-t border-slate-100 dark:border-slate-800 p-6">
                <button onclick="switchTab('view-settings')"
                    class="flex items-center gap-3 px-2 text-slate-600 dark:text-slate-400 hover:text-primary transition-colors text-left group">
                    <span class="material-symbols-outlined group-hover:rotate-90 transition-transform">settings</span>
                    <span class="text-sm font-medium">Configuraci√≥n</span>
                </button>
                <div class="flex items-center gap-3 px-2">
                    <div class="h-9 w-9 rounded-full bg-slate-200 bg-cover bg-center shrink-0 ring-2 ring-white dark:ring-white/10"
                        style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuB-E9taHyLsWFW6WpLd22sYFn0f7uwSNaanMTwKISPUir_BPMS9PjeOi10EN_WC_W983TqpLXF2YoGRRvVXfm1aFk3dTqPzaVaa4vFWB42uxb5TllkGeGFUnYy0gmQQjL3PYOxTzhvfn8Kix34LQH_EXSX4gmDFF5ZnGizFdhv6SOmaLFU8rZyxrQkP1MsTlDYuU_dPyfMi1vETLpaBPC8imIKk9NuCjqyxC4FT76oSP5UhU2PhUsTk5NWv4-u_603sHOapzYY_N9U");'>
                    </div>
                    <div class="flex flex-col">
                        <p class="text-sm font-bold text-slate-900 dark:text-white">Dr. Lobato</p>
                        <p class="text-[11px] text-slate-500 font-medium">Administrador</p>
                        <p id="current-date-display"
                            class="text-[9px] text-primary/70 font-bold uppercase tracking-wider mt-1"></p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 relative bg-slate-50 dark:bg-dark-bg w-full">

            <!-- DASHBOARD VIEW -->
            <!-- CHAT VIEW (Moved Here) -->
            <div id="view-chat"
                class="view-content flex-col w-full h-[100dvh] md:h-screen bg-gray-50 dark:bg-dark-bg z-30">
                <!-- Header Chat -->
                <header
                    class="h-16 bg-white dark:bg-[#1a2c35] border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-6 shrink-0">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary text-2xl">smart_toy</span>
                        <h2 class="text-lg font-bold text-slate-900 dark:text-white">Lobato AI</h2>
                        <span
                            class="hidden md:inline-flex items-center px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 text-[10px] font-bold">Online</span>
                    </div>
                </header>

                <!-- Chat Area -->
                <div id="chat-messages"
                    class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 bg-slate-50 dark:bg-[#15232b] pb-48 md:pb-6">
                    <!-- AI Welcome Message -->
                    <div class="flex justify-start items-end gap-3 max-w-2xl">
                        <div
                            class="size-8 rounded-full bg-primary flex items-center justify-center shrink-0 text-white">
                            <span class="material-symbols-outlined text-[18px]">smart_toy</span>
                        </div>
                        <div
                            class="bg-white dark:bg-[#233540] p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 dark:border-slate-700">
                            <p class="text-sm leading-relaxed text-slate-800 dark:text-white">Hola Fernando, soy Lobato
                                AI üëã ¬øEn qu√© puedo ayudarte hoy?</p>
                            <ul class="text-sm mt-2 space-y-1 text-slate-600 dark:text-slate-300">
                                <li>üìà An√°lisis de rentabilidad y m√°rgenes</li>
                                <li>üë• Rendimiento del equipo</li>
                                <li>üíº Estrategias de captaci√≥n</li>
                                <li>üéØ Optimizaci√≥n de gastos</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Input Area (Fixed on Mobile above Dock) -->
                <div
                    class="fixed bottom-[calc(4rem+env(safe-area-inset-bottom))] md:relative md:bottom-auto left-0 w-full z-40 bg-white dark:bg-[#1a2c35] p-3 md:p-4 border-t border-slate-200 dark:border-slate-800 shrink-0 shadow-lg md:shadow-none bg-opacity-95 backdrop-blur-sm">
                    <div class="flex gap-2 max-w-4xl mx-auto relative">
                        <input id="chat-input" type="text" placeholder="Escribe o dec√≠dselo a la IA..."
                            class="w-full rounded-full border-slate-200 bg-slate-50 pl-5 pr-24 py-3 text-sm focus:border-primary focus:ring-primary dark:bg-[#233540] dark:border-slate-700 dark:text-white transition-all shadow-sm">
                        <!-- Buttons -->
                        <div class="absolute right-1 top-1/2 -translate-y-1/2 flex items-center gap-1 pr-1">
                            <button id="mic-btn" onclick="toggleVoiceInput()"
                                class="p-2 rounded-full text-slate-400 hover:text-primary transition-colors"><span
                                    class="material-symbols-outlined" id="mic-icon">mic</span></button>
                            <button onclick="handleSend()"
                                class="bg-primary text-white p-2 rounded-full hover:bg-primary-dark transition-colors h-9 w-9 flex items-center justify-center"><span
                                    class="material-symbols-outlined text-[18px]">send</span></button>
                        </div>
                    </div>
                    <p id="voice-status"
                        class="text-center text-[10px] text-emerald-600 font-bold mt-2 opacity-0 transition-opacity">
                        Escuchando... üé§</p>
                </div>
            </div>

            <!-- DASHBOARD VIEW -->
            <div id="view-dashboard" class="view-content active w-full">
                <!-- Increased padding-bottom to pb-48 to clear floating menu -->
                <div class="container mx-auto max-w-7xl p-4 md:p-6 flex flex-col gap-3 md:gap-4 pb-48 md:pb-6">
                    <!-- Header -->
                    <!-- Header with Global Time Selector -->
                    <header class="flex flex-col md:flex-row items-center justify-between gap-4 mt-2 md:mt-0">
                        <div class="text-center md:text-left">
                            <h2
                                class="text-2xl md:text-3xl font-bold text-slate-900 dark:text-white tracking-tight font-serif">
                                Hola, Cl√≠nica Lobato</h2>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mt-0.5">Visi√≥n general del negocio.</p>
                        </div>

                        <!-- Segmented Control (The Brain) -->
                        <div class="flex bg-slate-100 dark:bg-white/5 rounded-xl p-1 gap-1 shadow-inner">
                            <button onclick="switchTimeFilter('hoy')" id="btn-hoy"
                                class="time-filter active px-4 py-2 rounded-lg text-xs md:text-sm font-bold transition-all duration-300 shadow-sm bg-white text-slate-900 dark:bg-dark-surface dark:text-white">HOY</button>
                            <button onclick="switchTimeFilter('ayer')" id="btn-ayer"
                                class="time-filter px-4 py-2 rounded-lg text-xs md:text-sm font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-all duration-300">AYER</button>
                            <button onclick="switchTimeFilter('semana')" id="btn-semana"
                                class="time-filter px-4 py-2 rounded-lg text-xs md:text-sm font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-all duration-300">SEMANA</button>
                            <button onclick="switchTimeFilter('mes')" id="btn-mes"
                                class="time-filter px-4 py-2 rounded-lg text-xs md:text-sm font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-all duration-300">MES</button>
                        </div>
                    </header>

                    <!-- STRATEGIC KPIS (Financial Health) -->
                    <section class="grid grid-cols-2 lg:grid-cols-3 gap-2 md:gap-4">
                        <!-- Revenue -->
                        <div onclick="switchTab('finance')"
                            class="card-elite cursor-pointer group flex flex-col justify-between gap-2 p-3 md:p-5 hover:scale-[1.02] transition-all border-0 shadow-md">
                            <div class="flex items-start justify-between">
                                <div
                                    class="rounded-full bg-emerald-50 dark:bg-emerald-900/20 p-2 md:p-3 text-emerald-600 dark:text-emerald-400">
                                    <span
                                        class="material-symbols-outlined filled text-[20px] md:text-[24px]">payments</span>
                                </div>
                                <span id="trend-revenue"
                                    class="rounded-full bg-emerald-100 dark:bg-emerald-900/30 px-2 py-0.5 text-[10px] md:text-xs font-bold text-emerald-700 dark:text-emerald-400">--%</span>
                            </div>
                            <div>
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Ingresos
                                    Mes</p>
                                <p class="text-xl md:text-3xl font-medium text-slate-900 dark:text-white tracking-tight num-font"
                                    id="kpi-income">---</p>
                            </div>
                        </div>

                        <!-- Net Profit -->
                        <div onclick="switchTab('finance')"
                            class="card-elite cursor-pointer group flex flex-col justify-between gap-2 p-3 md:p-5 hover:scale-[1.02] transition-all border-0 shadow-md">
                            <div class="flex items-start justify-between">
                                <div
                                    class="rounded-full bg-blue-50 dark:bg-blue-900/20 p-2 md:p-3 text-blue-600 dark:text-blue-400">
                                    <span
                                        class="material-symbols-outlined filled text-[20px] md:text-[24px]">account_balance</span>
                                </div>
                                <span id="trend-profit"
                                    class="rounded-full bg-blue-100 dark:bg-blue-900/30 px-2 py-0.5 text-[10px] md:text-xs font-bold text-blue-700 dark:text-blue-400">--%</span>
                            </div>
                            <div>
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Beneficio
                                    Neto</p>
                                <p class="text-xl md:text-3xl font-medium text-slate-900 dark:text-white tracking-tight num-font"
                                    id="kpi-profit">---</p>
                            </div>
                        </div>

                        <!-- Profit Margin (%) -->
                        <div
                            class="card-elite col-span-2 lg:col-span-1 flex flex-col justify-between gap-2 p-3 md:p-5 border-0 shadow-md relative overflow-hidden group">
                            <div id="margin-indicator-bg" class="absolute right-0 top-0 h-full w-2 bg-emerald-500/30">
                            </div>
                            <div class="flex items-start justify-between relative z-10">
                                <div id="margin-icon-bg"
                                    class="rounded-full bg-emerald-50 dark:bg-emerald-900/20 p-2 md:p-3 text-emerald-600 dark:text-emerald-400">
                                    <span
                                        class="material-symbols-outlined filled text-[20px] md:text-[24px]">analytics</span>
                                </div>
                                <div id="margin-status-badge"
                                    class="rounded-full bg-emerald-100 dark:bg-emerald-900/30 px-3 py-1 text-[10px] font-black text-emerald-700 dark:text-emerald-400 uppercase">
                                    √ìptimo</div>
                            </div>
                            <div class="relative z-10">
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Margen de
                                    Beneficio</p>
                                <p class="text-3xl md:text-4xl font-medium text-slate-900 dark:text-white num-font tracking-tight"
                                    id="kpi-margin">--%</p>
                            </div>
                        </div>
                    </section>

                    <!-- STRATEGIC COCKPIT (Efficiency & Growth) -->
                    <section class="grid grid-cols-2 md:grid-cols-3 gap-2 md:gap-4">
                        <!-- Forecast -->
                        <div class="card-elite p-3 md:p-5 relative overflow-hidden group border-0 shadow-md">
                            <div class="absolute left-0 top-0 w-1 h-full bg-purple-500/50"></div>
                            <div class="flex items-center gap-2 mb-3">
                                <span
                                    class="material-symbols-outlined text-purple-600 dark:text-purple-400 text-xl">timeline</span>
                                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest font-sans">
                                    Proyecci√≥n Cierre</h3>
                            </div>
                            <div id="projection-content">
                                <p class="text-[10px] text-slate-400 uppercase font-bold mb-1 italic">Estimado a 30 d√≠as
                                </p>
                                <p id="projection-amount"
                                    class="text-2xl font-medium text-slate-900 dark:text-white num-font tracking-tight mb-3">
                                    --</p>
                                <div class="bg-slate-100 dark:bg-white/5 rounded-full h-1.5 overflow-hidden">
                                    <div id="projection-progress"
                                        class="h-full bg-purple-500 transition-all duration-500" style="width: 0%">
                                    </div>
                                </div>
                                <p id="projection-text"
                                    class="text-[10px] text-slate-500 dark:text-slate-400 mt-2 font-medium">
                                    Calculando...</p>
                            </div>
                        </div>

                        <!-- Fidelizaci√≥n (Nuevos vs Recurrentes) -->
                        <div class="card-elite p-3 md:p-5 relative overflow-hidden group border-0 shadow-md">
                            <div class="absolute left-0 top-0 w-1 h-full bg-blue-500/50"></div>
                            <div class="flex items-center gap-2 mb-3">
                                <span
                                    class="material-symbols-outlined text-blue-600 dark:text-blue-400 text-xl">groups</span>
                                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest font-sans">
                                    Fidelizaci√≥n</h3>
                            </div>
                            <div class="flex flex-col gap-3">
                                <div class="flex items-end justify-between">
                                    <div>
                                        <p class="text-[10px] text-slate-400 uppercase font-bold">Nuevos</p>
                                        <p id="stats-patients-new"
                                            class="text-2xl font-medium text-slate-900 dark:text-white num-font">--</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-[10px] text-slate-400 uppercase font-bold">Recurrentes</p>
                                        <p id="stats-patients-recurring"
                                            class="text-2xl font-medium text-slate-900 dark:text-white num-font">--</p>
                                    </div>
                                </div>
                                <div
                                    class="flex h-1.5 w-full bg-slate-100 dark:bg-white/5 rounded-full overflow-hidden">
                                    <div id="fidel-bar-new" class="h-full bg-blue-500" style="width: 50%"></div>
                                    <div id="fidel-bar-rec" class="h-full bg-indigo-300 dark:bg-indigo-700"
                                        style="width: 50%"></div>
                                </div>
                                <p id="fidel-insight" class="text-[10px] text-slate-500 italic font-medium">--</p>
                            </div>
                        </div>

                        <!-- Burn Rate / Daily Efficiency -->
                        <div
                            class="card-elite p-3 md:p-5 relative overflow-hidden group border-0 shadow-md col-span-2 md:col-span-1">
                            <div class="absolute left-0 top-0 w-1 h-full bg-amber-500/50"></div>
                            <div class="flex items-center gap-2 mb-3">
                                <span
                                    class="material-symbols-outlined text-amber-600 dark:text-amber-400 text-xl">speed</span>
                                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest font-sans">
                                    Gasto Diario</h3>
                            </div>
                            <div id="burnrate-content">
                                <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Mantenimiento local</p>
                                <p id="burnrate-daily"
                                    class="text-2xl font-medium text-slate-900 dark:text-white num-font tracking-tight mb-2">
                                    --</p>
                                <p class="text-[10px] text-slate-500 dark:text-slate-400 font-medium"
                                    id="burnrate-insight">--</p>
                            </div>
                        </div>
                    </section>


                    <!-- Charts -->
                    <section class="card-elite p-4 md:p-5 flex flex-col gap-3 flex-1 min-h-[280px]">
                        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                            <div>
                                <h3 class="text-lg font-bold text-slate-900 dark:text-white font-serif">Balance
                                    Semestral
                                </h3>
                                <p class="text-sm text-slate-500 dark:text-slate-400">Ingresos vs Gastos (√öltimos 6
                                    meses)
                                </p>
                            </div>
                            <div class="flex items-center gap-4 text-sm">
                                <div class="flex items-center gap-2">
                                    <span class="h-3 w-3 rounded-full bg-primary"></span>
                                    <span class="font-medium text-slate-600 dark:text-slate-300">Ingresos</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="h-3 w-3 rounded-full bg-slate-300 dark:bg-slate-600"></span>
                                    <span class="font-medium text-slate-600 dark:text-slate-300">Gastos</span>
                                </div>
                            </div>
                        </div>
                        <!-- Real Chart Canvas -->
                        <div class="flex-1 w-full min-h-[220px]">
                            <canvas id="chart-profit-dash"></canvas>
                        </div>
                    </section>
                </div>
            </div>

            <!-- TEAM VIEW -->
            <div id="view-team" class="view-content w-full">
                <!-- Header Team -->
                <header
                    class="sticky top-0 z-10 flex flex-col md:flex-row md:items-center justify-between border-b border-slate-200 bg-white/90 px-6 py-5 backdrop-blur-md dark:border-white/5 dark:bg-dark-surface/90 gap-4">
                    <div class="flex flex-col gap-1">
                        <h2 class="text-2xl font-black tracking-tight text-slate-900 dark:text-white font-serif">Equipo
                            M√©dico</h2>
                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Rendimiento por periodos</p>
                    </div>

                    <!-- Team Period Selector -->
                    <div class="flex bg-slate-100 dark:bg-white/5 rounded-xl p-1 gap-1 shadow-inner order-3 md:order-2">
                        <button onclick="switchTimeFilter('hoy')" id="btn-team-hoy"
                            class="team-time-filter px-3 py-1.5 rounded-lg text-[10px] md:text-xs font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 transition-all duration-300">HOY</button>
                        <button onclick="switchTimeFilter('ayer')" id="btn-team-ayer"
                            class="team-time-filter px-3 py-1.5 rounded-lg text-[10px] md:text-xs font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 transition-all duration-300">AYER</button>
                        <button onclick="switchTimeFilter('semana')" id="btn-team-semana"
                            class="team-time-filter px-3 py-1.5 rounded-lg text-[10px] md:text-xs font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 transition-all duration-300">SEMANA</button>
                        <button onclick="switchTimeFilter('mes')" id="btn-team-mes"
                            class="team-time-filter active px-3 py-1.5 rounded-lg text-[10px] md:text-xs font-bold transition-all duration-300 shadow-sm bg-white text-slate-900 dark:bg-dark-surface dark:text-white">MES</button>
                        <button onclick="switchTimeFilter('a√±o')" id="btn-team-a√±o"
                            class="team-time-filter px-3 py-1.5 rounded-lg text-[10px] md:text-xs font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 transition-all duration-300">A√ëO</button>
                    </div>

                    <!-- Removed Add Doctor button - auto-discovery from sheets -->
                </header>

                <div class="flex flex-col gap-6 p-6 md:p-8 w-full pb-24 md:pb-10">
                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                        <!-- Left: Cards -->
                        <div id="doctors-container" class="xl:col-span-2 flex flex-col gap-4">
                            <!-- JS RENDERED DOCTORS HERE -->
                        </div>

                        <!-- ADD DOCTOR MODAL -->
                        <div id="doctor-modal" class="fixed inset-0 z-50 hidden">
                            <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity"
                                onclick="closeDoctorModal()"></div>
                            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white dark:bg-dark-surface rounded-2xl shadow-xl p-6 border border-slate-100 dark:border-white/10 md:scale-100 scale-95 opacity-0 transition-all duration-200"
                                id="doctor-modal-content">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-xl font-bold text-slate-900 dark:text-white font-serif">Nuevo Doctor
                                    </h3>
                                    <button onclick="closeDoctorModal()"
                                        class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                                        <span class="material-symbols-outlined">close</span>
                                    </button>
                                </div>
                                <form onsubmit="handleAddDoctor(event)" class="flex flex-col gap-4">
                                    <div>
                                        <label
                                            class="block text-xs font-bold text-slate-500 uppercase mb-1">Nombre</label>
                                        <input name="name" required type="text" placeholder="Ej: Dr. Smith"
                                            class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white dark:placeholder-slate-600">
                                    </div>
                                    <div>
                                        <label
                                            class="block text-xs font-bold text-slate-500 uppercase mb-1">Especialidad</label>
                                        <select name="role"
                                            class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                                            <option value="General">Odontolog√≠a General</option>
                                            <option value="Ortodoncia">Ortodoncia</option>
                                            <option value="Implantes">Implantes</option>
                                            <option value="Est√©tica">Est√©tica</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Objetivo
                                            Mensual (‚Ç¨)</label>
                                        <input name="goal" required type="number" placeholder="10000"
                                            class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white dark:placeholder-slate-600">
                                    </div>
                                    <button type="submit"
                                        class="mt-2 w-full bg-primary text-white font-bold py-3 rounded-xl shadow-lg shadow-primary/20 hover:bg-primary-dark transition-colors">Guardar
                                        Doctor</button>
                                </form>
                            </div>
                        </div>

                        <!-- Right: Logic Donut -->
                        <div class="flex flex-col gap-6">
                            <div class="card-elite p-6 border-0">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-bold text-slate-900 dark:text-white font-serif">
                                        Distribuci√≥n
                                    </h3>
                                    <span
                                        class="text-[10px] font-bold text-primary uppercase tracking-wider bg-primary/10 px-2 py-0.5 rounded-md"
                                        id="team-donut-period-label">MES</span>
                                </div>
                                <div class="relative flex items-center justify-center py-4">
                                    <div class="relative h-48 w-48 rounded-full transition-all duration-500"
                                        id="team-donut-chart" style="background: conic-gradient(#C69C6D 0% 100%);">
                                        <div
                                            class="absolute inset-4 rounded-full bg-white dark:bg-dark-surface flex flex-col items-center justify-center z-10 shadow-inner">
                                            <p
                                                class="text-[10px] font-medium text-slate-500 dark:text-slate-400 uppercase tracking-tighter">
                                                Total Periodo</p>
                                            <p class="text-2xl font-black text-slate-900 dark:text-white font-serif"
                                                id="team-donut-total">
                                                0‚Ç¨
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4 flex flex-col gap-2" id="team-donut-legend">
                                    <!-- Dynamic Legend -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FINANCE VIEW -->
            <div id="view-finance" class="view-content w-full">
                <!-- Increased padding-bottom -->
                <div class="p-4 md:p-8 flex flex-col gap-6 pb-48 md:pb-10 max-w-6xl mx-auto w-full">
                    <header class="flex flex-col gap-4 w-full">
                        <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 w-full">
                            <div class="w-full">
                                <h2
                                    class="text-2xl md:text-3xl font-bold text-slate-900 dark:text-white tracking-tight font-serif">
                                    Finanzas</h2>
                                <div class="flex items-center gap-2 mt-2">
                                    <div class="relative flex-1 md:flex-initial">
                                        <input id="search-input" onkeyup="debouncedRenderTable()" type="text"
                                            placeholder="Buscar concepto o doctor..."
                                            class="w-full md:w-80 rounded-lg border-slate-200 bg-white px-3 py-2 pl-9 text-sm dark:bg-dark-surface dark:border-white/10 dark:text-white dark:placeholder-slate-500 focus:ring-2 focus:ring-primary/20 transition-all">
                                        <span
                                            class="material-symbols-outlined absolute left-3 top-2 text-slate-400 text-[18px]">search</span>
                                    </div>
                                    <button onclick="toggleFinanceFilters()" id="btn-toggle-filters"
                                        class="flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 rounded-lg text-slate-600 text-sm font-medium hover:bg-slate-50 transition-colors dark:bg-dark-surface dark:border-white/10 dark:text-slate-400">
                                        <span class="material-symbols-outlined text-[18px]">tune</span>
                                        <span class="hidden md:inline">Filtros</span>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="openExportModal()"
                                    class="hidden md:flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-lg text-slate-700 text-sm font-medium hover:bg-slate-50 transition-colors dark:bg-dark-surface dark:border-white/10 dark:text-slate-300 dark:hover:bg-white/5">
                                    <span class="material-symbols-outlined text-[18px]">download</span>
                                    Exportar
                                </button>
                            </div>
                        </div>

                        <!-- Sub-view Toggles (Income, Expenses, All) -->
                        <div class="flex flex-wrap items-center justify-between gap-4">
                            <div class="flex bg-slate-100 dark:bg-white/5 rounded-xl p-1 gap-1 shadow-inner h-fit">
                                <button onclick="switchFinanceType('all')" id="btn-fin-all"
                                    class="fin-type-filter active px-4 py-1.5 rounded-lg text-xs font-bold transition-all duration-300 shadow-sm bg-white text-slate-900 dark:bg-dark-surface dark:text-white">TODOS</button>
                                <button onclick="switchFinanceType('ingreso')" id="btn-fin-ingreso"
                                    class="fin-type-filter px-4 py-1.5 rounded-lg text-xs font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-all duration-300">INGRESOS</button>
                                <button onclick="switchFinanceType('gasto')" id="btn-fin-gasto"
                                    class="fin-type-filter px-4 py-1.5 rounded-lg text-xs font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-all duration-300">GASTOS</button>
                            </div>
                        </div>

                        <!-- Collapsible Filter Panel -->
                        <div id="finance-filters-panel" class="hidden overflow-hidden transition-all duration-300">
                            <div
                                class="bg-slate-50 dark:bg-white/5 rounded-xl p-4 border border-slate-200 dark:border-white/10 flex flex-col md:flex-row gap-4">
                                <div class="flex-1">
                                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Fecha
                                        Inicio</label>
                                    <input type="date" id="filter-date-start" onchange="renderTable()"
                                        class="w-full rounded-lg border-slate-200 bg-white px-3 py-2 text-sm dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                                </div>
                                <div class="flex-1">
                                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Fecha
                                        Fin</label>
                                    <input type="date" id="filter-date-end" onchange="renderTable()"
                                        class="w-full rounded-lg border-slate-200 bg-white px-3 py-2 text-sm dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                                </div>
                                <div class="flex items-end">
                                    <button onclick="clearFinanceFilters()"
                                        class="text-xs text-primary hover:underline font-bold py-2">Limpiar
                                        filtros</button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <!-- Compact Finance Summary Mobile Gap -->
                    <div class="grid grid-cols-3 gap-2 md:gap-4 overflow-hidden w-full">
                        <div
                            class="bg-white dark:bg-dark-surface rounded-xl p-3 md:p-5 border border-slate-100 dark:border-white/5 shadow-sm text-center md:text-left min-w-0">
                            <p
                                class="text-[10px] md:text-sm text-slate-500 dark:text-slate-400 font-medium uppercase truncate">
                                Entradas</p>
                            <p id="finance-kpi-income"
                                class="text-sm md:text-2xl font-bold text-slate-900 dark:text-white mt-0.5 md:mt-1 font-serif truncate">
                                ‚Ç¨0</p>
                        </div>
                        <div
                            class="bg-white dark:bg-dark-surface rounded-xl p-3 md:p-5 border border-slate-100 dark:border-white/5 shadow-sm text-center md:text-left min-w-0">
                            <p
                                class="text-[10px] md:text-sm text-slate-500 dark:text-slate-400 font-medium uppercase truncate">
                                Salidas</p>
                            <p id="finance-kpi-expenses"
                                class="text-sm md:text-2xl font-bold text-slate-900 dark:text-white mt-0.5 md:mt-1 font-serif truncate">
                                ‚Ç¨0</p>
                        </div>
                        <div
                            class="bg-white dark:bg-dark-surface rounded-xl p-3 md:p-5 border border-slate-100 dark:border-white/5 shadow-sm text-center md:text-left min-w-0">
                            <p
                                class="text-[10px] md:text-sm text-slate-500 dark:text-slate-400 font-medium uppercase truncate">
                                Neto</p>
                            <p id="finance-kpi-net"
                                class="text-sm md:text-2xl font-bold text-primary mt-0.5 md:mt-1 font-serif truncate">
                                ‚Ç¨0</p>
                        </div>
                    </div>

                    <!-- NEW: Transaction Statistics & Category Breakdown -->
                    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Transaction Statistics Cards -->
                        <!-- Transaction Statistics Cards (Elite Style) -->
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Total Visible (Net Flow) -->
                            <div class="card-elite p-5 flex flex-col justify-center">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-1.5 h-1.5 rounded-full bg-emerald-600"></div>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest font-sans">
                                        Flujo Neto</p>
                                </div>
                                <p id="stat-total-amount"
                                    class="text-2xl md:text-3xl font-medium text-slate-900 dark:text-white num-font tracking-tight">
                                    ‚Ç¨0</p>
                            </div>

                            <!-- Average -->
                            <div class="card-elite p-5 flex flex-col justify-center">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-1.5 h-1.5 rounded-full bg-blue-600"></div>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest font-sans">
                                        Ticket Medio</p>
                                </div>
                                <p id="stat-avg-amount"
                                    class="text-2xl md:text-3xl font-medium text-slate-900 dark:text-white num-font tracking-tight">
                                    ‚Ç¨0</p>
                            </div>

                            <!-- Largest -->
                            <div class="card-elite p-5 flex flex-col justify-center">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-1.5 h-1.5 rounded-full bg-primary"></div>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest font-sans">
                                        Mayor Ingreso</p>
                                </div>
                                <p id="stat-largest-amount"
                                    class="text-2xl md:text-3xl font-medium text-slate-900 dark:text-white num-font tracking-tight">
                                    ‚Ç¨0</p>
                            </div>

                            <!-- Count -->
                            <div class="card-elite p-5 flex flex-col justify-center">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-1.5 h-1.5 rounded-full bg-slate-400"></div>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest font-sans">
                                        Movimientos</p>
                                </div>
                                <p id="stat-count"
                                    class="text-2xl md:text-3xl font-medium text-slate-900 dark:text-white num-font tracking-tight">
                                    0</p>
                            </div>
                        </div>

                        <!-- Category Breakdown Chart -->
                        <div class="card-elite p-6 border-0">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4 font-serif">Distribuci√≥n
                                por Categor√≠a</h3>
                            <div style="position: relative; height: 220px; width: 100%;">
                                <canvas id="chart-finance-categories"></canvas>
                            </div>
                        </div>
                    </section>

                    <div class="hidden md:block card-elite overflow-hidden border-0">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 dark:bg-white/5">
                                    <tr>
                                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Fecha</th>
                                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Concepto</th>
                                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase text-right">
                                            Importe
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="finance-table-body" class="divide-y divide-slate-100 dark:divide-white/5">
                                    <!-- JS WILL RENDER ROWS HERE -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Mobile List (Dynamic) -->
                    <div id="finance-mobile-list" class="md:hidden flex flex-col gap-4">
                        <!-- JS WILL RENDER CARDS HERE -->
                    </div>
                </div>
                <!-- FAB Mobile only -->
                <!-- FAB Mobile -->
                <button onclick="openModal()"
                    class="fixed bottom-28 right-6 md:hidden size-14 bg-primary text-white rounded-full shadow-lg flex items-center justify-center z-30">
                    <span class="material-symbols-outlined text-[32px]">add</span>
                </button>
                <!-- FAB Desktop (Absolute in View) -->
                <button onclick="openModal()"
                    class="hidden md:flex absolute bottom-10 right-10 size-16 bg-primary text-white rounded-full shadow-xl items-center justify-center z-30 hover:scale-105 transition-transform">
                    <span class="material-symbols-outlined text-[36px]">add</span>
                </button>
            </div>

            <!-- ADD TRANSACTION MODAL -->
            <div id="transaction-modal" class="fixed inset-0 z-50 hidden">
                <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity"
                    onclick="closeModal()">
                </div>
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white dark:bg-dark-surface rounded-2xl shadow-xl p-6 border border-slate-100 dark:border-white/10 scale-95 opacity-0 transition-all duration-200"
                    id="modal-content">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white font-serif">Nuevo Movimiento</h3>
                        <button onclick="closeModal()"
                            class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <form onsubmit="handleAddTransaction(event)" class="flex flex-col gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tipo</label>
                            <div class="flex gap-2">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="type" value="ingreso" class="peer hidden" checked
                                        onchange="toggleCostField(false)">
                                    <div
                                        class="text-center py-2 rounded-lg border border-slate-200 dark:border-white/10 text-slate-600 dark:text-slate-300 peer-checked:bg-green-50 peer-checked:text-green-700 peer-checked:border-green-200 dark:peer-checked:bg-green-900/20 dark:peer-checked:text-green-400 transition-all font-medium">
                                        Ingreso</div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="type" value="gasto" class="peer hidden"
                                        onchange="toggleCostField(true)">
                                    <div
                                        class="text-center py-2 rounded-lg border border-slate-200 dark:border-white/10 text-slate-600 dark:text-slate-300 peer-checked:bg-red-50 peer-checked:text-red-700 peer-checked:border-red-200 dark:peer-checked:bg-red-900/20 dark:peer-checked:text-red-400 transition-all font-medium">
                                        Gasto</div>
                                </label>
                            </div>
                        </div>

                        <!-- Doctor Selection -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Doctor Asignado</label>
                            <select id="tx-doctor" name="doctorId"
                                class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                                <option value="">-- Sin asignar / Cl√≠nica --</option>
                                <!-- JS WILL POPULATE DOCTORS -->
                            </select>
                        </div>

                        <!-- Category/Treatment -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Categor√≠a /
                                Tratamiento</label>
                            <select name="category"
                                class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                                <option value="General">Odontolog√≠a General</option>
                                <option value="Ortodoncia">Ortodoncia</option>
                                <option value="Implantes">Implantes</option>
                                <option value="Est√©tica">Est√©tica</option>
                                <option value="Cirug√≠a">Cirug√≠a</option>
                                <option value="Periodoncia">Periodoncia</option>
                                <option value="Otros">Otros (Alquiler, Luz, etc.)</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Concepto</label>
                            <input name="concept" required type="text" placeholder="Ej: Implante Unitario"
                                class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white dark:placeholder-slate-600">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Importe (‚Ç¨)</label>
                                <input name="amount" required type="number" step="0.01" placeholder="0.00"
                                    class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white dark:placeholder-slate-600">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Fecha</label>
                                <input name="date" required type="date"
                                    class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                            </div>
                        </div>

                        <!-- Cost Field (Hidden for Expenses, Optional for Income) -->
                        <div id="cost-field-container">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Coste Asociado (‚Ç¨)
                                <span class="text-[10px] lowercase font-normal text-slate-400">(Lab,
                                    Materiales...)</span></label>
                            <input name="cost" type="number" step="0.01" placeholder="0.00"
                                class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white dark:placeholder-slate-600">
                        </div>

                        <button type="submit"
                            class="mt-2 w-full bg-primary text-white font-bold py-3 rounded-xl shadow-lg shadow-primary/20 hover:bg-primary-dark transition-colors">Guardar</button>
                    </form>
                </div>
            </div>

            <!-- ANALYTICS VIEW (Managers Only) -->
            <div id="view-analytics" class="view-content w-full">
                <div class="p-3 md:p-4 flex flex-col gap-2 md:gap-3 pb-24 md:pb-4 max-w-7xl mx-auto">
                    <header>
                        <h2
                            class="text-2xl md:text-3xl font-bold text-slate-900 dark:text-white tracking-tight font-serif">
                            Anal√≠tica
                            Avanzada</h2>
                        <p class="text-slate-500 dark:text-slate-400 mt-1">Visi√≥n estrat√©gica de rentabilidad y
                            m√°rgenes.
                        </p>
                    </header>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-2 md:gap-3">
                        <!-- Profit per Doctor Chart -->
                        <div class="card-elite p-4 md:p-6">
                            <h3
                                class="text-base md:text-lg font-bold text-slate-900 dark:text-white mb-2 md:mb-4 font-serif">
                                Rentabilidad por Doctor (Neto)
                            </h3>
                            <div style="position: relative; height: 200px; width: 100%;">
                                <canvas id="chart-profit-doctor"></canvas>
                            </div>
                        </div>

                        <!-- Margin per Treatment Chart -->
                        <div class="card-elite p-4 md:p-6">
                            <h3
                                class="text-base md:text-lg font-bold text-slate-900 dark:text-white mb-2 md:mb-4 font-serif">
                                Margen por Tratamiento (%)
                            </h3>
                            <div style="position: relative; height: 200px; width: 100%;">
                                <canvas id="chart-margin-treatment"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Time Period Selector -->
                    <div class="flex justify-end">
                        <div class="flex bg-slate-100 dark:bg-white/5 rounded-xl p-1 gap-1 shadow-inner h-fit">
                            <button onclick="switchAnalyticsPeriod('month')" id="btn-analytics-month"
                                class="analytics-period-filter active px-4 py-1.5 rounded-lg text-xs font-bold transition-all duration-300 shadow-sm bg-white text-slate-900 dark:bg-dark-surface dark:text-white">MES</button>
                            <button onclick="switchAnalyticsPeriod('quarter')" id="btn-analytics-quarter"
                                class="analytics-period-filter px-4 py-1.5 rounded-lg text-xs font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-all duration-300">TRIMESTRE</button>
                            <button onclick="switchAnalyticsPeriod('year')" id="btn-analytics-year"
                                class="analytics-period-filter px-4 py-1.5 rounded-lg text-xs font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-all duration-300">A√ëO</button>
                            <button onclick="switchAnalyticsPeriod('all')" id="btn-analytics-all"
                                class="analytics-period-filter px-4 py-1.5 rounded-lg text-xs font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-all duration-300">TODO</button>
                        </div>
                    </div>

                    <!-- STRATEGIC BI CARDS -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-2 md:gap-4">
                        <!-- Laboratorio Ratio -->
                        <div class="card-elite p-4 md:p-5 relative overflow-hidden group border-0 shadow-md">
                            <div id="ratio-lab-indicator" class="absolute left-0 top-0 w-1 h-full bg-orange-500"></div>
                            <div class="flex items-center gap-2 mb-2">
                                <span
                                    class="material-symbols-outlined text-orange-500 text-sm">precision_manufacturing</span>
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest font-sans">
                                    Ratio Laboratorio</p>
                            </div>
                            <p id="kpi-ratio-lab"
                                class="text-2xl font-medium text-slate-900 dark:text-white num-font tracking-tight">--%
                            </p>
                            <p id="kpi-ratio-lab-text" class="text-[9px] text-slate-500 mt-1 font-bold italic">
                                Cargando...</p>
                        </div>

                        <!-- EBITDA Estimado -->
                        <div class="card-elite p-4 md:p-5 relative overflow-hidden group border-0 shadow-md">
                            <div class="absolute left-0 top-0 w-1 h-full bg-emerald-500"></div>
                            <div class="flex items-center gap-2 mb-2">
                                <span
                                    class="material-symbols-outlined text-emerald-500 text-sm">account_balance_wallet</span>
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest font-sans">
                                    EBITDA Estimado</p>
                            </div>
                            <p id="kpi-ebitda"
                                class="text-2xl font-medium text-slate-900 dark:text-white num-font tracking-tight">‚Ç¨0
                            </p>
                            <p class="text-[9px] text-slate-500 mt-1 font-bold uppercase italic">Rentabilidad Operativa
                            </p>
                        </div>

                        <!-- Ticket Promedio -->
                        <div class="card-elite p-4 md:p-5 relative overflow-hidden group border-0 shadow-md">
                            <div class="absolute left-0 top-0 w-1 h-full bg-blue-500 font-serif"></div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="material-symbols-outlined text-blue-500 text-sm">receipt_long</span>
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest font-sans">
                                    Ticket Medio</p>
                            </div>
                            <p id="kpi-avg-ticket"
                                class="text-2xl font-medium text-slate-900 dark:text-white num-font tracking-tight">‚Ç¨0
                            </p>
                            <p class="text-[9px] text-slate-500 mt-1 font-bold italic">Por paciente √∫nico</p>
                        </div>

                        <!-- Mix de Pagos -->
                        <div class="card-elite p-3 md:p-4 border-0 shadow-md relative group">
                            <h3
                                class="text-[10px] font-bold text-slate-400 uppercase tracking-widest font-sans mb-3 text-center">
                                Mix de Pagos</h3>
                            <div style="position: relative; height: 80px; width: 100%;">
                                <canvas id="chart-payment-mix"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- MAIN ANALYTICS GRID -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- Revenue & Expense Trend -->
                        <div class="card-elite p-5 md:p-6 border-0 shadow-md h-[400px] flex flex-col">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-bold text-slate-900 dark:text-white font-serif">Historia de
                                    Ingresos y Gastos</h3>
                                <div class="flex items-center gap-3 text-[10px] font-bold uppercase">
                                    <div class="flex items-center gap-1"><span
                                            class="h-2 w-2 rounded-full bg-primary"></span> Ingresos</div>
                                    <div class="flex items-center gap-1"><span
                                            class="h-2 w-2 rounded-full bg-red-400"></span> Gastos</div>
                                </div>
                            </div>
                            <div class="flex-1 min-h-0">
                                <canvas id="chart-revenue-trend"></canvas>
                            </div>
                        </div>

                        <!-- Top Services Performance -->
                        <div class="card-elite p-5 md:p-6 border-0 shadow-md h-[400px] flex flex-col">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-6 font-serif">Tratamientos
                                m√°s Rentables</h3>
                            <div class="flex-1 min-h-0">
                                <canvas id="chart-top-services"></canvas>
                            </div>
                        </div>

                        <!-- Rentabilidad por Doctor -->
                        <div class="card-elite p-5 md:p-6 border-0 shadow-md h-[350px] flex flex-col">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-6 font-serif">Beneficio Neto
                                por Doctor</h3>
                            <div class="flex-1 min-h-0">
                                <canvas id="chart-profit-doctor"></canvas>
                            </div>
                        </div>

                        <!-- Flujo de Caja Mensual -->
                        <div class="card-elite p-5 md:p-6 border-0 shadow-md h-[350px] flex flex-col">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-6 font-serif">Flujo de Caja
                                (Cash Flow)</h3>
                            <div class="flex-1 min-h-0">
                                <canvas id="chart-cash-flow"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Integration Status -->
                    <div
                        class="bg-blue-50 dark:bg-blue-900/10 rounded-xl p-6 border border-blue-100 dark:border-blue-900/20 flex items-center justify-between">
                        <div>
                            <h3 class="text-base font-bold text-blue-900 dark:text-blue-100">Google Sheets Sync</h3>
                            <p class="text-xs text-blue-600 dark:text-blue-300" id="sync-status-text">Estado: No
                                configurado</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="relative flex h-3 w-3" id="sync-indicator">
                                <span
                                    class="absolute inline-flex h-full w-full rounded-full bg-slate-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-slate-500"></span>
                            </span>
                            <span class="text-xs font-bold text-slate-600 dark:text-slate-400"
                                id="sync-status-label">Desconectado</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SETTINGS VIEW -->
            <div id="view-settings" class="view-content w-full">
                <div class="p-6 md:p-10 max-w-4xl mx-auto flex flex-col gap-8">
                    <header>
                        <h2 class="text-2xl font-bold text-slate-900 dark:text-white font-serif">Configuraci√≥n</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Personaliza tu experiencia dental.</p>
                    </header>

                    <section class="flex flex-col gap-4">
                        <!-- CONNECTION STATUS CARD -->
                        <div
                            class="bg-white dark:bg-dark-surface rounded-xl p-6 border border-slate-100 dark:border-white/5 shadow-sm flex flex-col gap-6">
                            <div class="flex items-center justify-between flex-wrap gap-4">
                                <div class="flex flex-col gap-1">
                                    <h3 class="text-base font-bold text-slate-900 dark:text-white">Conexi√≥n Google
                                        Sheets</h3>
                                    <p class="text-xs text-slate-500">Gesti√≥n de enlaces de sincronizaci√≥n.</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="resetSyncUrls()"
                                        class="p-2 text-slate-400 hover:text-red-500 transition-colors rounded-lg hover:bg-red-50"
                                        title="Restablecer valores por defecto">
                                        <span class="material-symbols-outlined text-sm">restart_alt</span>
                                    </button>
                                    <button onclick="toggleUrlEdit()"
                                        class="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/10 rounded-lg text-sm font-bold text-slate-700 dark:text-slate-300 transition-all">
                                        <span class="material-symbols-outlined text-sm">settings_ethernet</span>
                                        Configurar
                                    </button>
                                    <button onclick="syncFromSheets()" id="btn-sync-now"
                                        class="shrink-0 px-6 py-2 bg-primary text-white hover:bg-primary-dark rounded-xl text-sm font-bold transition-all flex flex-col items-center justify-center gap-1 shadow-lg shadow-primary/20">
                                        <div class="flex items-center gap-2">
                                            <span class="material-symbols-outlined text-sm" id="sync-icon">sync</span>
                                            <span id="sync-text">Sincronizar</span>
                                        </div>
                                    </button>
                                </div>
                                <p id="last-sync-label"
                                    class="w-full text-[10px] text-slate-400 font-bold mt-2 text-center bg-slate-100 dark:bg-white/5 py-1 rounded-md opacity-0 transition-opacity">
                                    --
                                </p>
                            </div>

                            <!-- HIDDEN EDIT PANEL -->
                            <div id="url-edit-panel"
                                class="hidden flex flex-col gap-4 pt-4 border-t border-slate-100 dark:border-white/5 animate-in fade-in slide-in-from-top-2">
                                <div class="flex flex-col gap-2">
                                    <label class="text-[10px] font-black uppercase tracking-wider text-slate-400">Enlace
                                        Ingresos (CSV)</label>
                                    <input type="password" id="sheets-url-input"
                                        placeholder="https://docs.google.com/spreadsheets/.../pub?output=csv"
                                        class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                                </div>
                                <div class="flex flex-col gap-2">
                                    <label class="text-[10px] font-black uppercase tracking-wider text-slate-400">Enlace
                                        Gastos (CSV)</label>
                                    <input type="password" id="expenses-url-input"
                                        placeholder="https://docs.google.com/spreadsheets/.../pub?output=csv"
                                        class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:border-primary focus:ring-primary dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                                </div>
                                <p class="text-[10px] text-amber-600 font-medium">‚ö†Ô∏è Los cambios se guardar√°n al pulsar
                                    el bot√≥n de Sincronizar fuera de este men√∫.</p>
                            </div>

                            <div
                                class="flex items-center justify-between p-3 rounded-lg bg-emerald-50 dark:bg-emerald-500/10 border border-emerald-100 dark:border-emerald-500/20">
                                <div class="flex items-center gap-3">
                                    <div class="h-2 w-2 rounded-full bg-emerald-500 animate-pulse"></div>
                                    <span class="text-xs font-bold text-emerald-700 dark:text-emerald-400">Estado:
                                        Configurado</span>
                                </div>
                                <span
                                    class="text-[10px] font-medium text-emerald-600 dark:text-emerald-500/70 italic">Protegido</span>
                            </div>
                        </div>

                        <div
                            class="bg-white dark:bg-dark-surface rounded-xl p-6 border border-slate-100 dark:border-white/5 shadow-sm flex items-center justify-between">
                            <div>
                                <h3 class="text-base font-bold text-slate-900 dark:text-white">Modo Oscuro</h3>
                                <p class="text-xs text-slate-500">Alternar entre tema claro y oscuro.</p>
                            </div>
                            <button onclick="document.documentElement.classList.toggle('dark')"
                                class="relative inline-flex h-6 w-11 items-center rounded-full bg-slate-200 dark:bg-primary transition-colors">
                                <span
                                    class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1 dark:translate-x-6"></span>
                            </button>
                        </div>

                        <div
                            class="bg-white dark:bg-dark-surface rounded-xl p-6 border border-slate-100 dark:border-white/5 shadow-sm flex items-center justify-between">
                            <div>
                                <h3 class="text-base font-bold text-red-600">Restablecer Datos</h3>
                                <p class="text-xs text-slate-500">Borrar todos los movimientos y empezar de cero.</p>
                            </div>
                            <button onclick="resetApp()"
                                class="px-4 py-2 bg-red-50 text-red-600 hover:bg-red-100 rounded-lg text-sm font-bold transition-colors">
                                Borrar Todo
                            </button>
                        </div>
                    </section>

                    <div class="text-center text-xs text-slate-400 mt-10">
                        Versi√≥n 1.0.0 ‚Ä¢ Cl√≠nica Lobato
                    </div>
                </div>
            </div>
    </div>

    <!-- EXPORT MODAL -->
    <div id="export-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" onclick="closeExportModal()">
        </div>
        <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm bg-white dark:bg-dark-surface rounded-2xl shadow-xl p-6 border border-slate-100 dark:border-white/10">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4 font-serif">Exportar a CSV</h3>
            <form onsubmit="handleExportCSV(event)" class="flex flex-col gap-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Desde</label>
                    <input name="startDate" required type="date"
                        class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Hasta</label>
                    <input name="endDate" required type="date"
                        class="w-full rounded-lg border-slate-200 bg-slate-50 px-3 py-2 text-sm dark:bg-[#0B0C10] dark:border-white/10 dark:text-white">
                </div>
                <div class="flex gap-2 mt-2">
                    <button type="button" onclick="closeExportModal()"
                        class="flex-1 py-2 text-slate-500 hover:bg-slate-50 dark:hover:bg-white/5 rounded-lg text-sm font-medium transition-colors">Cancelar</button>
                    <button type="submit"
                        class="flex-1 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-primary-dark transition-colors shadow-lg shadow-primary/20">Descargar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CHAT VIEW -->
    <!-- CHAT VIEW -->
    <!-- Chat Moved To Top of Main -->

    </main>

    <!-- FLOATING PILL NAVIGATION (Mobile Only - New Design) -->
    <!-- DOCK NAVIGATION (Mobile Only - iOS Native Feel) -->
    <nav
        class="md:hidden fixed bottom-0 w-full nav-float z-50 pb-[env(safe-area-inset-bottom)] border-t border-slate-200/50 dark:border-white/5">
        <div class="flex justify-around items-center h-16 px-1">
            <button onclick="switchTab('view-dashboard')" id="nav-mobile-dashboard"
                class="flex-1 flex flex-col items-center justify-center gap-1 h-full text-slate-400 dark:text-slate-500 transition-colors">
                <span class="material-symbols-outlined text-[26px]">grid_view</span>
            </button>

            <button onclick="switchTab('view-team')" id="nav-mobile-team"
                class="flex-1 flex flex-col items-center justify-center gap-1 h-full text-slate-400 dark:text-slate-500 transition-colors">
                <span class="material-symbols-outlined text-[26px]">groups</span>
            </button>

            <button onclick="switchTab('view-finance')" id="nav-mobile-finance"
                class="flex-1 flex flex-col items-center justify-center gap-1 h-full text-slate-400 dark:text-slate-500 transition-colors">
                <span class="material-symbols-outlined text-[26px]">payments</span>
            </button>

            <button onclick="switchTab('view-chat')" id="nav-mobile-chat"
                class="flex-1 flex flex-col items-center justify-center gap-1 h-full text-slate-400 dark:text-slate-500 transition-colors">
                <span class="material-symbols-outlined text-[26px]">smart_toy</span>
            </button>

            <button onclick="switchTab('view-settings')" id="nav-mobile-settings"
                class="flex-1 flex flex-col items-center justify-center gap-1 h-full text-slate-400 dark:text-slate-500 transition-colors">
                <span class="material-symbols-outlined text-[26px]">settings</span>
            </button>
        </div>
    </nav>

    <!-- Safe Area Padding for iPhone Home Indicator -->
    <style>
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
    </style>

    <script>
        // --- GEMINI API CONFIGURATION ---
        // ‚ö†Ô∏è IMPORTANTE: Reemplaza esto con tu API Key real de Google AI Studio
        const GEMINI_API_KEY = "TU_API_KEY_AQUI";

        const CHAT_HISTORY = [
            { role: "user", parts: [{ text: "Hola soy el Dr. Lobato." }] },
            { role: "model", parts: [{ text: "Hola Dr. Lobato. Soy tu asistente financiero dental. ¬øEn qu√© puedo ayudarte hoy?" }] }
        ];

        // --- UI LOGIC ---
        function switchTab(viewId) {
            // Handle both 'dashboard' and 'view-dashboard' inputs
            const targetId = viewId.startsWith('view-') ? viewId : `view-${viewId}`;
            const target = document.getElementById(targetId);

            if (!target) {
                console.error(`View not found: ${targetId}`);
                return;
            }

            // 1. Hide all views
            document.querySelectorAll('.view-content').forEach(el => {
                el.classList.remove('active');
            });

            // 2. Show target view
            target.classList.add('active');

            // 2.5 Scroll to top (Native behavior)
            window.scrollTo(0, 0);

            // 3. Update Desktop Navigation State
            const type = targetId.replace('view-', '');
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.className = "nav-item group flex items-center gap-3 rounded-lg px-4 py-3 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors text-left";
                const icon = btn.querySelector('.material-symbols-outlined');
                if (icon) icon.classList.remove('filled');
            });

            const activeDesktopBtn = document.getElementById(`nav-${type}`); // Changed from nav-desktop- to nav- for consistency if needed, but keeping nav-ID logic from HTML
            // Actually the HTML IDs are nav-dashboard, nav-analytics etc.
            // Let's check lines 157, 164 etc. IDs are "nav-dashboard", "nav-analytics".

            const navBtn = document.getElementById(`nav-${type}`);
            if (navBtn) {
                if (type === 'chat') {
                    navBtn.className = "nav-item group flex items-center gap-3 rounded-xl px-4 py-3.5 text-sm font-bold bg-gradient-to-r from-amber-500 to-amber-600 text-white shadow-lg shadow-amber-500/30 transition-all text-left";
                } else {
                    navBtn.className = "nav-item group flex items-center gap-3 rounded-lg bg-primary px-4 py-3 text-white shadow-md shadow-primary/20 transition-all text-left font-bold";
                }
                const icon = navBtn.querySelector('.material-symbols-outlined');
                if (icon) icon.classList.add('filled');
            }

            // 4. Update Mobile Navigation State (Dock Style)
            ['dashboard', 'team', 'finance', 'chat', 'settings'].forEach(t => {
                const btn = document.getElementById(`nav-mobile-${t}`);
                if (btn) {
                    btn.classList.remove('text-primary');
                    btn.classList.add('text-slate-400', 'dark:text-slate-500');
                    const icon = btn.querySelector('.material-symbols-outlined');
                    if (icon) icon.classList.remove('filled');
                }
            });

            const activeMobileBtn = document.getElementById(`nav-mobile-${type}`);
            if (activeMobileBtn) {
                activeMobileBtn.classList.remove('text-slate-400', 'dark:text-slate-500');
                activeMobileBtn.classList.add('text-primary');
                const icon = activeMobileBtn.querySelector('.material-symbols-outlined');
                if (icon) icon.classList.add('filled');
            }

            // 5. Refresh data ONLY for the active view (Lazy Rendering)
            if (type === 'dashboard') {
                window.switchTimeFilter(typeof CURRENT_TEAM_PERIOD !== 'undefined' ? CURRENT_TEAM_PERIOD : 'mes');
            } else if (type === 'finance') {
                renderTable();
            } else if (type === 'team') {
                renderTeam();
            } else if (type === 'analytics') {
                if (typeof renderAnalytics === 'function') renderAnalytics();
            }
        }

        // --- VOICE INPUT LOGIC (Web Speech API) ---
        let recognition;
        let isRecording = false;

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'es-ES'; // Detect Spanish

            recognition.onstart = function () {
                isRecording = true;
                document.getElementById('voice-status').style.opacity = '1';
                document.getElementById('mic-icon').classList.add('text-red-500', 'animate-pulse');
                document.getElementById('mic-icon').innerText = 'mic_off';
            };

            recognition.onend = function () {
                isRecording = false;
                document.getElementById('voice-status').style.opacity = '0';
                document.getElementById('mic-icon').classList.remove('text-red-500', 'animate-pulse');
                document.getElementById('mic-icon').innerText = 'mic';
            };

            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                const input = document.getElementById('chat-input');
                // Append or set text
                input.value = input.value ? input.value + " " + transcript : transcript;
                input.focus();
            };
        } else {
            console.log("Web Speech API not supported in this browser.");
            document.getElementById('mic-btn').style.display = 'none'; // Hide if not supported
        }

        function toggleVoiceInput() {
            if (!recognition) return alert("Tu navegador no soporta dictado por voz üò¢. Usa Chrome.");
            if (isRecording) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        // --- CHAT LOGIC ---
        async function handleSend() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            // 1. Add User Message to UI
            addMessageToUI(text, 'user');
            input.value = '';

            // 2. Mock or Call API
            addLoadingIndicator();

            try {
                // If API Key is placeholder, show simulated response
                if (GEMINI_API_KEY === "TU_API_KEY_AQUI") {
                    await new Promise(r => setTimeout(r, 1500)); // Simulate delay
                    removeLoadingIndicator();
                    addMessageToUI("‚ö†Ô∏è <b>Modo Demo:</b> Para que te responda de verdad, abre el archivo `03_index.html` con un editor de texto y pega tu API Key de Google (Gemini) en la l√≠nea 480 donde dice `const GEMINI_API_KEY = ...`", 'model');
                    addMessageToUI("ü§ñ <b>Respuesta Simulada:</b> Basado en tus datos, el Dr. Fernando ha facturado 12.500‚Ç¨ este mes.", 'model');
                } else {
                    // REAL CALL TO GEMINI API
                    const response = await callGeminiAPI(text);
                    removeLoadingIndicator();
                    addMessageToUI(response, 'model');
                }
            } catch (error) {
                removeLoadingIndicator();
                addMessageToUI("Error al conectar con la IA. Revisa tu conexi√≥n.", 'model');
                console.error(error);
            }
        }

        function addMessageToUI(text, role) {
            const chatContainer = document.querySelector("#view-chat .flex-1");
            const isUser = role === 'user';

            const div = document.createElement('div');
            div.className = isUser ? "flex justify-end items-end gap-3" : "flex justify-start items-end gap-3 max-w-2xl";

            const avatar = isUser ? '' : `
                <div class="size-8 rounded-full bg-primary flex items-center justify-center shrink-0 text-white">
                    <span class="material-symbols-outlined text-[18px]">smart_toy</span>
                </div>`;

            const bubbleStyle = isUser
                ? "bg-primary text-white p-4 rounded-2xl rounded-tr-none shadow-md max-w-xl"
                : "bg-white dark:bg-[#233540] p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 dark:border-slate-700";

            const textColor = isUser ? "" : "text-slate-800 dark:text-white";

            // Parse Basic Markdown for better readability
            let formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\n\n/g, '<br><br>') // Paragraphs
                .replace(/\n/g, '<br>'); // Line breaks

            div.innerHTML = `
                ${isUser ? '' : avatar}
                <div class="${bubbleStyle}">
                    <p class="text-sm leading-relaxed ${textColor}">${formattedText}</p>
                </div>
            `;

            chatContainer.appendChild(div);
            // Auto scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addLoadingIndicator() {
            const chatContainer = document.querySelector("#view-chat .flex-1");
            const div = document.createElement('div');
            div.id = "loading-indicator";
            div.className = "flex justify-start items-end gap-3 mt-4 opacity-70";
            div.innerHTML = `
                <div class="size-8 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center shrink-0 animate-pulse">
                    <span class="material-symbols-outlined text-[18px] text-slate-400">more_horiz</span>
                </div>
                <span class="text-xs text-slate-400">Pensando...</span>
            `;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeLoadingIndicator() {
            const loader = document.getElementById('loading-indicator');
            if (loader) loader.remove();
        }

        async function callGeminiAPI(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;

            const payload = {
                contents: [
                    ...CHAT_HISTORY, // Send history (simplified)
                    { role: "user", parts: [{ text: prompt }] }
                ]
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            const text = data.candidates[0].content.parts[0].text;

            // Add to local history
            CHAT_HISTORY.push({ role: "user", parts: [{ text: prompt }] });
            CHAT_HISTORY.push({ role: "model", parts: [{ text: text }] });

            return text; // Markdown parsed roughly
        }

        // Allow Enter key to send
        document.getElementById('chat-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                handleSend();
            }
        });

        // --- APP LOGIC (FULL - v2 ANALYTICS) ---
        // GLOBAL STATE VARIABLES
        let CURRENT_TEAM_PERIOD = 'mes';
        let CURRENT_FINANCE_TYPE = 'all';
        let searchDebounceTimer = null;
        let financeCategoryChart = null;
        let CURRENT_ANALYTICS_PERIOD = 'month';

        let APP_DATA = {
            transactions: [],
            doctors: [], // Start empty
            sheetsUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTc7OqZQYtGXYgqiBW3QR8FuTeG70vuUtzzVZGCNvQp5O_upc1kCZRRlVKIbnEso0sY053eWwC-0Efv/pub?gid=0&single=true&output=csv", // Ingresos
            expensesUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTc7OqZQYtGXYgqiBW3QR8FuTeG70vuUtzzVZGCNvQp5O_upc1kCZRRlVKIbnEso0sY053eWwC-0Efv/pub?gid=1425831012&single=true&output=csv" // Gastos
        };
        // Chart Variables
        let profitChartDash = null;
        let profitChartAdv = null;
        let marginChart = null;
        let paymentMixChart = null;
        let revenueTrendChart = null;
        let topServicesChart = null;
        let cashFlowChart = null;
        let profitDoctorChart = null;

        // === GEMINI AI INTEGRATION ===
        let geminiModel = null;

        // Initialize Gemini AI
        async function initGeminiAI() {
            try {
                const { GoogleGenerativeAI } = await import("@google/generative-ai");
                const genAI = new GoogleGenerativeAI("AIzaSyCzQNnljAJU_kWaDjGpR1tFfOBow8VH7HY");
                geminiModel = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                console.log("‚úÖ Gemini AI initialized");
            } catch (error) {
                console.error("‚ùå Gemini AI init error:", error);
            }
        }

        // Analyze financial anomalies with AI
        async function analyzeFinancialAnomaly() {
            if (!geminiModel) {
                console.log("‚è≥ Initializing Gemini AI...");
                await initGeminiAI();
            }

            try {
                const now = new Date();
                const thisMonth = now.getMonth();
                const thisYear = now.getFullYear();

                // Get this month's data
                const thisMonthData = APP_DATA.transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getMonth() === thisMonth && tDate.getFullYear() === thisYear;
                });

                // Get previous month's data
                const prevMonth = thisMonth === 0 ? 11 : thisMonth - 1;
                const prevYear = thisMonth === 0 ? thisYear - 1 : thisYear;
                const prevMonthData = APP_DATA.transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getMonth() === prevMonth && tDate.getFullYear() === prevYear;
                });

                // Calculate by category
                const categorizeData = (data) => {
                    const categories = {};
                    data.filter(t => t.type === 'gasto').forEach(t => {
                        const cat = t.category || 'General';
                        categories[cat] = (categories[cat] || 0) + parseFloat(t.amount);
                    });
                    return categories;
                };

                const thisMonthCats = categorizeData(thisMonthData);
                const prevMonthCats = categorizeData(prevMonthData);

                // Build prompt for Gemini
                const prompt = `Eres un analista financiero experto en cl√≠nicas dentales espa√±olas.

GASTOS MES ACTUAL:
${Object.entries(thisMonthCats).map(([cat, amt]) => `- ${cat}: ${amt.toFixed(0)}‚Ç¨`).join('\n')}

GASTOS MES ANTERIOR:
${Object.entries(prevMonthCats).map(([cat, amt]) => `- ${cat}: ${amt.toFixed(0)}‚Ç¨`).join('\n')}

INSTRUCCIONES:
1. Identifica la categor√≠a con MAYOR aumento porcentual (si es >15%)
2. Si no hay anomal√≠as significativas, sugiere una OPORTUNIDAD de mejora
3. Genera UNA alerta CORTA y ACCIONABLE (m√°ximo 15 palabras)
4. S√© ESPEC√çFICO con n√∫meros

FORMATO DE RESPUESTA (JSON puro, sin markdown):
{
  "alerta": "texto breve y accionable",
  "categoria": "nombre de la categor√≠a",
  "variacion": "+X%" o "sin anomal√≠as",
  "criticidad": "alta" o "media" o "baja"
}`;

                const result = await geminiModel.generateContent(prompt);
                const response = await result.response;
                let text = response.text();

                // Clean JSON from markdown
                text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

                const aiResponse = JSON.parse(text);

                // Update UI
                const alertText = document.querySelector('.ai-alert-text');
                if (alertText) {
                    alertText.innerHTML = aiResponse.alerta;
                }

                console.log('‚úÖ Gemini AI Alert:', aiResponse);
                return aiResponse;

            } catch (error) {
                console.error('‚ùå Gemini AI Error:', error);
                const alertText = document.querySelector('.ai-alert-text');
                if (alertText) {
                    alertText.innerHTML = 'Monitoreando datos financieros autom√°ticamente...';
                }
                return null;
            }
        }

        // === CHAT AI FUNCTIONALITY (OpenAI) ===
        window.handleSend = async function () {
            const input = document.getElementById('chat-input');
            const chatMessages = document.getElementById('chat-messages');

            if (!input || !chatMessages || !input.value.trim()) return;

            const userMessage = input.value.trim();
            input.value = '';

            // Add user message
            chatMessages.innerHTML += `
                <div class="flex justify-end items-end gap-3">
                    <div class="bg-primary text-white p-4 rounded-2xl rounded-tr-none shadow-md max-w-xl">
                        <p class="text-sm leading-relaxed">${userMessage}</p>
                    </div>
                </div>
            `;

            // Add loading
            chatMessages.innerHTML += `
                <div class="flex justify-start items-end gap-3 max-w-2xl" id="ai-loading">
                    <div class="size-8 rounded-full bg-primary flex items-center justify-center shrink-0 text-white">
                        <span class="material-symbols-outlined text-[18px]">smart_toy</span>
                    </div>
                    <div class="bg-white dark:bg-[#233540] p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 dark:border-slate-700">
                        <p class="text-sm text-slate-600">Analizando...</p>
                    </div>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                // Prepare financial context
                const now = new Date();
                const thisMonth = now.getMonth();
                const thisYear = now.getFullYear();
                const thisMonthData = APP_DATA.transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getMonth() === thisMonth && tDate.getFullYear() === thisYear;
                });

                const incomeThisMonth = thisMonthData.filter(t => t.type === 'ingreso').reduce((s, t) => s + parseFloat(t.amount), 0);
                const expensesThisMonth = thisMonthData.filter(t => t.type === 'gasto').reduce((s, t) => s + parseFloat(t.amount), 0);
                const doctors = APP_DATA.doctors.map(d => {
                    const docIncome = thisMonthData.filter(t => t.doctorId === d.id && t.type === 'ingreso').reduce((s, t) => s + parseFloat(t.amount), 0);
                    return { name: d.name, income: docIncome, goal: d.goal || 0 };
                });

                const financialSummary = `Ingresos mes actual: ${incomeThisMonth.toFixed(0)}‚Ç¨, Gastos: ${expensesThisMonth.toFixed(0)}‚Ç¨. Doctores: ${doctors.map(d => `${d.name}: ${d.income.toFixed(0)}‚Ç¨ (objetivo: ${d.goal}‚Ç¨)`).join(', ')}.`;

                // RAG LITE: Inyectar historial de movimientos para que la IA conozca a los pacientes
                // Limitamos a 500 para tokens, priorizando las primeras (suelen ser las m√°s nuevas si el array est√° ordenado, si no, ordenamos por fecha desc)
                const sortedTx = [...APP_DATA.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
                // BACKOFF: Bajamos a 600 para evitar error 429 (Too Many Requests) en cuentas Tier 1
                const dbTx = sortedTx.slice(0, 600);
                const dbContext = dbTx.map(t => {
                    const docName = getDoctorName(t.doctorId) || 'N/A';
                    let details = [];
                    if (t.methods) {
                        if (t.methods.cash > 0) details.push(`Efec:${t.methods.cash}`);
                        if (t.methods.card > 0) details.push(`Tarj:${t.methods.card}`);
                        if (t.methods.finance > 0) details.push(`Fin:${t.methods.finance}`);
                    }
                    const paymentInfo = details.length > 0 ? ` [${details.join(' ')}]` : '';
                    const obsInfo = t.observation ? ` {Nota: ${t.observation}}` : '';

                    return `[${t.date}] ${t.patient || 'Paciente'} (${t.concept}) | Dr.${docName} | ${t.amount}‚Ç¨${paymentInfo}${obsInfo}`;
                }).join('\n');

                const context = `RESUMEN KPI: ${financialSummary}\n\nBBDD MOVIMIENTOS (Historial Completo):\n${dbContext}`;

                // --- MEMORIA DEL CHAT ---
                // Inicializar si no existe
                if (!window.chatHistory) window.chatHistory = [];

                // Call backend endpoint sending history
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: userMessage,
                        context: context,
                        conversationHistory: window.chatHistory // ‚úÖ Enviando memoria
                    })
                });

                // Guardar mensaje usuario en historial
                window.chatHistory.push({ role: 'user', content: userMessage });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const aiAnswer = data.message;

                // Guardar respuesta IA en historial
                if (window.chatHistory) {
                    window.chatHistory.push({ role: 'assistant', content: aiAnswer });
                }

                document.getElementById('ai-loading').remove();
                chatMessages.innerHTML += `
                    <div class="flex justify-start items-end gap-3 max-w-2xl">
                        <div class="size-8 rounded-full bg-primary flex items-center justify-center shrink-0 text-white">
                            <span class="material-symbols-outlined text-[18px]">smart_toy</span>
                        </div>
                        <div class="bg-white dark:bg-[#233540] p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 dark:border-slate-700">
                            <p class="text-sm text-slate-800 dark:text-white">${aiAnswer}</p>
                        </div>
                    </div>
                `;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error('Chat error:', error);
                document.getElementById('ai-loading')?.remove();
                chatMessages.innerHTML += `<div class="flex justify-start items-end gap-3 max-w-2xl"><div class="size-8 rounded-full bg-primary flex items-center justify-center shrink-0 text-white"><span class="material-symbols-outlined text-[18px]">smart_toy</span></div><div class="bg-white dark:bg-[#233540] p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 dark:border-slate-700"><p class="text-sm text-red-600">Error. Intenta de nuevo.</p></div></div>`;
            }
        };

        // 1. STATE MANAGEMENT
        async function loadData() {
            const DEFAULT_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTc7OqZQYtGXYgqiBW3QR8FuTeG70vuUtzzVZGCNvQp5O_upc1kCZRRlVKIbnEso0sY053eWwC-0Efv/pub?gid=0&single=true&output=csv";

            const saved = localStorage.getItem('DENTAL_APP_DATA_V2');
            if (saved) {
                const parsed = JSON.parse(saved);
                // Mezclamos para asegurar que si la URL guardada est√° vac√≠a, use la default
                APP_DATA = { ...APP_DATA, ...parsed };
                if (!APP_DATA.sheetsUrl || APP_DATA.sheetsUrl === "") {
                    APP_DATA.sheetsUrl = DEFAULT_URL;
                }

                // Si detectamos que los datos guardados son los mock iniciales (ID 101),
                // y tenemos una URL real, intentamos sincronizar autom√°ticamente una vez.
                const isMock = APP_DATA.transactions.some(t => t.id === 101);
                if (isMock) {
                    console.log("Mock data detected with real URL. Syncing...");
                    await syncFromSheets(true);
                } else {
                    // Si ya tenemos datos reales pero recargamos, marcamos como sincronizado
                    updateSyncUI('success');
                }

                // RESTORE TAB LOGIC
                const restoreTab = localStorage.getItem('TAB_RESTORE');
                if (restoreTab) {
                    localStorage.removeItem('TAB_RESTORE'); // One-time use
                    // Format check: view-settings -> settings
                    const tabName = restoreTab.replace('view-', '');
                    switchTab(tabName);
                }

                // RESTORE SYNC DATE
                const lastSync = localStorage.getItem('LAST_SYNC');
                if (lastSync) {
                    const date = new Date(lastSync);
                    const label = document.getElementById('last-sync-label');
                    if (label) {
                        label.innerText = "Actualizado: " + date.toLocaleDateString() + " " + date.toLocaleTimeString().slice(0, 5);
                        label.classList.remove('opacity-0');
                    }
                }
            } else {
                // Si es la primera vez y ya definimos la URL arriba
                if (APP_DATA.sheetsUrl) {
                    console.log("Detectada URL de Sheets, iniciando sync inicial...");
                    await syncFromSheets(true); // true = silent mode (no alerts)
                } else {
                    initializeMockData();
                }
            }

            populateDoctorDropdown();
        }

        function loadSettings() {
            const urlInput = document.getElementById('sheets-url-input');
            const expInput = document.getElementById('expenses-url-input');

            if (urlInput) {
                urlInput.value = APP_DATA.sheetsUrl || "";
            }
            if (expInput) {
                expInput.value = APP_DATA.expensesUrl || "";
            }

            // Update protected label
            const label = document.querySelector('#view-settings .bg-emerald-50 div span');
            if (label) {
                const configured = (APP_DATA.sheetsUrl && APP_DATA.sheetsUrl.length > 5);
                label.innerText = configured ? "Estado: Todo Configurado" : "Estado: Pendiente";
            }
        }

        function initializeMockData() {
            APP_DATA.doctors = [
                { id: 1, name: "Dr. Fernando", role: "Implantes", goal: 15000, color: "blue" },
                { id: 2, name: "Dra. Carla", role: "Ortodoncia", goal: 14000, color: "purple" }
            ];

            // Hybrid Data: Manual + "Sheet"
            APP_DATA.transactions = [
                // Manual Entries
                { id: 101, date: "2023-10-24", concept: "Implante Unitario", amount: 1200.00, cost: 300.00, type: "ingreso", doctorId: 1, category: "Implantes", source: "manual" },
                { id: 102, date: "2023-10-23", concept: "Ortodoncia Invisible (Pago 1)", amount: 4500.00, cost: 1200.00, type: "ingreso", doctorId: 2, category: "Ortodoncia", source: "manual" },

                // Mock "Google Sheet" Imports
                { id: 201, date: "2023-10-22", concept: "[SHEET] Compra Material Quir√∫rgico", amount: 1500.00, cost: 0, type: "gasto", doctorId: null, category: "Otros", source: "sheet" },
                { id: 202, date: "2023-10-20", concept: "[SHEET] Factura Luz Endesa", amount: 250.00, cost: 0, type: "gasto", doctorId: null, category: "Otros", source: "sheet" },
                { id: 203, date: "2023-10-18", concept: "[SHEET] Limpieza Bucal", amount: 60.00, cost: 10.00, type: "ingreso", doctorId: 1, category: "General", source: "sheet" }
            ];
            saveData();
        }

        function saveData() {
            localStorage.setItem('DENTAL_APP_DATA_V2', JSON.stringify(APP_DATA));

            // Only refresh the currently active view (Performance Optimization)
            const activeView = document.querySelector('.view-content.active');
            if (activeView) {
                const viewType = activeView.id.replace('view-', '');

                if (viewType === 'dashboard') {
                    if (typeof switchTimeFilter === 'function') {
                        switchTimeFilter(typeof CURRENT_TEAM_PERIOD !== 'undefined' ? CURRENT_TEAM_PERIOD : 'mes');
                    } else {
                        updateDashboard();
                        renderTeam();
                    }
                } else if (viewType === 'finance') {
                    renderTable();
                } else if (viewType === 'team') {
                    renderTeam();
                } else if (viewType === 'analytics') {
                    if (typeof renderAnalytics === 'function') renderAnalytics();
                }
            } else {
                // Fallback: if no active view detected, update dashboard (initial load)
                if (typeof switchTimeFilter === 'function') {
                    switchTimeFilter(typeof CURRENT_TEAM_PERIOD !== 'undefined' ? CURRENT_TEAM_PERIOD : 'mes');
                } else {
                    updateDashboard();
                }
            }
        }

        // --- GOOGLE SHEETS SYNC LOGIC (Async Parallel) ---
        function convertToCSV(url) {
            if (!url) return "";
            let s = url.trim();
            // If already CSV, return as is
            if (s.includes('output=csv')) return s;

            // If it's a pubhtml link, convert to CSV
            if (s.includes('/pubhtml')) {
                return s.replace('/pubhtml', '/pub?output=csv');
            }

            // If it's a standard spreadsheet link, attempt to convert to export
            if (s.includes('docs.google.com/spreadsheets/d/')) {
                const parts = s.split('/');
                const idIndex = parts.indexOf('d') + 1;
                if (idIndex > 0 && idIndex < parts.length) {
                    const id = parts[idIndex];
                    // Clean extra params if any
                    const cleanId = id.split('?')[0].split('#')[0];
                    return `https://docs.google.com/spreadsheets/d/${cleanId}/pub?output=csv`;
                }
            }
            return s;
        }

        window.syncFromSheets = async function (silent = false) {
            console.log("Iniciando sincronizaci√≥n completa...");
            const urlInput = document.getElementById('sheets-url-input');
            const expInput = document.getElementById('expenses-url-input');

            // 1. Get URLs and auto-convert
            let rawUrl = urlInput ? urlInput.value.trim() : APP_DATA.sheetsUrl;
            let rawExpUrl = expInput ? expInput.value.trim() : APP_DATA.expensesUrl;

            // FALLBACKS
            if (!rawUrl || rawUrl === "") rawUrl = APP_DATA.sheetsUrl;
            if (!rawExpUrl || rawExpUrl === "") rawExpUrl = APP_DATA.expensesUrl;

            const url = convertToCSV(rawUrl);
            const expUrl = convertToCSV(rawExpUrl);

            // 2. Validate Main URL
            if (!url || !url.includes('output=csv')) {
                if (!silent) alert("Error: La URL de INGRESOS no es v√°lida. Aseg√∫rate de publicar la hoja como CSV.");
                updateSyncUI('error');
                return false;
            }

            APP_DATA.sheetsUrl = url;
            APP_DATA.expensesUrl = expUrl;  // Save expenses URL too

            updateSyncUI('loading');

            // 3. Fetch Both URLs with Timeout Protection
            const promises = [fetchCSVWithTimeout(url)];
            // Fetch expenses if valid CSV link
            if (expUrl && expUrl.includes('output=csv')) {
                promises.push(fetchCSVWithTimeout(expUrl));
            }

            try {
                const results = await Promise.all(promises);
                const incomeData = results[0];
                const expenseData = results.length > 1 ? results[1] : [];

                if ((!incomeData || incomeData.length === 0) && (!expenseData || expenseData.length === 0)) {
                    throw new Error("No se encontraron registros en ninguna de las hojas.");
                }

                processSheetsData(incomeData || [], expenseData || []);
                updateSyncUI('success');
                saveData();

                // Save Sync Date
                const now = new Date();
                localStorage.setItem('LAST_SYNC', now.toISOString());
                const label = document.getElementById('last-sync-label');
                if (label) {
                    label.innerText = "Actualizado: " + now.toLocaleDateString() + " " + now.toLocaleTimeString().slice(0, 5);
                    label.classList.remove('opacity-0');
                }

                if (!silent) alert("Sincronizaci√≥n completada con √©xito ‚úÖ");
                return true;
            } catch (error) {
                console.error("Sync Error Details:", error);

                // Categorize error for better user feedback
                let userMessage = "Error desconocido";

                if (error.message && error.message.includes('Timeout')) {
                    userMessage = error.message; // Already has clear message
                } else if (error.message && (error.message.includes('not defined') || error.message.includes('undefined'))) {
                    userMessage = "Error de JavaScript. Por favor, recarga la p√°gina (F5).";
                } else if (error.message && error.message.includes('network')) {
                    userMessage = "Error de conexi√≥n. Verifica tu internet.";
                } else if (error.message && (error.message.includes('CORS') || error.message.includes('No \'Access-Control'))) {
                    userMessage = "Las hojas de Google no est√°n publicadas correctamente. Ve a Archivo > Compartir > Publicar en la web.";
                } else if (error.message) {
                    userMessage = error.message;
                }

                updateSyncUI('error');
                if (!silent) alert(`Fallo en la sincronizaci√≥n: ${userMessage}`);
                return false;
            }
        }

        function fetchCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => resolve(results.data),
                    error: (err) => reject(err)
                });
            });
        }

        function fetchCSVWithTimeout(url, timeout = 15000) {
            return Promise.race([
                fetchCSV(url),
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Timeout: La sincronizaci√≥n tard√≥ demasiado. Verifica tu conexi√≥n a internet.')), timeout)
                )
            ]);
        }

        function processSheetsData(incomeData, expenseData) {
            // CLEAR OLD DOCTORS to avoid duplicates from mock data
            APP_DATA.doctors = [];

            // 1. First Pass: Discovery & Smart Role Assignment
            // We scan all rows to find unique doctors and analyze their work patterns
            const detectedDoctors = new Map(); // Name -> { name, concepts: [], total: 0 }

            incomeData.forEach(row => {
                const dentistKey = Object.keys(row).find(k => k.toLowerCase().includes('dentista') || k.toLowerCase().includes('doctor')) || 'Dentista';
                if (!row[dentistKey] || row[dentistKey].trim() === '' || row[dentistKey].toLowerCase() === 'cl√≠nica' || row[dentistKey].toLowerCase().includes('total')) return;
                const name = row[dentistKey].trim().toUpperCase(); // Normalize

                if (!detectedDoctors.has(name)) {
                    detectedDoctors.set(name, { name, concepts: [], total: 0 });
                }

                const entry = detectedDoctors.get(name);
                const conceptKey = Object.keys(row).find(k => k.toLowerCase().includes('concepto')) || 'Concepto';
                const totalKey = Object.keys(row).find(k => k.toLowerCase() === 'total' || k.toLowerCase().includes('importe')) || 'Total';

                if (row[conceptKey]) entry.concepts.push(row[conceptKey].toLowerCase());
                if (row[totalKey]) entry.total += cleanNumber(row[totalKey]);
            });

            // 2. Update Doctors List intelligently
            detectedDoctors.forEach((stats, name) => {
                // Check if doctor already exists
                let doctor = APP_DATA.doctors.find(d => d.name.toUpperCase() === name);

                if (!doctor) {
                    // NEW DOCTOR DETECTED!
                    const role = inferSpecialty(stats.concepts);
                    const color = assignColor(APP_DATA.doctors.length);

                    // Default goal logic: Scale based on volume? For now static.
                    const goal = 10000;

                    const newDoc = {
                        id: Date.now() + Math.floor(Math.random() * 1000),
                        name: properCase(name),
                        role: role,
                        goal: goal,
                        color: color
                    };
                    APP_DATA.doctors.push(newDoc);
                    console.log(`[Auto-Discovery] Created profile for: ${newDoc.name} (${newDoc.role})`);
                } else {
                    // AUTO-UPDATE: Re-check specialty based on new data logic
                    const detectedRole = inferSpecialty(stats.concepts);
                    // Only update if finding something specific (prefer not to downgrade to 'General' if manually set)
                    if (detectedRole !== 'General') {
                        doctor.role = detectedRole;
                    }
                }
            });

            // 3. Create Transactions (INCOME)
            // Mapeo espec√≠fico para tus columnas:
            // Fecha, Dentista, Paciente, Concepto, Efectivo, Tarjeta, Financiaci√≥n, Laboratorio, Observaci√≥n, Total
            const importedIncome = incomeData
                .filter(row => {
                    const amountKey = Object.keys(row).find(k => k.toLowerCase() === 'total' || k.toLowerCase().includes('importe'));
                    const amount = cleanNumber(row[amountKey]);

                    // Excluir filas de TOTAL (resumen del Excel)
                    const dentistKey = Object.keys(row).find(k => k.toLowerCase().includes('dentista') || k.toLowerCase().includes('doctor')) || 'Dentista';
                    if (row[dentistKey] && row[dentistKey].toLowerCase().includes('total')) return false;

                    // Permitir valores negativos (devoluciones) y ceros (revisiones gratuitas)
                    // Solo filtrar si NO es un n√∫mero v√°lido (NaN)
                    return !isNaN(amount);
                })
                .map((row, index) => {
                    const dateKey = Object.keys(row).find(k => k.toLowerCase().includes('fecha') || k.toLowerCase().includes('date')) || 'Fecha';
                    const amountKey = Object.keys(row).find(k => k.toLowerCase() === 'total' || k.toLowerCase().includes('importe'));
                    const costKey = Object.keys(row).find(k => k.toLowerCase().includes('laboratorio') || k.toLowerCase().includes('coste')) || 'Laboratorio';
                    const dentistKey = Object.keys(row).find(k => k.toLowerCase().includes('dentista') || k.toLowerCase().includes('doctor')) || 'Dentista';
                    const patientKey = Object.keys(row).find(k => k.toLowerCase().includes('paciente') || k.toLowerCase().includes('patient')) || 'Paciente';
                    const conceptKey = Object.keys(row).find(k => k.toLowerCase().includes('concepto') || k.toLowerCase().includes('concept')) || 'Concepto';

                    // Columnas extra para IA
                    const cashKey = Object.keys(row).find(k => k.toLowerCase().includes('efectivo') || k.toLowerCase().includes('cash'));
                    const cardKey = Object.keys(row).find(k => k.toLowerCase().includes('tarjeta') || k.toLowerCase().includes('card'));
                    const financeKey = Object.keys(row).find(k => k.toLowerCase().includes('financia'));
                    const obsKey = Object.keys(row).find(k => k.toLowerCase().includes('observa') || k.toLowerCase().includes('nota'));

                    const amount = cleanNumber(row[amountKey]);
                    const cost = cleanNumber(row[costKey]);

                    const concept = row[conceptKey] ? row[conceptKey] : (row[patientKey] ? `Paciente: ${row[patientKey]}` : "Tratamiento");

                    return {
                        id: Date.now() + index,
                        date: convertToISODate(row[dateKey]),
                        concept: concept,
                        patient: row[patientKey] || '',
                        // Detalles completos para IA
                        methods: {
                            cash: cashKey ? cleanNumber(row[cashKey]) : 0,
                            card: cardKey ? cleanNumber(row[cardKey]) : 0,
                            finance: financeKey ? cleanNumber(row[financeKey]) : 0
                        },
                        observation: obsKey ? (row[obsKey] || '') : '',

                        amount: amount,

                        cost: cost,
                        type: "ingreso",
                        doctorId: findDoctorIdByName(row[dentistKey]),
                        category: "General",
                        source: "sheet"
                    };
                });

            // 4. Create Transactions (EXPENSES)
            // Assumed headers: Fecha, Concepto, Importe, Categoria (optional)
            const importedExpenses = expenseData
                .filter(row => {
                    const amountKey = Object.keys(row).find(k => k.toLowerCase().includes('importe') || k.toLowerCase().includes('total'));
                    const amount = cleanNumber(row[amountKey]);
                    return amount > 0;
                })
                .map((row, index) => {
                    const dateKey = Object.keys(row).find(k => k.toLowerCase().includes('fecha') || k.toLowerCase().includes('date')) || 'Fecha';
                    const amountKey = Object.keys(row).find(k => k.toLowerCase().includes('importe') || k.toLowerCase().includes('total'));
                    const conceptKey = Object.keys(row).find(k => k.toLowerCase().includes('concepto') || k.toLowerCase().includes('concept')) || 'Concepto';
                    const catKey = Object.keys(row).find(k => k.toLowerCase().includes('categoria') || k.toLowerCase().includes('category')) || 'Categoria';

                    const amount = cleanNumber(row[amountKey]);
                    return {
                        id: Date.now() + index + 500000, // Different range to avoid conflicts with income
                        date: convertToISODate(row[dateKey]),
                        concept: row[conceptKey] || "Gasto Operativo",
                        amount: amount,
                        cost: 0, // Expenses don't have cost
                        doctorId: null, // Expenses not assigned to doctor
                        type: "gasto",
                        category: row[catKey] || "Operativo",
                        source: "sheet"
                    };
                });

            APP_DATA.transactions = [...importedIncome, ...importedExpenses];

            // Force UI update for dropdowns
            populateDoctorDropdown();
        }

        // --- HELPER FUNCTIONS FOR AI LOGIC ---

        function inferSpecialty(concepts) {
            const text = concepts.join(' ').toLowerCase();

            // Contadores por especialidad
            const scores = {
                'Ortodoncia': 0,
                'Endodoncia': 0,
                'Higiene': 0,
                'Est√©tica': 0,
                'Cirug√≠a': 0,
                'Implantolog√≠a': 0,
                'Pr√≥tesis': 0,
                'Periodoncia': 0
            };

            // Ortodoncia (puntajes altos para keywords espec√≠ficas)
            if (text.match(/ortodoncia|invisalign|bracket|alineador|f√©rula|aparato|retenci√≥n/)) scores['Ortodoncia'] += 10;

            // Endodoncia
            if (text.match(/endodoncia|conducto|pulpectom√≠a|desvitalizaci√≥n|Lima/)) scores['Endodoncia'] += 10;

            // Higiene dental
            if (text.match(/limpieza|profilaxis|tartrectom√≠a|mantenimiento periodontal|higiene bucal/)) scores['Higiene'] += 10;
            if (text.match(/curetaje|raspado|alisado radicular/)) scores['Periodoncia'] += 8;

            // Est√©tica dental
            if (text.match(/blanque[a-z]*|carilla|composite|est√©tica|reconstrucci√≥n est√©tica/)) scores['Est√©tica'] += 10;

            // Cirug√≠a (separado de implantolog√≠a)
            if (text.match(/extracci√≥n|exodoncia|cirug√≠a|quiste|biopsia|frenectom√≠a/)) scores['Cirug√≠a'] += 10;

            // Implantolog√≠a (espec√≠fico para implantes)
            if (text.match(/implante|osteointegraci√≥n|carga inmediata/)) scores['Implantolog√≠a'] += 10;
            if (text.match(/elevaci√≥n.*seno|regeneraci√≥n √≥sea/)) scores['Implantolog√≠a'] += 8;

            // Pr√≥tesis
            if (text.match(/pr√≥tesis|corona|puente|dentadura|removible|sobredentadura/)) scores['Pr√≥tesis'] += 10;
            if (text.match(/metal.*porcelana|zirconio|ceramic/)) scores['Pr√≥tesis'] += 5;

            // Periodoncia
            if (text.match(/periodoncia|enc√≠a|gingivitis|periodontitis/)) scores['Periodoncia'] += 10;

            // Encontrar la especialidad con mayor puntuaci√≥n
            let maxScore = 0;
            let specialty = 'General';

            for (const [key, value] of Object.entries(scores)) {
                if (value > maxScore) {
                    maxScore = value;
                    specialty = key;
                }
            }

            return specialty;
        }

        function assignColor(index) {
            const palette = ['blue', 'purple', 'emerald', 'amber', 'rose', 'cyan', 'indigo', 'orange'];
            return palette[index % palette.length];
        }

        function properCase(str) {
            let name = str.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
            // Enforce "Dr." prefix
            if (!name.startsWith("Dr.")) {
                const isFemale = name.endsWith("a"); // Heuristic
                name = (isFemale ? "Dra. " : "Dr. ") + name;
            }
            return name;
        }

        function convertToISODate(dateStr) {
            if (!dateStr) return new Date().toISOString().split('T')[0];

            // Handle different formats
            // 1. DD/MM/YYYY (Spanish default in Sheets)
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    // Pad with leading zeros
                    const day = parts[0].padStart(2, '0');
                    const month = parts[1].padStart(2, '0');
                    const year = parts[2];
                    // Handle 2 digit years if necessary (though usually Sheets gives 4)
                    const fullYear = year.length === 2 ? `20${year}` : year;
                    return `${fullYear}-${month}-${day}`;
                }
            }

            // 2. YYYY-MM-DD
            if (dateStr.includes('-')) return dateStr;

            return dateStr;
        }

        function cleanNumber(val) {
            if (typeof val === 'number') return val;
            if (!val || val === "") return 0;
            // Handle European format: 1.250,50 -> 1250.50
            // 1. Remove dots (thousands)
            // 2. Replace comma with dot (decimal)
            let s = val.toString().trim();
            if (s.includes(',') && s.includes('.')) {
                // If both present, dots are likely thousands
                s = s.replace(/\./g, '').replace(',', '.');
            } else if (s.includes(',')) {
                // If only comma, it's decimal
                s = s.replace(',', '.');
            }
            return parseFloat(s) || 0;
        }

        function findDoctorIdByName(name) {
            if (!name || name.toLowerCase() === 'cl√≠nica') return null;
            const normalizedSearch = name.trim().toLowerCase();
            // Fuzzy search: check if doctor name includes the search term or vice versa
            const doc = APP_DATA.doctors.find(d => {
                const dName = d.name.toLowerCase();
                return dName.includes(normalizedSearch) || normalizedSearch.includes(dName.replace('dr. ', '').replace('dra. ', '').trim());
            });
            return doc ? doc.id : null;
        }

        function updateSyncUI(status) {
            const text = document.getElementById('sync-status-text');
            const label = document.getElementById('sync-status-label');
            const indicator = document.getElementById('sync-indicator');
            const btn = document.getElementById('btn-sync-now');
            const btnIcon = document.getElementById('sync-icon');
            const btnText = document.getElementById('sync-text');

            if (!label || !indicator) return;

            switch (status) {
                case 'loading':
                    if (text) text.innerText = "Sincronizando con Google Sheets...";
                    label.innerText = "Cargando";
                    indicator.innerHTML = '<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span>';
                    if (btn) {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                    if (btnIcon) btnIcon.classList.add('animate-spin');
                    if (btnText) btnText.innerText = "Cargando...";
                    break;
                case 'success':
                    if (text) text.innerText = "√öltima sincronizaci√≥n: " + new Date().toLocaleTimeString();
                    label.innerText = "Sincronizado";
                    indicator.innerHTML = '<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>';
                    if (btn) {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                    if (btnIcon) btnIcon.classList.remove('animate-spin');
                    if (btnText) btnText.innerText = "Sincronizar";
                    break;
                case 'error':
                    if (text) text.innerText = "Error en la √∫ltima sincronizaci√≥n";
                    label.innerText = "Error";
                    indicator.innerHTML = '<span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>';
                    if (btn) {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                    if (btnIcon) btnIcon.classList.remove('animate-spin');
                    if (btnText) btnText.innerText = "Reintentar";
                    break;
            }
        }

        window.resetSyncUrls = function () {
            if (confirm("¬øQuieres restablecer las URLs de conexi√≥n a los valores por defecto?")) {
                APP_DATA.sheetsUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTc7OqZQYtGXYgqiBW3QR8FuTeG70vuUtzzVZGCNvQp5O_upc1kCZRRlVKIbnEso0sY053eWwC-0Efv/pub?gid=0&single=true&output=csv";
                APP_DATA.expensesUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTc7OqZQYtGXYgqiBW3QR8FuTeG70vuUtzzVZGCNvQp5O_upc1kCZRRlVKIbnEso0sY053eWwC-0Efv/pub?gid=1425831012&single=true&output=csv";
                saveData();
                loadSettings();
                alert("URLs restablecidas. Pulsa 'Sincronizar' para aplicar.");
            }
        }

        window.toggleUrlEdit = function () {
            const panel = document.getElementById('url-edit-panel');
            panel.classList.toggle('hidden');
        }

        // FINANCE VIEW LOGIC
        // CURRENT_FINANCE_TYPE moved to global scope at top of file

        window.debouncedRenderTable = function () {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => renderTable(), 300); // Wait 300ms after last keystroke
        }

        window.switchFinanceType = function (type) {
            CURRENT_FINANCE_TYPE = type;
            document.querySelectorAll('.fin-type-filter').forEach(btn => {
                btn.classList.remove('active', 'bg-white', 'text-slate-900', 'shadow-sm', 'dark:bg-dark-surface', 'dark:text-white', 'font-bold');
                btn.classList.add('text-slate-500', 'hover:text-slate-700', 'dark:text-slate-400');
                btn.classList.add('font-medium');
            });
            const activeBtn = document.getElementById(`btn-fin-${type}`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-white', 'text-slate-900', 'shadow-sm', 'dark:bg-dark-surface', 'dark:text-white', 'font-bold');
                activeBtn.classList.remove('text-slate-500', 'hover:text-slate-700', 'dark:text-slate-400', 'font-medium');
            }
            renderTable();
        }


        // financeCategoryChart is now declared globally at top of file

        function updateFinanceCategoryChart(transactions) {
            const canvas = document.getElementById('chart-finance-categories');
            if (!canvas) return;

            // Calculate category totals
            const categories = {};
            transactions.forEach(t => {
                const cat = t.category || 'Otros';
                categories[cat] = (categories[cat] || 0) + t.amount;
            });

            const labels = Object.keys(categories);
            const data = Object.values(categories);
            const total = data.reduce((sum, v) => sum + v, 0);

            const isDark = document.documentElement.classList.contains('dark');
            const colorText = isDark ? '#94a3b8' : '#64748b';

            const colors = [
                '#C69C6D', // Gold
                '#A87F55', // Dark gold
                '#7044bf', // Purple
                '#31165d', // Dark purple
                '#10b981', // Emerald
                '#ef4444', // Red
                '#f59e0b', // Amber
                '#3b82f6'  // Blue
            ];

            if (financeCategoryChart) financeCategoryChart.destroy();
            financeCategoryChart = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0,
                        hoverOffset: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: colorText,
                                font: { family: 'Manrope', size: 11 },
                                padding: 12,
                                usePointStyle: true,
                                generateLabels: function (chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return {
                                                text: `${label} (${percent}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = context.parsed;
                                    const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${value.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 })} (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        window.toggleFinanceFilters = function () {
            const panel = document.getElementById('finance-filters-panel');
            const btn = document.getElementById('btn-toggle-filters');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                btn.classList.add('bg-primary/10', 'border-primary/30', 'text-primary');
            } else {
                panel.classList.add('hidden');
                btn.classList.remove('bg-primary/10', 'border-primary/30', 'text-primary');
            }
        }

        window.clearFinanceFilters = function () {
            document.getElementById('filter-date-start').value = '';
            document.getElementById('filter-date-end').value = '';
            document.getElementById('search-input').value = '';
            renderTable();
        }

        function renderTable(resetPage = false) {
            // Reset pagination if filters changed
            if (resetPage) {
                window.financeCurrentPage = 1;
            }

            const tbody = document.getElementById('finance-table-body');
            const mobileList = document.getElementById('finance-mobile-list');
            const searchVal = document.getElementById('search-input')?.value.toLowerCase() || "";
            const dateStart = document.getElementById('filter-date-start')?.value;
            const dateEnd = document.getElementById('filter-date-end')?.value;

            if (tbody) tbody.innerHTML = '';
            if (mobileList) mobileList.innerHTML = '';

            let filtered = APP_DATA.transactions;

            // 1. Filter by Type
            if (CURRENT_FINANCE_TYPE !== 'all') {
                filtered = filtered.filter(t => t.type === CURRENT_FINANCE_TYPE);
            }

            // 2. Filter by Dates
            if (dateStart || dateEnd) {
                filtered = filtered.filter(t => {
                    const tDate = t.date; // "YYYY-MM-DD"
                    let match = true;
                    if (dateStart && tDate < dateStart) match = false;
                    if (dateEnd && tDate > dateEnd) match = false;
                    return match;
                });
            }

            // 3. Filter by Search (accent-insensitive)
            if (searchVal) {
                const normalizeText = (text) => text.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
                const normalizedSearch = normalizeText(searchVal);
                filtered = filtered.filter(t =>
                    normalizeText(t.concept).includes(normalizedSearch) ||
                    (t.category && normalizeText(t.category).includes(normalizedSearch)) ||
                    normalizeText(getDoctorName(t.doctorId)).includes(normalizedSearch)
                );
            }

            // 4. Calculate Totals for KPIs (based on search/date filters)
            let totalIncome = 0;
            let totalExpenses = 0;

            filtered.forEach(t => {
                if (t.type === 'ingreso') totalIncome += parseFloat(t.amount);
                else if (t.type === 'gasto') totalExpenses += parseFloat(t.amount);
            });

            const netValue = totalIncome - totalExpenses;

            // Update KPI DOM
            const kpiInc = document.getElementById('finance-kpi-income');
            const kpiExp = document.getElementById('finance-kpi-expenses');
            const kpiNet = document.getElementById('finance-kpi-net');

            if (kpiInc) kpiInc.innerText = totalIncome.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
            if (kpiExp) kpiExp.innerText = totalExpenses.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
            if (kpiNet) {
                kpiNet.innerText = (netValue >= 0 ? '+' : '') + netValue.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
                kpiNet.className = `text-sm md:text-2xl font-bold mt-0.5 md:mt-1 font-serif truncate ${netValue >= 0 ? 'text-primary' : 'text-red-500'}`;
            }

            // NEW: Calculate transaction statistics
            // NEW: Calculate transaction statistics (CORREGIDO: L√≥gica financiera real)
            // 1. Flujo Neto (Ingresos - Gastos)
            const total = filtered.reduce((sum, t) => sum + (t.type === 'gasto' ? -t.amount : t.amount), 0);

            // 2. Ticket Medio (Solo INGRESOS, ignorar gastos para no desvirtuar)
            const incomeTx = filtered.filter(t => t.type === 'ingreso');
            const avg = incomeTx.length > 0 ? incomeTx.reduce((s, t) => s + t.amount, 0) / incomeTx.length : 0;

            // 3. Mayor Ingreso (Solo INGRESOS)
            const largest = incomeTx.length > 0 ? Math.max(...incomeTx.map(t => t.amount)) : 0;

            const count = filtered.length;

            const statTotal = document.getElementById('stat-total-amount');
            const statAvg = document.getElementById('stat-avg-amount');
            const statLargest = document.getElementById('stat-largest-amount');
            const statCount = document.getElementById('stat-count');

            if (statTotal) {
                statTotal.innerText = (total >= 0 ? '+' : '') + total.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
                statTotal.className = `text-2xl font-bold font-serif ${total >= 0 ? 'text-indigo-900 dark:text-indigo-100' : 'text-red-600 dark:text-red-400'}`;
            }
            if (statAvg) statAvg.innerText = avg.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
            if (statLargest) statLargest.innerText = largest.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
            if (statCount) statCount.innerText = count;

            // NEW: Category breakdown chart
            updateFinanceCategoryChart(filtered);

            // 5. Sort and Render
            filtered = filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            // PAGINATION: Show only first 10 by default for faster loading
            const ITEMS_PER_PAGE = 10;
            const totalItems = filtered.length;
            const currentPage = window.financeCurrentPage || 1;
            const startIndex = 0; // Always show from start
            const endIndex = currentPage * ITEMS_PER_PAGE;
            const paginatedData = filtered.slice(startIndex, endIndex);
            const hasMore = endIndex < totalItems;

            paginatedData.forEach(t => {
                const isIngreso = t.type === 'ingreso';
                const color = isIngreso ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-500 dark:text-red-400';
                const sign = isIngreso ? '+' : '-';
                const sourceIcon = t.source === 'sheet' ? '<span class="material-symbols-outlined text-[14px] text-blue-500 dark:text-blue-400" title="Importado de Sheets">table_view</span>' : '';

                // Desktop Row
                if (tbody) {
                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-50 dark:hover:bg-white/5 transition-colors border-b border-slate-100 dark:border-white/5 last:border-0">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-white font-serif">${new Date(t.date).toLocaleDateString()}</td>
                            <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-300 flex items-center gap-2">
                                 ${sourceIcon}
                                 <div>
                                     <p class="font-medium text-slate-900 dark:text-white">${t.concept}</p>
                                     <p class="text-[10px] text-slate-400">${t.category || 'General'} ‚Ä¢ ${getDoctorName(t.doctorId)}</p>
                                 </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold ${color}">${sign} ${parseFloat(t.amount).toFixed(2)}‚Ç¨</td>
                            <td class="px-6 py-4 text-center">
                                <button onclick="deleteTransaction(${t.id})" class="text-slate-400 hover:text-red-500 transition-colors"><span class="material-symbols-outlined text-[20px]">delete</span></button>
                            </td>
                        </tr>`;
                }

                // Mobile Card (Stacked Layout)
                if (mobileList) {
                    mobileList.innerHTML += `
                        <div class="p-4 flex flex-col gap-3 bg-white dark:bg-dark-surface">
                            <!-- Row 1: Date & Concept -->
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex flex-col gap-0.5 overflow-hidden">
                                     <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">${new Date(t.date).toLocaleDateString()}</span>
                                     <p class="font-bold text-slate-900 dark:text-white text-sm leading-tight truncate">${t.concept}</p>
                                </div>
                                ${sourceIcon}
                            </div>

                            <!-- Row 2: Category, Doctor, Amount, Delete -->
                            <div class="flex items-center justify-between">
                                <div class="flex flex-col">
                                    <span class="text-[10px] text-slate-500 dark:text-slate-400 truncate max-w-[120px]">${t.category || 'General'}</span>
                                    <span class="text-[10px] text-slate-400 truncate max-w-[120px]">${getDoctorName(t.doctorId)}</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-base font-black font-serif ${color}">${sign}${parseFloat(t.amount).toFixed(0)}‚Ç¨</span>
                                    <button onclick="deleteTransaction(${t.id})" class="text-slate-300 hover:text-red-500 p-1 rounded-full hover:bg-slate-50 dark:hover:bg-white/5 transition-colors"><span class="material-symbols-outlined text-[20px]">delete</span></button>
                                </div>
                            </div>
                        </div>`;
                }
            });

            // Add pagination info and load more button (both mobile AND desktop)
            const paginationHTML = hasMore ? `
                <div class="text-center py-4 border-t border-slate-200 dark:border-white/10">
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-2">Mostrando ${endIndex} de ${totalItems} transacciones</p>
                    <button onclick="loadMoreTransactions()" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-primary-dark transition-all">
                        Cargar m√°s
                    </button>
                </div>
            ` : (totalItems > ITEMS_PER_PAGE ? `
                <div class="text-center py-4 border-t border-slate-200 dark:border-white/10">
                    <p class="text-xs text-slate-500 dark:text-slate-400">Mostrando todas las ${totalItems} transacciones</p>
                </div>
            ` : '');

            if (mobileList) {
                mobileList.innerHTML += paginationHTML;
            }
            if (tbody && paginationHTML) {
                // Add after desktop table
                const tableContainer = tbody.closest('.card-elite');
                if (tableContainer) {
                    const existingPagination = tableContainer.querySelector('.pagination-container');
                    if (existingPagination) existingPagination.remove();
                    const paginationDiv = document.createElement('div');
                    paginationDiv.className = 'pagination-container';
                    paginationDiv.innerHTML = paginationHTML;
                    tableContainer.appendChild(paginationDiv);
                }
            }

            // Reset page counter when filters change (search/date)
            // This happens automatically because we check window.financeCurrentPage || 1
        }

        window.loadMoreTransactions = function () {
            window.financeCurrentPage = (window.financeCurrentPage || 1) + 1;
            renderTable();
        }

        window.resetFinancePagination = function () {
            window.financeCurrentPage = 1;
        }

        function handleAddTransaction(e) {
            e.preventDefault();
            const form = e.target;
            APP_DATA.transactions.unshift({
                id: Date.now(),
                type: form.type.value,
                concept: form.concept.value,
                amount: parseFloat(form.amount.value),
                date: form.date.value,
                doctorId: form.doctorId.value ? parseInt(form.doctorId.value) : null,
                category: form.category.value,
                cost: form.cost.value ? parseFloat(form.cost.value) : 0,
                source: "manual"
            });
            saveData();
            renderTable();
            closeModal();
            form.reset();
            form.date.value = new Date().toISOString().split('T')[0];
            toggleCostField(false); // Reset UI
        }

        function toggleCostField(isExpense) {
            const container = document.getElementById('cost-field-container');
            if (isExpense) {
                container.style.display = 'none'; // Expenses don't have "costs" in this simple model, they ARE the cost.
            } else {
                container.style.display = 'block';
            }
        }

        function deleteTransaction(id) {
            if (confirm("¬øEliminar este movimiento?")) {
                APP_DATA.transactions = APP_DATA.transactions.filter(t => t.id !== id);
                saveData();
                renderTable();
            }
        }

        // Helper
        function getDoctorName(id) {
            if (!id) return 'Cl√≠nica';
            const doc = APP_DATA.doctors.find(d => d.id === id);
            return doc ? doc.name : 'Desconocido';
        }

        function populateDoctorDropdown() {
            const select = document.getElementById('tx-doctor');
            if (!select) return;
            select.innerHTML = '<option value="">-- Sin asignar / Cl√≠nica --</option>';
            APP_DATA.doctors.forEach(d => {
                select.innerHTML += `<option value="${d.id}">${d.name}</option>`;
            });
        }



        function renderTeam() {
            const container = document.getElementById('doctors-container');
            if (!container) return;

            const periodData = calculatePeriodData(CURRENT_TEAM_PERIOD);
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Calculate previous period for trends
            const prevPeriodData = calculatePreviousPeriodData(CURRENT_TEAM_PERIOD);

            // Calculate days remaining for projections
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const daysPassed = now.getDate();
            const daysLeft = daysInMonth - daysPassed;

            container.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-xl font-bold text-slate-900 dark:text-white font-serif">Auditor√≠a de Rendimiento</h3>
                        <p class="text-xs text-slate-400 mt-1">An√°lisis de productividad individual por <span class="capitalize font-bold text-primary">${CURRENT_TEAM_PERIOD}</span></p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 xl:grid-cols-2 gap-4">
            `;

            periodData.team.forEach((doc, index) => {
                const progress = Math.min((doc.generated / doc.goal) * 100, 100).toFixed(0);

                // Trend logic
                const prevDoc = prevPeriodData.team.find(d => d.id === doc.id);
                const prevGenerated = prevDoc ? prevDoc.generated : 0;
                const trend = prevGenerated > 0 ? ((doc.generated - prevGenerated) / prevGenerated) * 100 : 0;
                const trendIcon = trend >= 0 ? 'trending_up' : 'trending_down';
                const trendColor = trend >= 0 ? 'text-emerald-500' : 'text-red-500';

                // Real efficiency: Unique Patients vs Transactions
                const doctorTransactions = APP_DATA.transactions.filter(t =>
                    t.doctorId === doc.id &&
                    t.type === 'ingreso' &&
                    isInPeriod(t.date, CURRENT_TEAM_PERIOD)
                );

                const uniquePatients = new Set(doctorTransactions.map(t => (t.patient || 'Anon').trim().toLowerCase())).size;
                const avgTicket = uniquePatients > 0 ? doc.generated / uniquePatients : 0;

                // Goal pacing logic
                const expectedProgress = CURRENT_TEAM_PERIOD === 'mes' ? (daysPassed / daysInMonth) * 100 : 100;
                const isBehind = progress < expectedProgress * 0.8;
                const statusLabel = progress >= 100 ? 'Objetivo Logrado' : isBehind ? 'Bajo el ritmo' : 'En ritmo';
                const statusColorClass = progress >= 100 ? 'bg-emerald-500' : isBehind ? 'bg-amber-500' : 'bg-primary';

                // Rank badges
                const rankBadges = ["ü•á", "ü•à", "ü•â"];
                const rankBadge = index < 3 && doc.generated > 0 ? rankBadges[index] : "";

                container.innerHTML += `
                    <div class="card-elite p-5 md:p-6 border-0 shadow-lg relative overflow-hidden group hover:scale-[1.01] transition-all">
                        <!-- Top Header -->
                        <div class="flex items-start justify-between mb-6 relative z-10">
                            <div class="flex items-center gap-4">
                                <div class="size-12 md:size-14 rounded-2xl bg-gradient-to-br from-slate-100 to-slate-200 dark:from-white/10 dark:to-white/5 flex items-center justify-center text-xl md:text-2xl font-serif font-black text-slate-700 dark:text-slate-200 shadow-inner relative">
                                    ${doc.name[0]}
                                    ${rankBadge ? `<span class="absolute -top-2 -right-2 text-lg drop-shadow-md">${rankBadge}</span>` : ''}
                                </div>
                                <div>
                                    <h4 class="text-base md:text-lg font-bold text-slate-900 dark:text-white font-serif leading-tight">${doc.name}</h4>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="text-[10px] font-black uppercase tracking-widest text-primary/70">${doc.role}</span>
                                        <span class="h-1 w-1 rounded-full bg-slate-300"></span>
                                        <span class="text-[10px] text-slate-400 font-bold">${doctorTransactions.length} visitas</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-xl md:text-2xl font-black text-slate-900 dark:text-white num-font">${doc.amount}</p>
                                <p class="flex items-center justify-end gap-1 text-[10px] font-bold ${trendColor} uppercase tracking-tighter">
                                    <span class="material-symbols-outlined text-xs">${trendIcon}</span>
                                    ${Math.abs(trend).toFixed(1)}% vs anterior
                                </p>
                            </div>
                        </div>

                        <!-- Main KPIs Grid -->
                        <div class="grid grid-cols-2 gap-3 mb-6 relative z-10">
                            <div class="bg-slate-50 dark:bg-white/5 p-3 rounded-xl border border-slate-100 dark:border-white/5">
                                <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Ticket / Paciente</p>
                                <p class="text-lg font-bold text-slate-900 dark:text-white num-font">${avgTicket.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 })}</p>
                            </div>
                            <div class="bg-slate-50 dark:bg-white/5 p-3 rounded-xl border border-slate-100 dark:border-white/5">
                                <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Pacientes √önicos</p>
                                <p class="text-lg font-bold text-slate-900 dark:text-white num-font">${uniquePatients}</p>
                            </div>
                        </div>

                        <!-- Progress Bar (Elite Design) -->
                        <div class="space-y-2 relative z-10">
                            <div class="flex justify-between items-end">
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-black text-slate-500 uppercase">Cumplimiento</span>
                                    <span class="px-2 py-0.5 rounded-full text-[9px] font-black text-white ${statusColorClass} uppercase">${statusLabel}</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-black text-slate-900 dark:text-white num-font">${progress}%</span>
                                    <p class="text-[9px] text-slate-400 font-bold">Objetivo: ${(doc.goal / 1000).toFixed(0)}k‚Ç¨</p>
                                </div>
                            </div>
                            <div class="h-2 w-full bg-slate-100 dark:bg-white/5 rounded-full overflow-hidden p-0.5 shadow-inner">
                                <div class="h-full ${statusColorClass} rounded-full transition-all duration-1000 shadow-lg" style="width: ${progress}%"></div>
                            </div>
                        </div>

                        <!-- Side Accent Color -->
                        <div class="absolute left-0 top-0 h-full w-1 ${statusColorClass} opacity-30"></div>
                    </div>
                `;
            });

            container.innerHTML += `</div>`; // Close grid

            // Update the global donut chart for the team
            updateTeamDonut(periodData.team);
        }

        // Helper function to check if date is in period
        function isInPeriod(dateStr, period) {
            const date = new Date(dateStr);
            const now = new Date();

            switch (period) {
                case 'hoy':
                    return date.toDateString() === now.toDateString();
                case 'ayer':
                    const yesterday = new Date(now);
                    yesterday.setDate(yesterday.getDate() - 1);
                    return date.toDateString() === yesterday.toDateString();
                case 'semana':
                    const weekAgo = new Date(now);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return date >= weekAgo && date <= now;
                case 'mes':
                    return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
                case 'a√±o':
                    return date.getFullYear() === now.getFullYear();
                default:
                    return true;
            }
        }

        // Helper to calculate previous period data for trends
        function calculatePreviousPeriodData(currentPeriod) {
            const now = new Date();
            let startDate, endDate;

            switch (currentPeriod) {
                case 'hoy':
                    startDate = new Date(now);
                    startDate.setDate(startDate.getDate() - 1);
                    endDate = startDate;
                    break;
                case 'ayer':
                    startDate = new Date(now);
                    startDate.setDate(startDate.getDate() - 2);
                    endDate = startDate;
                    break;
                case 'semana':
                    startDate = new Date(now);
                    startDate.setDate(startDate.getDate() - 14);
                    endDate = new Date(now);
                    endDate.setDate(endDate.getDate() - 7);
                    break;
                case 'a√±o':
                    startDate = new Date(now.getFullYear() - 1, 0, 1); // Jan 1 of last year
                    endDate = new Date(now.getFullYear() - 1, 11, 31); // Dec 31 of last year
                    break;
                case 'mes':
                default:
                    const prevMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
                    const prevYear = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
                    startDate = new Date(prevYear, prevMonth, 1);
                    endDate = new Date(prevYear, prevMonth + 1, 0);
                    break;
            }

            // Reuse existing calculatePeriodData logic but with custom date range
            const filtered = APP_DATA.transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate >= startDate && tDate <= endDate;
            });

            const team = APP_DATA.doctors.map(doc => {
                const docTransactions = filtered.filter(t => t.doctorId === doc.id && t.type === 'ingreso');
                const generated = docTransactions.reduce((sum, t) => sum + t.amount, 0);
                return {
                    id: doc.id,
                    name: doc.name,
                    generated: generated
                };
            });

            return { team };
        }

        function updateTeamDonut(teamData) {
            const donutEl = document.getElementById('team-donut-chart');
            const totalEl = document.getElementById('team-donut-total');
            const legendEl = document.getElementById('team-donut-legend');
            const labelEl = document.getElementById('team-donut-period-label');
            if (!donutEl || !totalEl || !legendEl || !labelEl) return;

            labelEl.textContent = CURRENT_TEAM_PERIOD;

            const totalCalculated = teamData.reduce((sum, d) => sum + d.generated, 0);
            totalEl.textContent = totalCalculated.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });

            if (totalCalculated === 0) {
                donutEl.style.background = 'rgba(0,0,0,0.05)';
                legendEl.innerHTML = '<p class="text-center text-xs text-slate-400 py-4">Sin producci√≥n en este periodo</p>';
                return;
            }

            let currentPercent = 0;
            const gradients = [];
            const colors = ['#C69C6D', '#A87F55', '#E5C4A0', '#8B6B4D', '#D4AF37', '#7044bf', '#31165d'];

            legendEl.innerHTML = '';

            teamData.forEach((doc, i) => {
                const p = (doc.generated / totalCalculated) * 100;
                if (p > 0) {
                    const color = colors[i % colors.length];
                    gradients.push(`${color} ${currentPercent}% ${currentPercent + p}%`);
                    currentPercent += p;

                    legendEl.innerHTML += `
                        <div class="flex items-center justify-between text-sm py-1 border-b border-slate-50 dark:border-white/5 last:border-0">
                            <span class="flex items-center gap-2">
                                <div class="h-2 w-2 rounded-full" style="background-color: ${color}"></div>
                                <span class="font-medium text-slate-600 dark:text-slate-400 text-xs">${doc.name}</span>
                            </span>
                            <span class="font-bold text-slate-900 dark:text-white text-xs">${p.toFixed(0)}%</span>
                        </div>
                    `;
                }
            });

            if (gradients.length > 0) {
                donutEl.style.background = `conic-gradient(${gradients.join(', ')})`;
            }
        }

        function handleAddDoctor(e) {
            e.preventDefault();
            const form = e.target;
            const colors = ['blue', 'purple']; // Simplified logic
            const randomColor = colors[Math.floor(Math.random() * colors.length)];

            APP_DATA.doctors.push({
                id: Date.now(),
                name: form.name.value,
                role: form.role.value,
                goal: parseFloat(form.goal.value),
                color: randomColor
            });
            saveData();
            closeDoctorModal();
            form.reset();
        }

        function deleteDoctor(id) {
            if (confirm("¬øEliminar doctor?")) {
                APP_DATA.doctors = APP_DATA.doctors.filter(d => d.id !== id);
                saveData();
            }
        }

        function openDoctorModal() {
            const m = document.getElementById('doctor-modal');
            m.classList.remove('hidden');
            setTimeout(() => document.getElementById('doctor-modal-content').classList.remove('scale-95', 'opacity-0'), 10);
        }
        function closeDoctorModal() {
            const m = document.getElementById('doctor-modal');
            const c = document.getElementById('doctor-modal-content');
            c.classList.add('scale-95', 'opacity-0');
            setTimeout(() => m.classList.add('hidden'), 200);
        }

        // 3.5 Render Analytics (New)
        window.switchAnalyticsPeriod = function (period) {
            CURRENT_ANALYTICS_PERIOD = period;
            document.querySelectorAll('.analytics-period-filter').forEach(btn => {
                btn.classList.remove('active', 'bg-white', 'text-slate-900', 'shadow-sm', 'dark:bg-dark-surface', 'dark:text-white', 'font-bold');
                btn.classList.add('text-slate-500', 'hover:text-slate-700', 'dark:text-slate-400', 'font-medium');
            });
            const activeBtn = document.getElementById(`btn-analytics-${period}`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-white', 'text-slate-900', 'shadow-sm', 'dark:bg-dark-surface', 'dark:text-white', 'font-bold');
                activeBtn.classList.remove('text-slate-500', 'hover:text-slate-700', 'dark:text-slate-400', 'font-medium');
            }
            renderAnalytics();
        }

        function getAnalyticsPeriodData() {
            const now = new Date();
            let startDate;

            switch (CURRENT_ANALYTICS_PERIOD) {
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'quarter':
                    const quarterMonth = Math.floor(now.getMonth() / 3) * 3;
                    startDate = new Date(now.getFullYear(), quarterMonth, 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                case 'all':
                default:
                    startDate = new Date(2000, 0, 1); // Far back enough
                    break;
            }

            const filtered = APP_DATA.transactions.filter(t => new Date(t.date) >= startDate);
            return filtered;
        }

        function renderAnalytics() {
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded');
                return;
            }

            const ctxDash = document.getElementById('chart-profit-dash');
            const ctxAdv = document.getElementById('chart-profit-doctor');
            const ctxMargin = document.getElementById('chart-margin-treatment');

            if (!ctxDash && !ctxAdv) return;

            // --- DYNAMIC LAST 6 MONTHS LABELS ---
            const today = new Date();
            const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
            const labels = [];
            const sixMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 5, 1);

            // Generate labels for the last 6 months
            for (let i = 0; i < 6; i++) {
                const d = new Date(sixMonthsAgo.getFullYear(), sixMonthsAgo.getMonth() + i, 1);
                labels.push(monthNames[d.getMonth()]);
            }

            // --- CALCULATE REAL DATA FOR THESE MONTHS ---
            const incomeData = [0, 0, 0, 0, 0, 0];
            const expenseData = [0, 0, 0, 0, 0, 0];

            APP_DATA.transactions.forEach(t => {
                const tDate = new Date(t.date); // This is UTC based on YYYY-MM-DD, fine for month extraction
                // Check if in range
                const monthDiff = (tDate.getFullYear() - sixMonthsAgo.getFullYear()) * 12 + (tDate.getMonth() - sixMonthsAgo.getMonth());
                if (monthDiff >= 0 && monthDiff < 6) {
                    if (t.type === 'ingreso') {
                        incomeData[monthDiff] += t.amount;
                    } else {
                        expenseData[monthDiff] += t.amount;
                    }
                }
            });

            const chartConfig = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Ingresos', data: incomeData, backgroundColor: '#C69C6D', borderRadius: 6 },
                        { label: 'Gastos', data: expenseData, backgroundColor: '#cbd5e1', borderRadius: 6 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 8 } },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { display: false, grid: { display: true, drawBorder: false } },
                        x: { grid: { display: false } }
                    }
                }
            };

            // 1. Dashboard Chart
            if (ctxDash) {
                if (profitChartDash) profitChartDash.destroy();
                profitChartDash = new Chart(ctxDash, chartConfig);
            }

            // 2. Advanced Analytics Chart
            if (ctxAdv) {
                if (profitChartAdv) profitChartAdv.destroy();
                profitChartAdv = new Chart(ctxAdv, chartConfig);
            }

            // 2. Margin Chart (Doughnut) - Mock Distribution
            if (ctxMargin) {
                const isDark = document.documentElement.classList.contains('dark');
                const colorText = isDark ? '#94a3b8' : '#64748b';

                if (marginChart) marginChart.destroy();
                marginChart = new Chart(ctxMargin, {
                    type: 'doughnut',
                    data: {
                        labels: ['Ortodoncia', 'Implantes', 'General', 'Est√©tica'],
                        datasets: [{
                            data: [35, 45, 15, 5],
                            backgroundColor: ['#C69C6D', '#A87F55', '#F3E7D7', '#334155'], // Gold Gradient & Dark Slate
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        cutout: '75%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: colorText,
                                    font: { family: 'Manrope', size: 12 },
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });
            }

            // --- STRATEGIC BI ANALYTICS (Elite) ---

            // 1. Get filtered data based on period
            const periodData = getAnalyticsPeriodData();
            const incomeTransactions = periodData.filter(t => t.type === 'ingreso');
            const expenseTransactions = periodData.filter(t => t.type === 'gasto');
            const totalIncome = incomeTransactions.reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = expenseTransactions.reduce((sum, t) => sum + t.amount, 0);
            const profitValue = totalIncome - totalExpenses;

            // 2. Unique Patients Ticket Mean
            const uniquePatients = new Set(incomeTransactions.map(t => (t.patient || 'Anon').trim().toLowerCase())).size;
            const avgTicket = uniquePatients > 0 ? totalIncome / uniquePatients : 0;

            // 3. Ratio de Laboratorio (KPI PRO)
            const labExpenses = expenseTransactions
                .filter(t => (t.category || '').toLowerCase().includes('lab') || (t.concept || '').toLowerCase().includes('lab'))
                .reduce((sum, t) => sum + t.amount, 0);

            // Prosthetic income heuristic (Orthodontics, Implants, General often require lab)
            const prostheticCategories = ['pr√≥tesis', 'implantes', 'est√©tica', 'ortodoncia'];
            const prostheticIncome = incomeTransactions
                .filter(t => prostheticCategories.some(kw => (t.category || '').toLowerCase().includes(kw)))
                .reduce((sum, t) => sum + t.amount, 0);

            const labRatio = prostheticIncome > 0 ? (labExpenses / prostheticIncome) * 100 : totalIncome > 0 ? (labExpenses / totalIncome) * 100 : 0;

            // Update UI: Lab Ratio
            const kpiRatioLab = document.getElementById('kpi-ratio-lab');
            const ratioLabText = document.getElementById('kpi-ratio-lab-text');
            const ratioIndicator = document.getElementById('ratio-lab-indicator');

            if (kpiRatioLab) kpiRatioLab.innerText = `${labRatio.toFixed(1)}%`;
            if (ratioLabText && ratioIndicator) {
                if (labRatio < 20) {
                    ratioLabText.innerText = 'Rango √ìptimo üíé';
                    ratioIndicator.className = 'absolute left-0 top-0 w-1 h-full bg-emerald-500';
                } else if (labRatio < 30) {
                    ratioLabText.innerText = 'Coste Aceptable';
                    ratioIndicator.className = 'absolute left-0 top-0 w-1 h-full bg-amber-500';
                } else {
                    ratioLabText.innerText = 'Revisar M√°rgenes ‚ö†Ô∏è';
                    ratioIndicator.className = 'absolute left-0 top-0 w-1 h-full bg-red-500';
                }
            }

            // 4. EBITDA & Ticket DOM
            const kpiEbitda = document.getElementById('kpi-ebitda');
            if (kpiEbitda) kpiEbitda.innerText = profitValue.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });

            const kpiAvg = document.getElementById('kpi-avg-ticket');
            if (kpiAvg) kpiAvg.innerText = avgTicket.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });

            // 5. Payment Mix Chart
            const paymentTotals = { cash: 0, card: 0, financing: 0 };
            incomeTransactions.forEach(t => {
                const concept = (t.concept || '').toLowerCase();
                const category = (t.category || '').toLowerCase();
                if (concept.includes('efectivo') || category.includes('efectivo')) paymentTotals.cash += t.amount;
                else if (concept.includes('finan') || category.includes('finan')) paymentTotals.financing += t.amount;
                else paymentTotals.card += t.amount;
            });

            const ctxPayment = document.getElementById('chart-payment-mix');
            if (ctxPayment) {
                if (paymentMixChart) paymentMixChart.destroy();
                paymentMixChart = new Chart(ctxPayment, {
                    type: 'doughnut',
                    data: {
                        labels: ['Efectivo', 'Tarjeta/Banco', 'Financiaci√≥n'],
                        datasets: [{
                            data: [paymentTotals.cash, paymentTotals.card, paymentTotals.financing],
                            backgroundColor: ['#A87F55', '#C69C6D', '#E5C4A0'],
                            borderWidth: 0
                        }]
                    },
                    options: { cutout: '70%', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }

            // 6. Trend Charts (Last 12 Months)
            const last12 = new Date(today.getFullYear(), today.getMonth() - 11, 1);
            const trendLabels = [];
            const trendIncome = Array(12).fill(0);
            const trendExpense = Array(12).fill(0);

            for (let i = 0; i < 12; i++) {
                const d = new Date(last12.getFullYear(), last12.getMonth() + i, 1);
                trendLabels.push(monthNames[d.getMonth()]);
            }

            APP_DATA.transactions.forEach(t => {
                const tDate = new Date(t.date);
                const monthDiff = (tDate.getFullYear() - last12.getFullYear()) * 12 + (tDate.getMonth() - last12.getMonth());
                if (monthDiff >= 0 && monthDiff < 12) {
                    if (t.type === 'ingreso') trendIncome[monthDiff] += t.amount;
                    else trendExpense[monthDiff] += t.amount;
                }
            });

            const ctxRevenue = document.getElementById('chart-revenue-trend');
            if (ctxRevenue) {
                if (revenueTrendChart) revenueTrendChart.destroy();
                revenueTrendChart = new Chart(ctxRevenue, {
                    type: 'line',
                    data: {
                        labels: trendLabels,
                        datasets: [
                            { label: 'Ingresos', data: trendIncome, borderColor: '#C69C6D', backgroundColor: 'rgba(198, 156, 109, 0.1)', tension: 0.4, fill: true, pointRadius: 2 },
                            { label: 'Gastos', data: trendExpense, borderColor: '#f87171', backgroundColor: 'rgba(248, 113, 113, 0.05)', tension: 0.4, fill: true, pointRadius: 0 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { grid: { color: 'rgba(0,0,0,0.03)' }, ticks: { font: { size: 10 } } }, x: { grid: { display: false }, ticks: { font: { size: 10 } } } }
                    }
                });
            }

            // 7. Top Services Performance
            const treatmentRevenueMap = {};
            incomeTransactions.forEach(t => {
                const cat = t.category || 'Otros';
                treatmentRevenueMap[cat] = (treatmentRevenueMap[cat] || 0) + t.amount;
            });
            const topServicesDataList = Object.entries(treatmentRevenueMap).sort((a, b) => b[1] - a[1]).slice(0, 5);

            const ctxServices = document.getElementById('chart-top-services');
            if (ctxServices) {
                if (topServicesChart) topServicesChart.destroy();
                topServicesChart = new Chart(ctxServices, {
                    type: 'bar',
                    data: {
                        labels: topServicesDataList.map(s => s[0]),
                        datasets: [{ data: topServicesDataList.map(s => s[1]), backgroundColor: '#C69C6D', borderRadius: 8 }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { grid: { display: false } }, y: { grid: { display: false } } }
                    }
                });
            }

            // 8. Profit per Doctor
            const doctorNetMap = {};
            periodData.forEach(t => {
                if (t.doctorId) {
                    doctorNetMap[t.doctorId] = (doctorNetMap[t.doctorId] || 0) + (t.type === 'ingreso' ? t.amount : -t.amount);
                }
            });
            const topDoctorsAnalytics = Object.entries(doctorNetMap).sort((a, b) => b[1] - a[1]);

            const ctxDoc = document.getElementById('chart-profit-doctor');
            if (ctxDoc) {
                if (profitDoctorChart) profitDoctorChart.destroy();
                profitDoctorChart = new Chart(ctxDoc, {
                    type: 'bar',
                    data: {
                        labels: topDoctorsAnalytics.map(d => getDoctorName(parseInt(d[0]))),
                        datasets: [{ data: topDoctorsAnalytics.map(d => d[1]), backgroundColor: '#818cf8', borderRadius: 8 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }

            // 9. Cash Flow Analysis
            const ctxCashAnalytic = document.getElementById('chart-cash-flow');
            if (ctxCashAnalytic) {
                const cashFlowValues = trendIncome.map((inc, i) => inc - trendExpense[i]);
                if (cashFlowChart) cashFlowChart.destroy();
                cashFlowChart = new Chart(ctxCashAnalytic, {
                    type: 'bar',
                    data: {
                        labels: trendLabels,
                        datasets: [{ data: cashFlowValues, backgroundColor: cashFlowValues.map(v => v >= 0 ? '#10b981' : '#f87171'), borderRadius: 6 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }
        }

        // 4. DASHBOARD LOGIC
        function updateDashboard(period = 'mes') {
            const data = calculatePeriodData(period);
            const income = data.income;
            const expenses = data.expenses;
            const profit = income - expenses;

            const kpiIncome = document.getElementById('kpi-income');
            const kpiProfit = document.getElementById('kpi-profit');
            const kpiMargin = document.getElementById('kpi-margin');

            const fmt = (v) => v.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });

            if (kpiIncome) kpiIncome.innerText = fmt(income);
            if (kpiProfit) {
                kpiProfit.innerText = fmt(profit);
                kpiProfit.className = `text-xl md:text-3xl font-medium tracking-tight num-font ${profit >= 0 ? 'text-slate-900 dark:text-white' : 'text-red-500'}`;
            }

            // Margin Logic (Traffic Light)
            if (kpiMargin) {
                const margin = income > 0 ? (profit / income) * 100 : 0;
                kpiMargin.innerText = `${margin.toFixed(1)}%`;

                const statusBadge = document.getElementById('margin-status-badge');
                const indicatorBg = document.getElementById('margin-indicator-bg');
                const iconBg = document.getElementById('margin-icon-bg');

                if (statusBadge && indicatorBg && iconBg) {
                    if (margin >= 25) {
                        statusBadge.innerText = '√ìptimo';
                        statusBadge.className = 'rounded-full bg-emerald-100 dark:bg-emerald-900/30 px-3 py-1 text-[10px] font-black text-emerald-700 dark:text-emerald-400 uppercase';
                        indicatorBg.className = 'absolute right-0 top-0 h-full w-2 bg-emerald-500/30';
                        iconBg.className = 'rounded-full bg-emerald-50 dark:bg-emerald-900/20 p-2 md:p-3 text-emerald-600 dark:text-emerald-400';
                    } else if (margin >= 15) {
                        statusBadge.innerText = 'Aceptable';
                        statusBadge.className = 'rounded-full bg-amber-100 dark:bg-amber-900/30 px-3 py-1 text-[10px] font-black text-amber-700 dark:text-amber-400 uppercase';
                        indicatorBg.className = 'absolute right-0 top-0 h-full w-2 bg-amber-500/30';
                        iconBg.className = 'rounded-full bg-amber-50 dark:bg-amber-900/20 p-2 md:p-3 text-amber-600 dark:text-amber-400';
                    } else {
                        statusBadge.innerText = 'Cr√≠tico';
                        statusBadge.className = 'rounded-full bg-red-100 dark:bg-red-900/30 px-3 py-1 text-[10px] font-black text-red-700 dark:text-red-400 uppercase';
                        indicatorBg.className = 'absolute right-0 top-0 h-full w-2 bg-red-500/30';
                        iconBg.className = 'rounded-full bg-red-50 dark:bg-red-900/20 p-2 md:p-3 text-red-600 dark:text-red-400';
                    }
                }
            }

            // Update Insights (Trends, Forecast, Fidelization)
            updateDashboardInsights(period);

            // Update Team Ranking
            renderTeamRanking(data.team);
        }

        function updateDashboardInsights(period) {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Get current month data
            const currentMonthData = APP_DATA.transactions.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });

            // Get previous month data
            const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            const prevMonthData = APP_DATA.transactions.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === prevMonth && d.getFullYear() === prevYear;
            });

            // Calculate current totals
            const currentIncome = currentMonthData.filter(t => t.type === 'ingreso').reduce((sum, t) => sum + t.amount, 0);
            const currentExpenses = currentMonthData.filter(t => t.type === 'gasto').reduce((sum, t) => sum + t.amount, 0);
            const currentProfit = currentIncome - currentExpenses;

            // Calculate previous totals for trends
            const prevIncome = prevMonthData.filter(t => t.type === 'ingreso').reduce((sum, t) => sum + t.amount, 0);
            const prevExpenses = prevMonthData.filter(t => t.type === 'gasto').reduce((sum, t) => sum + t.amount, 0);
            const prevProfit = prevIncome - prevExpenses;

            // TRENDS
            const incomeChange = prevIncome > 0 ? ((currentIncome - prevIncome) / prevIncome) * 100 : 0;
            const profitChange = prevProfit > 0 ? ((currentProfit - prevProfit) / prevProfit) * 100 : 0;

            const trendRevenue = document.getElementById('trend-revenue');
            const trendProfit = document.getElementById('trend-profit');

            if (trendRevenue) {
                trendRevenue.innerText = (incomeChange >= 0 ? '+' : '') + incomeChange.toFixed(0) + '%';
                trendRevenue.className = `rounded-full px-2 py-0.5 text-[10px] md:text-xs font-bold ${incomeChange >= 0 ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400' : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400'}`;
            }
            if (trendProfit) {
                trendProfit.innerText = (profitChange >= 0 ? '+' : '') + profitChange.toFixed(0) + '%';
                trendProfit.className = `rounded-full px-2 py-0.5 text-[10px] md:text-xs font-bold ${profitChange >= 0 ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400' : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400'}`;
            }

            // FORECAST
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const daysPassed = now.getDate();
            const avgPerDay = daysPassed > 0 ? currentIncome / daysPassed : 0;
            const projected = avgPerDay * daysInMonth;
            const progress = (daysPassed / daysInMonth) * 100;

            const projectionAmount = document.getElementById('projection-amount');
            const projectionProgress = document.getElementById('projection-progress');
            const projectionText = document.getElementById('projection-text');

            if (projectionAmount) projectionAmount.innerText = projected.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
            if (projectionProgress) projectionProgress.style.width = `${Math.min(progress, 100)}%`;
            if (projectionText) projectionText.innerText = `D√≠a ${daysPassed} de ${daysInMonth} ‚Ä¢ ${(avgPerDay / 1000).toFixed(1)}k‚Ç¨/d√≠a de media`;

            // FIDELIZACI√ìN (Nuevos vs Recurrentes)
            analyzeFidelization(currentMonthData);

            // BURN RATE
            const dailyBurn = daysPassed > 0 ? currentExpenses / daysPassed : 0;
            const burnrateDaily = document.getElementById('burnrate-daily');
            const burnrateInsight = document.getElementById('burnrate-insight');

            if (burnrateDaily) burnrateDaily.innerText = dailyBurn.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
            if (burnrateInsight) {
                const projectedMonthlyExpenses = dailyBurn * daysInMonth;
                burnrateInsight.innerText = `Previsi√≥n mes: ${projectedMonthlyExpenses.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 })}`;
            }
        }

        function analyzeFidelization(data) {
            const incomeTx = data.filter(t => t.type === 'ingreso');
            const patientMap = new Map();

            // Get all unique patience names and count current month first
            incomeTx.forEach(t => {
                if (t.patient) {
                    const name = t.patient.trim().toLowerCase();
                    patientMap.set(name, (patientMap.get(name) || 0) + 1);
                }
            });

            let newCount = 0;
            let recurringCount = 0;

            // Simple Logic: If patient appeared in ANY transaction before THIS month, they are recurring
            // To be accurate, we need to check ALL transactions in APP_DATA
            const now = new Date();
            const firstDayOfThisMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            patientMap.forEach((count, name) => {
                const isRecurring = APP_DATA.transactions.some(t => {
                    const tDate = new Date(t.date);
                    return t.patient && t.patient.trim().toLowerCase() === name && tDate < firstDayOfThisMonth;
                });

                if (isRecurring) recurringCount++;
                else newCount++;
            });

            // Update UI
            const elNew = document.getElementById('stats-patients-new');
            const elRec = document.getElementById('stats-patients-recurring');
            const barNew = document.getElementById('fidel-bar-new');
            const barRec = document.getElementById('fidel-bar-rec');
            const insight = document.getElementById('fidel-insight');

            if (elNew) elNew.innerText = newCount;
            if (elRec) elRec.innerText = recurringCount;

            const total = newCount + recurringCount;
            if (total > 0) {
                const pNew = (newCount / total) * 100;
                const pRec = (recurringCount / total) * 100;
                if (barNew) barNew.style.width = `${pNew}%`;
                if (barRec) barRec.style.width = `${pRec}%`;

                if (insight) {
                    if (pNew > 50) insight.innerText = "¬°Gran captaci√≥n de pacientes! üöÄ";
                    else if (pRec > 50) insight.innerText = "Excelente fidelizaci√≥n üíé";
                    else insight.innerText = "Equilibrio sano entre captaci√≥n y recurrencia";
                }
            } else {
                if (insight) insight.innerText = "Sin datos este mes";
            }
        }

        function renderTeamRanking(team) {
            const listEl = document.getElementById('team-ranking-list');
            if (!listEl) return;

            listEl.innerHTML = '';
            team.forEach((doc, index) => {
                const isLeader = index === 0 && doc.generated > 0;
                const leaderIcon = isLeader ? '<span class="material-symbols-outlined text-yellow-500 text-sm">emoji_events</span>' : '';
                const barColor = isLeader ? 'bg-primary' : 'bg-slate-300 dark:bg-slate-600';
                const avatarLetter = doc.name ? doc.name[0] : '?';

                listEl.innerHTML += `
                    <div class="flex items-center gap-4 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-white/5 transition-colors group">
                        <div class="h-10 w-10 shrink-0 rounded-full bg-slate-100 dark:bg-white/10 flex items-center justify-center font-serif font-bold text-slate-600 dark:text-slate-300 relative">
                            ${avatarLetter}
                            ${isLeader ? '<div class="absolute -top-1 -right-1 bg-white dark:bg-dark-surface rounded-full p-0.5 shadow-sm">' + leaderIcon + '</div>' : ''}
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-slate-900 dark:text-white text-sm">${doc.name}</span>
                                <span class="font-black text-slate-900 dark:text-white text-sm font-serif">${doc.amount}</span>
                            </div>
                            <div class="h-1.5 w-full bg-slate-100 dark:bg-white/10 rounded-full overflow-hidden">
                                <div class="h-full ${barColor} rounded-full" style="width: ${doc.percent}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // 5. EXPORT & SETTINGS LOGIC
        function openExportModal() {
            const modal = document.getElementById('export-modal');
            modal.classList.remove('hidden');
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.querySelector('#export-modal input[name="startDate"]').value = firstDay.toISOString().split('T')[0];
            document.querySelector('#export-modal input[name="endDate"]').value = today.toISOString().split('T')[0];
        }

        function closeExportModal() {
            document.getElementById('export-modal').classList.add('hidden');
        }

        function handleExportCSV(e) {
            e.preventDefault();
            const start = new Date(e.target.startDate.value);
            const end = new Date(e.target.endDate.value);

            const dataToExport = APP_DATA.transactions.filter(t => {
                const d = new Date(t.date);
                return d >= start && d <= end;
            });

            if (dataToExport.length === 0) return alert("No hay movimientos en esas fechas.");

            let csvContent = "data:text/csv;charset=utf-8,ID,Fecha,Concepto,Tipo,Importe\n";
            dataToExport.forEach(row => {
                csvContent += `${row.id},${row.date}, "${row.concept}", ${row.type},${row.amount} \n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `contabilidad_dental_${e.target.endDate.value}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            closeExportModal();
        }

        function resetApp() {
            if (confirm("‚ö†Ô∏è ¬øBORRAR TODO? Esta acci√≥n no se puede deshacer.")) {
                localStorage.removeItem('DENTAL_APP_DATA');
                localStorage.removeItem('DENTAL_APP_DATA_V2');
                localStorage.setItem('TAB_RESTORE', 'view-settings'); // Force return here
                location.reload();
            }
        }

        function openModal() {
            const modal = document.getElementById('transaction-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('modal-content').classList.remove('scale-95', 'opacity-0');
                document.getElementById('modal-content').classList.add('scale-100', 'opacity-100');
            }, 10);
            const dateInput = document.querySelector('input[name="date"]');
            if (dateInput && !dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];
        }

        function closeModal() {
            const modal = document.getElementById('transaction-modal');
            document.getElementById('modal-content').classList.remove('scale-100', 'opacity-100');
            document.getElementById('modal-content').classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        // 6. INITIALIZATION
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await loadData();
                renderTable();
                switchTimeFilter(CURRENT_TEAM_PERIOD);
                renderAnalytics();
                updateClock();
                loadSettings();

                // Setup chat input Enter key
                const chatInput = document.getElementById('chat-input');
                if (chatInput) {
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            if (window.handleSend) window.handleSend();
                        }
                    });
                }

                // AUTO-SYNC: Sincronizaci√≥n autom√°tica cada hora
                setInterval(async () => {
                    console.log('üîÑ Auto-sincronizaci√≥n programada ejecut√°ndose...');
                    if (window.syncFromSheets) {
                        await syncFromSheets(true); // true = silent mode (sin alertas)
                    }
                }, 60 * 60 * 1000); // 60 minutos = 1 hora

                console.log('‚úÖ Auto-sincronizaci√≥n configurada (cada 1 hora)');
            } catch (e) {
                console.error("Initialization error:", e);
            }
        });

        // --- REAL SMART DATE LOGIC ---
        function getPeriodDates(period) {
            const now = new Date();
            const start = new Date(now);
            const end = new Date(now);

            // Reset time to start/end of day
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 59, 999);

            switch (period) {
                case 'ayer':
                    start.setDate(now.getDate() - 1);
                    end.setDate(now.getDate() - 1);
                    break;
                case 'semana':
                    // Start of current week (Monday)
                    const day = now.getDay() || 7; // Get current day number, converting Sun(0) to 7
                    if (day !== 1) start.setHours(-24 * (day - 1));
                    break;
                case 'mes':
                    start.setDate(1); // 1st of current month
                    break;
                case 'a√±o':
                    start.setMonth(0, 1); // January 1st of current year
                    break;
                case 'hoy':
                default:
                    // Already set to today
                    break;
            }
            return { start, end };
        }

        function calculatePeriodData(period) {
            const { start, end } = getPeriodDates(period);

            // Normalize Date Objects to YYYY-MM-DD strings for comparison
            // IMPORTANT: use local time construction to avoid UTC shifts
            const fmt = (d) => {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const startStr = fmt(start);
            const endStr = fmt(end);

            // Filter Transactions
            const relevantTxs = APP_DATA.transactions.filter(t => {
                // t.date is already YYYY-MM-DD string from convertToISODate
                return t.date >= startStr && t.date <= endStr;
            });

            // Calculate Totals
            let income = 0;
            let expenses = 0;
            const docStats = {};

            // Init Doctors
            APP_DATA.doctors.forEach(d => {
                docStats[d.id] = { ...d, generated: 0 };
            });

            relevantTxs.forEach(t => {
                if (t.type === 'ingreso') {
                    income += parseFloat(t.amount);
                    if (t.doctorId && docStats[t.doctorId]) {
                        docStats[t.doctorId].generated += parseFloat(t.amount);
                    }
                } else {
                    expenses += parseFloat(t.amount);
                }
            });

            // Sort Team
            const team = Object.values(docStats)
                .sort((a, b) => b.generated - a.generated)
                .map(d => ({
                    ...d,
                    amount: d.generated.toLocaleString('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }), // Full Number
                    percent: (d.generated / (income || 1)) * 100 // Avoid divide by zero
                }));

            return {
                income: income, // Return raw numbers for later formatting
                expenses: expenses,
                team: team
            };
        }

        window.switchTimeFilter = function (period) {
            // 1. Update Buttons Visual State (Global)
            document.querySelectorAll('.time-filter, .team-time-filter').forEach(btn => {
                btn.classList.remove('active', 'bg-white', 'text-slate-900', 'shadow-sm', 'dark:bg-dark-surface', 'dark:text-white', 'font-bold');
                btn.classList.add('text-slate-500', 'hover:text-slate-700', 'dark:text-slate-400', 'font-medium');
            });

            // Activate buttons in both views if they exist
            const dashBtn = document.getElementById(`btn-${period}`);
            const teamBtn = document.getElementById(`btn-team-${period}`);

            [dashBtn, teamBtn].forEach(btn => {
                if (btn) {
                    btn.classList.add('active', 'bg-white', 'text-slate-900', 'shadow-sm', 'dark:bg-dark-surface', 'dark:text-white', 'font-bold');
                    btn.classList.remove('text-slate-500', 'hover:text-slate-700', 'dark:text-slate-400', 'font-medium');
                }
            });

            // 2. Refresh Views
            updateDashboard(period);

            // Sync Team view global state
            if (typeof CURRENT_TEAM_PERIOD !== 'undefined') {
                CURRENT_TEAM_PERIOD = period;
                renderTeam();
            }
        };

        // Initialize current date display
        function updateClock() {
            const el = document.getElementById('current-date-display');
            if (el) {
                const now = new Date();
                const options = { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
                el.innerText = now.toLocaleDateString('es-ES', options).replace(',', '');
            }
        }
        setInterval(updateClock, 10000);
        updateClock();
    </script>

</body>

</html>